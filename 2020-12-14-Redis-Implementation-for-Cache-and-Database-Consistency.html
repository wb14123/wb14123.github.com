<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Redis Implementation for Cache and Database Consistency |  Bin Wang - My Personal Blog</title>
    <link rel="stylesheet" href="/static/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/asciinema-player.css" type="text/css" />

		<!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-52904500-1', 'auto');
      ga('send', 'pageview');
    </script>
		-->

		<!-- Matomo -->
		<script>
		  var _paq = window._paq = window._paq || [];
		  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//matomo.rssbrain.com/";
		    _paq.push(['setTrackerUrl', u+'matomo.php']);
		    _paq.push(['setSiteId', '2']);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<!-- End Matomo Code -->


  </head>

  <body>
    <div id="index_menu">
      
<!--
<div class="index-entry index-index"><a href="/">Home</a></div>
<div class="index-entry index-index"><a href="/snippets">Snippets</a></div>
<div class="index-entry index-index"><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></div>
<div class="index-entry index-index"><a href="/travel.html">Travel</a></div>
<div class="index-entry index-index"><a href="/search.html">Search</a></div>
<div class="index-entry index-index"><a href="/about.html">About</a></div>
<div class="index-entry index-index"><a href="/feed.xml" target="_blank">RSS</a></div>
-->




<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Computer Science)">Computer Science</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Algorithm)">Algorithm</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-05-28-compute.html">任意进制数的补码</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-07-11-quick-sort.html">快排杀手</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Data Processing)">Data Processing</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-04-29-Use-Docker-to-Submit-Spark-Jobs.html">Use Docker to Submit Spark Jobs</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-03-The-Proper-Way-to-Use-Spark-Checkpoint.html">The Proper Way to Use Spark Checkpoint</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-22-Use-Redis-Instead-of-Spark-Streaming-to-Count-Statistics.html">Use Redis Instead of Spark Streaming to Count Statistics</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Digital Life)">Digital Life</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-17-Beautiful-Math-with-MathJex.html">Beautiful Math with MathJex</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-26-Move-from-Twitter-to-Mastodon.html">Move from Twitter to Mastodon</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-02-What-Is-Wrong-abount-Recommendation-System.html">What Is Wrong about Recommendation System</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-15-Use-RSS-and-Kindle-to-Read-News.html">Use RSS and Kindle to Read News</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-23-Build-An-Instant_Messaging-System-without-Censorship-Choose-the-right-technology.html">Matrix: A Self Hosted Instant Messaging Solution with End to End Encryption</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-29-Build-An-Instant_Messaging-System-without-Censorship-Choose-An-Overview-of-Chinese-Internet-Censorship-Strategy.html">An Overview of China's Internet Censorship Strategy</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-09-08-Build-An-Instant-Messaging-System-without-Censorship-Deployment-Options.html">Deploy Matrix for Users in China</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Distributed System)">Distributed System</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-07-29-A-Review-on-Spanner-and-Open-Source-Implementations.html">Spanner and Open Source Implementations</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2019-11-04-Great-Resources-for-Learning-Database-and-Distributed-System.html">Great Resources for Learning Database and Distributed System</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-09-16-Aurora-Database.html">Aurora Database</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-10-06-Understand-Liveness-and-Fairness-in-TLA.html">Understand Liveness and Fairness in TLA+</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">Use TLA+ to Verify Cache Consistency</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-29-Keep-Data-Consistency-During-Database-Migration.html">Keep Data Consistency During Database Migration</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <div class="index-selected">Redis Implementation for Cache and Database Consistency</div>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Distributed System Infrastructure)">Distributed System Infrastructure</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-03-13-Infrastructure-Setup-for-High-Availability.html">Infrastructure Setup for High Availability</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html">Upgrade Kubernetes from 1.23 to 1.24</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-11-04-How-to-Cleanup-Ceph-Filesystem-for-Deleted-Kubernetes-Persistent-Volume.html">How to Cleanup Ceph Filesystem for Deleted Kubernetes Persistent Volume</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Machine Learning)">Machine Learning</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-01-17-Backpropagation-Algorithm.html">Backpropagation Algorithm</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-07-02-My-Recent-Work-About-Neural-Networks.html">My Recent Work About Neural Networks</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-08-Install-BLAS-Library-for-MXNet.html">Install BLAS Library for MXNet</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-05-14-How-to-Put-RNN-Layer-Into-Nueral-Network-Model.html">How to Put RNN Layers Into Neural Network Model</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-06-19-Build-A-Computer-for-Deep-Learning.html">Build A Computer for Deep Learning</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Operating System)">Operating System</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Android)">Android</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-02-11-The-Permission-of-Android-Becomes-A-Bigger-Problem-When-It-Comes-to-Wearable-Devices-and-TV.html">The Permission Management of Android Becomes A Bigger Problem When It Comes to Wearable Devices and TV</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-11-18-Root-And-Optimize-MiBox-3S.html">Root And Optimize MiBox 3S</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Linux)">Linux</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-07-12-port666.html">端口666：毁灭！</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-12-chroot.html">Chroot 简介</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-27-Compile-And-Install-Kernel.html">Compile And Install Kernel</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-05-Backup-My-Dotfiles.html">Backup My Dotfiles</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-28-Comparison-Between-Linux-Desktop-Environments.html">Comparison Between Linux Desktop Environments</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-21-How-Kernel's-Makefile-Specify-Output-Directory.html">How Kernel's Makefile Specify Output Directory</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-10-06-Xbmc-on-Raspberry-Pi-with-Archlinux.html">Xbmc on Raspberry Pi with Archlinux</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-03-08-In-Defence-of-Disabling-Swap.html">In Defence of Disabling Swap</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-01-Build-a-Linux-Virtual-Machine-for-Windows-Apps.html">Build a Linux Virtual Machine for Windows Apps</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-10-22-Full-Disk-Encryption-with-Yubikey.html">Linux Full Disk Encryption with Yubikey</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Tizen)">Tizen</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-02-29-tizen.html">Tizen，加油</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Windows)">Windows</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-11-28-Config-Development-Environment-on-Windows.html">Build a Unix Like Environment on Windows</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(iOS)">iOS</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-08-DNS-Resolving-Bug-in-iOS-14.html">DNS Resolving Bug in iOS 14</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-08-20-Apple-In-App-Purchase-Server-to-Server-Notification-Handling-with-Scala-Java.html">Handle Apple In-App-Purchase Server Notification with Scala/Java</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Programming Language)">Programming Language</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(C++)">C++</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-02-11-cplusplus.html">也谈C++</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Erlang)">Erlang</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-07-14-Build-Erlang-the-Rebar-Way.html">Build Erlang the Rebar Way</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-04-27-Why-I-Come-Back-to-Erlang.html">Why I Come Back to Erlang</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-05-16-Experiment-On-Combining-OOP-With-Erlang's-Actor-Model.html">Experiment On Combining OOP With Erlang's Actor Model</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Go)">Go</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-09-01-Notes-On-Go-Scheduler.html">Notes On Go Scheduler</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Javascript)">Javascript</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-01-28-HTML-+-CSS-+-JS-is-Good.html">HTML + CSS + JS is Good</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-02-14-What-is-Wrong-about-HTML.html">What is Wrong about HTML and CSS</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scala)">Scala</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-07-11-Config-sbt-to-Use-Both-Proxy-and-Self-Hosted-Repositories.html">Config sbt to Use Both Proxy and Self Hosted Repositories</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-08-27-Compare-Task-Processing-Approaches-in-Scala.html">Compare Task Processing Approaches in Scala</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-30-A-Boring-JVM-Memory-Profiling-Story.html">A Boring JVM Memory Profiling Story</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scheme)">Scheme</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-01-27-sicp30.html">SICP第三章总结（上）——可变量与环境</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-14-sicp35.html">SICP第三章总结（下）——流编程</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Type System)">Type System</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-08-02-RESTful-API-with-Type-System.html">RESTful API with Type System</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-11-Powerful-Type-System.html">Powerful Type System</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Security)">Security</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-09-02-The-Things-You-Need-to-Know-When-Using-Apache-Sentry.html">The Things You Need to Know When Using Apache Sentry</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-02-12-Setup-SSH-Authentication-with-YubiKey.html">Setup SSH Authentication with YubiKey</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Software Engineering)">Software Engineering</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-18-Call-Program-Like-A-Function.html">Call Program Like A Function</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-04-02-More-About-Program-In-Shell-And-Function.html">More About Program In Shell And Function</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-05-Server-Logic-of-Level-Based-Games.html">Server Logic of Level Based Games</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-12-08-Languages-Should-Have-Database-Built-In.html">Languages Should Have Database Built In</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-04-26-How-About-Translate-IMAP-And-SMTP-Into-HTTP-API.html">How About Translate IMAP And SMTP Into HTTP API?</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-10-18-How-to-Estimate-Max-TPS-from-TPM.html">How to Estimate Max TPS from TPM</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-02-21-Define-Infrastructure-as-Code.html">Define Infrastructure as Code</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-06-30-Why-Big-Companies-Need-to-Adopt-Open-Source.html">Why Big Companies Need to Adopt Open Source</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Storage)">Storage</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-10-Change-Root-File-System-from-Ext4-to-Xfs-on-Archlinux.html">Change Root File System from Ext4 to Xfs on Archlinux</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-01-28-Migrate-Arch-Linux-to-Zfs.html">Migrate Arch Linux to ZFS</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-09-19-Personal-ZFS-Offsite-Online-Backup-Solution.html">Personal ZFS Offsite Backup Solution</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Virtualization)">Virtualization</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-16-Create-A-Virtual-Machine-Network.html">Create A Virtual Machine Network</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-15-Fedora-Virt-manager-Guest-Connect-to-Host.html">Fedora Virt-manager Guest Connect to Host</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-11-03-Docker-Is-the-One-Scaffolding-to-Rule-Them-All.html">Docker Is the One Scaffolding to Rule Them All</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Essay)">Essay</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Chinese)">Chinese</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2008-12-21-people-mind.html">关于人的思想</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2008-12-22-people-mind2.html">关于人的思想（续）</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-05-31-china.html">览《中国文化要义》有感</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-06-28-bad-guys.html">未来人们怎样对待坏人：读《理想国》杂想</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-12-20-life-game.html">好玩的生命游戏</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-05-19-tiandiyouyou.html">念天地之悠悠</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-04-The-Life-of-Hermit-without-Materially.html">摒弃现代科技的隐士生活</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-07-24-%E8%AF%BB-%E9%82%93%E5%B0%8F%E5%B9%B3%E6%97%B6%E4%BB%A3-%E6%9C%89%E6%84%9F.html">读《邓小平时代》有感</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2019-08-15-%E7%94%B1-%E5%BA%9F%E9%9D%92-%E8%BF%99%E4%B8%AA%E7%A7%B0%E5%91%BC%E6%89%80%E6%83%B3%E5%88%B0%E7%9A%84.html">由“废青”这个称呼所想到的</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-09-%E7%9B%9B%E5%94%90%E8%AF%97%E4%BA%BA%E5%92%8C%E8%BF%9C%E6%B8%B8.html">盛唐诗人和远游</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(English)">English</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-08-30-Tired-of-Programming.html">Tired of Programming</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-21-The-Tragic-Talented-Programmer.html">The Tragic Talented Programmer</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Life)">Life</a>
      

      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-03-04-Life-in-Guangzhou.html">Life in Guangzhou</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-05-15-Recent-Works.html">Recent Works</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-07-20-The-Travel-to-Tokyo.html">东京之旅</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-01-02-The-Year-of-2017.html">My 2017 Year in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-01-26-My-2020-in-Review.html">My 2020 in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-04-04-%E5%8D%81%E4%B8%89%E5%B9%B4%E5%89%8D%E8%A2%AB%E9%9A%94%E7%A6%BB%E7%9A%84%E7%BB%8F%E5%8E%86.html">十三年前被隔离的经历</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-04-24-A-Travel-to-Montreal.html">A Travel to Montreal</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-01-26-My-2022-in-Review.html">My 2022 in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Projects)">Projects</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Bard)">Bard</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-12-16-The-Thoughts-Behind-Bard-Framework.html">The Thoughts Behind Bard Framework</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-12-28-Why-Use-Reflections-to-Write-A-Web-Framework.html">Why Use Reflections to Write A Web Framework</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Blog)">Blog</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-19-my-new-blog.html">My New Blog Website</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-20-Comment-And-Search-Are-Available.html">Comment And Search Are Available</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-10-Remove-Categories.html">Remove Categories</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-10-31-Add-Index-to-My-Blog.html">Add Index to My Blog</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-24-Jekyll-Plugin-to-Load-Asciicast-Locally.html">Jekyll Plugin to Load Asciinema Recordings Locally</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(RSS Brain)">RSS Brain</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-10-29-RSS-Brain-Yet-Another-RSS-Reader-With-More-Features.html">RSS Brain: Yet Another RSS Reader, With More Features</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-12-03-How-RSS-Brain-Shows-Related-Articles.html">How RSS Brain Shows Related Articles</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scala2grpc)">Scala2grpc</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-03-29-Comment-Everywhere.html">Comment Everywhere</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Psychology)">Psychology</a>
      

      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-10-xinlixue.html">耶鲁大学心理学导论</a>
        
      

      
        </div>
      
    </div>




<script>

  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)

  const indexMenu = document.getElementById('index_menu');
  const selected = document.getElementsByClassName("index-selected")[0];




  document.addEventListener("DOMContentLoaded", function(event) {
    var scrollpos = localStorage.getItem('menu-scroll-pos');
    console.log(scrollpos);
    if (scrollpos) indexMenu.scrollTo(0, scrollpos);

    if (selected !== undefined) {
      const topOffset = selected.getBoundingClientRect().top;
      if (topOffset < 0 || topOffset > vh) {
        indexMenu.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
      }
    }

  });

  window.onbeforeunload = function(e) {
    localStorage.setItem('menu-scroll-pos', indexMenu.scrollTop );
  };

</script>

    </div>

    <div id="main_content">
    <header id="page_header">
      <div id="menu-button">
          <a href="/index_page.html">&#9776;</a>
      </div>
      <nav id="page_nav">
        <ul>
             <li><a href="/">Home</a></li>
             <li><a href="/snippets">Snippets</a></li>
             <li><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></li>
             <li><a href="/travel.html">Travel</a></li>
             <li><a href="/search.html">Search</a></li>
             <li><a href="/about.html">About</a></li>
             <li><a href="/feed.xml">RSS</a></li>
       </ul>
      </nav>

    </header>



    <section id="page_content">
        <div id="content_table">
  <h3>Table of Contents</h3><ol class="toc"><li><a href="#algorithm-description">Algorithm Description</a></li><li><a href="#implementation">Implementation</a></li><li><a href="#testing">Testing</a></li></ol>
</div>

<div id="article_content" class="">
<article id="post">
  <header>
    <h1>Redis Implementation for Cache and Database Consistency</h1>
    
      <p class="description">Posted on 14 Dec 2020, tagged <code>Redis</code><code>database</code><code>consistency</code><code>Jepsen</code><code>distributed system</code></p>
    
  </header>

  <p><em>This article belongs to a series of articles about caching. The code in this article can be found at <a href="https://github.com/wb14123/redis_lease">my Github repo</a>.</em></p>

<ol>
  <li><em><a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">Use TLA+ to Verify Cache Consistency</a>.</em></li>
  <li><em>Redis Implementation for Cache and Database Consistency. (This one)</em></li>
</ol>

<p>In the <a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">last article</a>, we introduced an algorithm (described in paper <a href="https://pdos.csail.mit.edu/6.824/papers/memcache-fb.pdf">Scaling Memcache at Facebook</a>) that can do a better job to maintain the data consistency between cache and database. We also used TLA+ to model the algorithm and verified it. In this article, we are going to implement the algorithm in real world for Redis. The implementation is very simple and doesn’t need to change Redis itself. It’s implemented it by using Redis script. However, it’s much harder to verify the correctness. In order to do it, I used <a href="https://jepsen.io/">Jepsen</a> to test it. If you look at the language analysis for the Github repo, you can see most of them are tests. The Redis script implementation, which is written in Lua, is only 5.1% of the project.</p>

<h2 id="algorithm-description">Algorithm Description</h2>

<p>We’ve described the algorithm in the previous article and even write a TLA+ model for it. But just make it easier for the readers, I’ll briefly describe the algorithm here again. Basically, whenever the client get a value from cache, it will be assigned a unique ID (lease) for the key. When the client writes back a new value, it needs to provide the  key’s newest lease ID. And delete the key will also invalidate all its leases.</p>

<h2 id="implementation">Implementation</h2>

<p>The implementation uses <a href="https://redis.io/commands/eval">Redis script</a>, which is written in Lua. It can implement multiple operations and make them atomic. In theory, this can also be done by client, but Redis script provides a consistent implementation across different clients and makes it easier to use. The algorithm is easy, so the implementation is also straight forward. The implementations are under <a href="https://github.com/wb14123/redis_lease/tree/master/scripts">scripts directory of the repo</a>. These scripts also works for Redis cluster (but I didn’t use Jepsen to test it under cluster mode). Here is an example implementation for get:</p>

<div class="language-lua highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">local</span> <span style="color:#950">key</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">{</span><span style="color:#710">'</span></span>..KEYS[<span style="color:#00D">1</span>]..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">}</span><span style="color:#710">'</span></span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span><span style="color:#080;font-weight:bold">local</span> <span style="color:#950">token</span> = ARGV[<span style="color:#00D">1</span>]
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span><span style="color:#080;font-weight:bold">local</span> <span style="color:#950">value</span> = redis.call(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">get</span><span style="color:#710">'</span></span>, key)
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span><span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> value <span style="color:#080;font-weight:bold">then</span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>    redis.replicate_commands()
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>    <span style="color:#080;font-weight:bold">local</span> <span style="color:#950">lease_key</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">lease:</span><span style="color:#710">'</span></span>..key
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>    redis.call(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">set</span><span style="color:#710">'</span></span>, lease_key, token)
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>    <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(200,100%,50%,0.06)"><span style="color:#40A">{</span><span style="color:#069">false</span>, token<span style="color:#40A">}</span></span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span><span style="color:#080;font-weight:bold">else</span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>    <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(200,100%,50%,0.06)"><span style="color:#40A">{</span>value, <span style="color:#069">false</span><span style="color:#40A">}</span></span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>After load the script, you can use it like this:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>redis-cli evalsha &lt;script_sha1&gt; 1 &lt;key&gt; &lt;uniq_id&gt;
</pre></div>
</div>
</div>

<p>It will return <code>value, nil</code> if there is value for the key, or <code>nil, lease</code> if there is no value.</p>

<p>One optimization here is, if we have value for the key, we will not store the lease. That’s because in our use case, if we can get the value, we will not get it from database and write back to the cache. This avoids a lot of memory overhead.</p>

<p>Another important decision I made is, when get the value, the client needs to provide a unique ID instead of let Redis provide one. This is because I cannot find a good way to generate unique ID in Redis cluster. In a single instance, it’s easy: just use a key and inc the value each time. You can still generate unique IDs for different keys on a cluster, but it adds a lot of memory overhead. So I decided to let clients provide it. Luckily, it’s not hard, basically every language has UUID implementation and that’s good enough.</p>

<h2 id="testing">Testing</h2>

<p>It’s easy to implement something, but very hard to make sure it’s correct. We can use TLA+ to model the algorithm and explore the state space, or use mathematical method to proof the correctness in theory. But once we implement the algorithm, it’s something different. We cannot make sure it’s exactly the same as what we’ve proofed. That’s why I find using Coq to implement, proof and generate real code is fantastic. But in this case, it’s not implemented in Coq, so we must find some other way to test it. By testing, we still cannot make sure it’s 100% correct, we can just explore as many situations as we can and make sure the system doesn’t behaves in a way we don’t expect.</p>

<p>The tool we use here is <a href="https://jepsen.io/">Jepsen</a>. It provides lots of tools to make it easy to test distributed systems. It can generate many concurrent requests, import different kinds of failures (host down, network partition, clock drift, and so on) to the system, record all the requests and responses, and check the history at the end.</p>

<p>Here is the test case I write: for each client, generate random read and write operations. For read operation, read from cache first, if the value is not found, read from database and write back to the data. For write operations, write to the database and delete the key from cache. Then after all the read and write operations, check whether the data in cache and database are the same. The test case is very simple, it implemented the way we would use the cache.</p>

<p>By providing different arguments to the test command, you can run the test case with raw Redis get/set/del operations, or use get/set/del operation implemented by the scripts. You can also import cache failure during the test.</p>

<p>If we run the test with raw Redis operations, we can find the test is failed. In the last article, we discussed that using plain get/set/del cache operations cannot guarantee cache consistency, so this is expected. If we run the test with our scripts, we can find the test passed. If we run the test with cache system failure, we can see the test failed, which is also expected from last article. The inconsistent because of cache failure can be resolved by clean up cache data after restart. But if the client is failed, it will have the same problem (I didn’t write the test case for this because it’s hard to test client failure in Jepsen), but it’s not a very good idea to cleanup cache in this case. Because client fails all the time, cleanup cache will make operations slow. The best way might be to setup an expire time so the data can be consistent after the key is expired.</p>

<p>Even though all the test result is expected, it doesn’t make sure the implementation is correct, since there are still many situation I didn’t test, like Redis cluster, network partition, database failure and so on. So welcome to add new test cases and break the system!</p>

</article>

<footer id="post_footer">
  <table><tr>
    
      <td id="prev"><a href="/2020-11-29-Keep-Data-Consistency-During-Database-Migration.html">Prev: Keep Data Consistency During Database Migration</a></td>
    
    
      <td id="next"><a href="/2021-01-26-My-2020-in-Review.html" id="next">Next: My 2020 in Review</a></td>
    
  </tr></table>
</footer>

<section id="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'crazy-hot-ice'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



<!-- MathJax -->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

</div>

    </section>

    <footer id="page_footer">
      Copyright @ 2008 - 2023 Bin Wang
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
    </footer>
    </div>
  </body>
</html>
