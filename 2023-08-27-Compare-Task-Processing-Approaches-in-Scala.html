<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Compare Task Processing Approaches in Scala |  Bin Wang - My Personal Blog</title>
    <link rel="stylesheet" href="/static/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/asciinema-player.css" type="text/css" />

		<!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-52904500-1', 'auto');
      ga('send', 'pageview');
    </script>
		-->

		<!-- Matomo -->
		<script>
		  var _paq = window._paq = window._paq || [];
		  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//matomo.rssbrain.com/";
		    _paq.push(['setTrackerUrl', u+'matomo.php']);
		    _paq.push(['setSiteId', '2']);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<!-- End Matomo Code -->


  </head>

  <body>
    
    <div id="index_menu">
      
<!--
<div class="index-entry index-index"><a href="/">Home</a></div>
<div class="index-entry index-index"><a href="/snippets">Snippets</a></div>
<div class="index-entry index-index"><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></div>
<div class="index-entry index-index"><a href="/travel.html">Travel</a></div>
<div class="index-entry index-index"><a href="/search.html">Search</a></div>
<div class="index-entry index-index"><a href="/about.html">About</a></div>
<div class="index-entry index-index"><a href="/feed.xml" target="_blank">RSS</a></div>
-->




  

    <div class="index-entry index-index">
      
      Computer Science
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Algorithm
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-05-28-compute.html">任意进制数的补码 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-07-11-quick-sort.html">快排杀手 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-10-18-How-to-Estimate-Max-TPS-from-TPM.html">How to Estimate Max TPS from TPM <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Data Processing
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-04-29-Use-Docker-to-Submit-Spark-Jobs.html">Use Docker to Submit Spark Jobs <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-03-The-Proper-Way-to-Use-Spark-Checkpoint.html">The Proper Way to Use Spark Checkpoint <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-22-Use-Redis-Instead-of-Spark-Streaming-to-Count-Statistics.html">Use Redis Instead of Spark Streaming to Count Statistics <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Digital Life
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-26-Move-from-Twitter-to-Mastodon.html">Move from Twitter to Mastodon <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-02-What-Is-Wrong-abount-Recommendation-System.html">What Is Wrong about Recommendation System <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-15-Use-RSS-and-Kindle-to-Read-News.html">Use RSS and Kindle to Read News <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-23-Build-An-Instant_Messaging-System-without-Censorship-Choose-the-right-technology.html">Matrix: A Self Hosted Instant Messaging Solution with End to End Encryption <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-29-Build-An-Instant_Messaging-System-without-Censorship-Choose-An-Overview-of-Chinese-Internet-Censorship-Strategy.html">An Overview of China's Internet Censorship Strategy <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-09-08-Build-An-Instant-Messaging-System-without-Censorship-Deployment-Options.html">Deploy Matrix for Users in China <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Distributed System
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-07-29-A-Review-on-Spanner-and-Open-Source-Implementations.html">Spanner and Open Source Implementations <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2019-11-04-Great-Resources-for-Learning-Database-and-Distributed-System.html">Great Resources for Learning Database and Distributed System <span class="publish-year">(2019)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-09-16-Aurora-Database.html">Aurora Database <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-10-06-Understand-Liveness-and-Fairness-in-TLA.html">Understand Liveness and Fairness in TLA+ <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">Use TLA+ to Verify Cache Consistency <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-29-Keep-Data-Consistency-During-Database-Migration.html">Keep Data Consistency During Database Migration <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-12-14-Redis-Implementation-for-Cache-and-Database-Consistency.html">Redis Implementation for Cache and Database Consistency <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Distributed System Infrastructure
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-03-13-Infrastructure-Setup-for-High-Availability.html">Infrastructure Setup for High Availability <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html">Upgrade Kubernetes from 1.23 to 1.24 <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-04-How-to-Cleanup-Ceph-Filesystem-for-Deleted-Kubernetes-Persistent-Volume.html">How to Cleanup Ceph Filesystem for Deleted Kubernetes Persistent Volume <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-28-Introduce-K3s-CephFS-and-MetalLB-to-My-High-Avaliable-Cluster.html">Introduce K3s, CephFS and MetalLB to My High Avaliable Cluster <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Machine Learning
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-01-17-Backpropagation-Algorithm.html">Backpropagation Algorithm <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-07-02-My-Recent-Work-About-Neural-Networks.html">My Recent Work About Neural Networks <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-08-Install-BLAS-Library-for-MXNet.html">Install BLAS Library for MXNet <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-05-14-How-to-Put-RNN-Layer-Into-Nueral-Network-Model.html">How to Put RNN Layers Into Neural Network Model <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-06-19-Build-A-Computer-for-Deep-Learning.html">Build A Computer for Deep Learning <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Operating System
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Android
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-02-11-The-Permission-of-Android-Becomes-A-Bigger-Problem-When-It-Comes-to-Wearable-Devices-and-TV.html">The Permission Management of Android Becomes A Bigger Problem When It Comes to Wearable Devices and TV <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-11-18-Root-And-Optimize-MiBox-3S.html">Root And Optimize MiBox 3S <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Linux
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-07-12-port666.html">端口666：毁灭！ <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-12-chroot.html">Chroot 简介 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-27-Compile-And-Install-Kernel.html">Compile And Install Kernel <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-05-Backup-My-Dotfiles.html">Backup My Dotfiles <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-28-Comparison-Between-Linux-Desktop-Environments.html">Comparison Between Linux Desktop Environments <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-21-How-Kernel's-Makefile-Specify-Output-Directory.html">How Kernel's Makefile Specify Output Directory <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-10-06-Xbmc-on-Raspberry-Pi-with-Archlinux.html">Xbmc on Raspberry Pi with Archlinux <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-02-12-Setup-SSH-Authentication-with-YubiKey.html">Setup SSH Authentication with YubiKey <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-03-08-In-Defence-of-Disabling-Swap.html">In Defence of Disabling Swap <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-01-Build-a-Linux-Virtual-Machine-for-Windows-Apps.html">Build a Linux Virtual Machine for Windows Apps <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-10-22-Full-Disk-Encryption-with-Yubikey.html">Linux Full Disk Encryption with Yubikey <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Tizen
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-02-29-tizen.html">Tizen，加油 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Windows
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-11-28-Config-Development-Environment-on-Windows.html">Build a Unix Like Environment on Windows <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      iOS
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-08-DNS-Resolving-Bug-in-iOS-14.html">DNS Resolving Bug in iOS 14 <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-08-20-Apple-In-App-Purchase-Server-to-Server-Notification-Handling-with-Scala-Java.html">Handle Apple In-App-Purchase Server Notification with Scala/Java <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Programming Language
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      C++
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-02-11-cplusplus.html">也谈C++ <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Erlang
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-07-14-Build-Erlang-the-Rebar-Way.html">Build Erlang the Rebar Way <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-04-27-Why-I-Come-Back-to-Erlang.html">Why I Come Back to Erlang <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-05-16-Experiment-On-Combining-OOP-With-Erlang's-Actor-Model.html">Experiment On Combining OOP With Erlang's Actor Model <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Go
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-09-01-Notes-On-Go-Scheduler.html">Notes On Go Scheduler <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Javascript
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-17-Beautiful-Math-with-MathJex.html">Beautiful Math with MathJex <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-01-28-HTML-+-CSS-+-JS-is-Good.html">HTML + CSS + JS is Good <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-02-14-What-is-Wrong-about-HTML.html">What is Wrong about HTML and CSS <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-03-26-Prevent-HTMX-Lazy-Loaded-Content-From-Reload.html">Prevent htmx Lazy Loaded Content From Reloading <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scala
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-07-11-Config-sbt-to-Use-Both-Proxy-and-Self-Hosted-Repositories.html">Config sbt to Use Both Proxy and Self Hosted Repositories <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <div class="index-selected">Compare Task Processing Approaches in Scala <span class="publish-year">(2023)</span></div>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-30-A-Boring-JVM-Memory-Profiling-Story.html">A Boring JVM Memory Profiling Story <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-12-29-Scala-Macro-Tutorial.html">Scala 2 Macro Tutorial <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scheme
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-01-27-sicp30.html">SICP第三章总结（上）——可变量与环境 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-14-sicp35.html">SICP第三章总结（下）——流编程 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Type System
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-08-02-RESTful-API-with-Type-System.html">RESTful API with Type System <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-11-Powerful-Type-System.html">Powerful Type System <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Software Engineering
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-18-Call-Program-Like-A-Function.html">Call Program Like A Function <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-04-02-More-About-Program-In-Shell-And-Function.html">More About Program In Shell And Function <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-05-Server-Logic-of-Level-Based-Games.html">Server Logic of Level Based Games <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-12-08-Languages-Should-Have-Database-Built-In.html">Languages Should Have Database Built In <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-04-26-How-About-Translate-IMAP-And-SMTP-Into-HTTP-API.html">How About Translate IMAP And SMTP Into HTTP API? <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-09-02-The-Things-You-Need-to-Know-When-Using-Apache-Sentry.html">The Things You Need to Know When Using Apache Sentry <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-02-21-Define-Infrastructure-as-Code.html">Define Infrastructure as Code <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-06-30-Why-Big-Companies-Need-to-Adopt-Open-Source.html">Why Big Companies Need to Adopt Open Source <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Storage
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-10-Change-Root-File-System-from-Ext4-to-Xfs-on-Archlinux.html">Change Root File System from Ext4 to Xfs on Archlinux <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-01-28-Migrate-Arch-Linux-to-Zfs.html">Migrate Arch Linux to ZFS <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-09-19-Personal-ZFS-Offsite-Online-Backup-Solution.html">Personal ZFS Offsite Backup Solution <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-12-14-ZFS-Profiling-on-Arch-Linux.html">ZFS Profiling on Arch Linux <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Virtualization
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-16-Create-A-Virtual-Machine-Network.html">Create A Virtual Machine Network <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-15-Fedora-Virt-manager-Guest-Connect-to-Host.html">Fedora Virt-manager Guest Connect to Host <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-11-03-Docker-Is-the-One-Scaffolding-to-Rule-Them-All.html">Docker Is the One Scaffolding to Rule Them All <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  

    <div class="index-entry index-index">
      
      Life
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-03-04-Life-in-Guangzhou.html">Life in Guangzhou <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-05-15-Recent-Works.html">Recent Works <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-07-20-The-Travel-to-Tokyo.html">东京之旅 <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-01-02-The-Year-of-2017.html">My 2017 Year in Review <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-01-26-My-2020-in-Review.html">My 2020 in Review <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-04-04-%E5%8D%81%E4%B8%89%E5%B9%B4%E5%89%8D%E8%A2%AB%E9%9A%94%E7%A6%BB%E7%9A%84%E7%BB%8F%E5%8E%86.html">十三年前被隔离的经历 <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-04-24-A-Travel-to-Montreal.html">A Travel to Montreal <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-01-26-My-2022-in-Review.html">My 2022 in Review <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-03-19-Travel-Back-to-China.html">Travel Back to China <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Projects
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Bard
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-12-16-The-Thoughts-Behind-Bard-Framework.html">The Thoughts Behind Bard Framework <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-12-28-Why-Use-Reflections-to-Write-A-Web-Framework.html">Why Use Reflections to Write A Web Framework <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Blog
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-19-my-new-blog.html">My New Blog Website <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-20-Comment-And-Search-Are-Available.html">Comment And Search Are Available <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-10-Remove-Categories.html">Remove Categories <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-10-31-Add-Index-to-My-Blog.html">Add Index to My Blog <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-24-Jekyll-Plugin-to-Load-Asciicast-Locally.html">Jekyll Plugin to Load Asciinema Recordings Locally <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-10-Index-Sidebar-on-My-Blog.html">Add Index Sidebar to My Blog <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      RSS Brain
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-10-29-RSS-Brain-Yet-Another-RSS-Reader-With-More-Features.html">RSS Brain: Yet Another RSS Reader, With More Features <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-12-03-How-RSS-Brain-Shows-Related-Articles.html">How RSS Brain Shows Related Articles <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-14-Update-On-RSS-Brain-to-Find-Related-Articles-with-Machine-Learning.html">Update on RSS Brain to Find Related Articles with Machine Learning <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scala2grpc
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3 <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-03-29-Comment-Everywhere.html">Comment Everywhere <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Psychology
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-10-xinlixue.html">耶鲁大学心理学导论 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Thoughts
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Chinese
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2008-12-21-people-mind.html">关于人的思想 <span class="publish-year">(2008)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2008-12-22-people-mind2.html">关于人的思想（续） <span class="publish-year">(2008)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-05-31-china.html">览《中国文化要义》有感 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-06-28-bad-guys.html">未来人们怎样对待坏人：读《理想国》杂想 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-12-20-life-game.html">好玩的生命游戏 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-05-19-tiandiyouyou.html">念天地之悠悠 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-04-The-Life-of-Hermit-without-Materially.html">摒弃现代科技的隐士生活 <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-07-24-%E8%AF%BB-%E9%82%93%E5%B0%8F%E5%B9%B3%E6%97%B6%E4%BB%A3-%E6%9C%89%E6%84%9F.html">读《邓小平时代》有感 <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2019-08-15-%E7%94%B1-%E5%BA%9F%E9%9D%92-%E8%BF%99%E4%B8%AA%E7%A7%B0%E5%91%BC%E6%89%80%E6%83%B3%E5%88%B0%E7%9A%84.html">由“废青”这个称呼所想到的 <span class="publish-year">(2019)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-09-%E7%9B%9B%E5%94%90%E8%AF%97%E4%BA%BA%E5%92%8C%E8%BF%9C%E6%B8%B8.html">盛唐诗人和远游 <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      English
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-08-30-Tired-of-Programming.html">Tired of Programming <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-21-The-Tragic-Talented-Programmer.html">The Tragic Talented Programmer <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  





<script>

  const isIndexPage = false;

  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)
  const indexMenu = document.getElementById('index_menu') || document.getElementById('index_menu_page');


  document.addEventListener("DOMContentLoaded", function(event) {

    if (isIndexPage) {
      var targetHref = new URL(document.referrer).pathname;
      console.log(targetHref);

      document.querySelectorAll('a').forEach(function(anchorTag) {
        // Check if the href attribute matches the targetHref
        if (anchorTag.getAttribute('href') === targetHref) {
           var newDiv = document.createElement('div');
           newDiv.classList.add('index-selected');
           // Copy the content of the <a> tag to the new <div>
           newDiv.innerHTML = anchorTag.innerHTML;
           // Replace the <a> tag with the new <div> element
           anchorTag.parentNode.replaceChild(newDiv, anchorTag);
        }
      });

    }

    var selected = document.getElementsByClassName("index-selected")[0];

    if (!isIndexPage) {
      var scrollpos = localStorage.getItem('menu-scroll-pos');
      console.log(scrollpos);
      if (scrollpos) indexMenu.scrollTo(0, scrollpos);
    }

    if (selected !== undefined) {
      const topOffset = selected.getBoundingClientRect().top;
      if (topOffset < 0 || topOffset > vh) {
        if (isIndexPage) {
          window.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
        } else {
          indexMenu.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
        }
      }
    }

  });

  window.onbeforeunload = function(e) {
    if (!isIndexPage) {
      localStorage.setItem('menu-scroll-pos', indexMenu.scrollTop );
    }
  };

</script>

    </div>
    

    <div id="main_content">
    <header id="page_header">
      <div id="menu-button">
          <a href="/index_page.html">&#9776;</a>
      </div>
      <nav id="page_nav">
        <ul>
             <li><a href="/">Home</a></li>
             <li><a href="/snippets">Snippets</a></li>
             <li><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></li>
             <li><a href="/travel.html">Travel</a></li>
             <li><a href="/search.html">Search</a></li>
             <li><a href="/about.html">About</a></li>
             <li><a href="/feed.xml">RSS</a></li>
       </ul>
      </nav>

    </header>



    <section id="page_content">
        <div id="content_table">
  <h3>Table of Contents</h3><ol class="toc"><li><a href="#task-processing">Task Processing</a></li><li><a href="#introducing-cats-effect-and-fs2">Introducing Cats Effect and FS2</a></li><li><a href="#testing-setup">Testing Setup</a></li><li><a href="#approach-1-batch-consuming">Approach 1: Batch Consuming</a></li><li><a href="#approach-2-use-blocking-queue-to-buffer-tasks">Approach 2: Use Blocking Queue to Buffer Tasks</a></li><li><a href="#approach-3-use-cats-effect-friendly-queue">Approach 3: Use Cats Effect Friendly Queue</a></li><li><a href="#approach-4-use-fs2-stream-directly">Approach 4: Use FS2 Stream Directly</a></li><li><a href="#approach-5-make-producers-run-in-parallel">Approach 5: Make Producers Run in Parallel</a></li><li><a href="#more">More</a></li><li><a href="#test-results">Test Results</a></li></ol>
</div>

<div id="article_content" class="">
<article id="post">
  <header>
    <h1>Compare Task Processing Approaches in Scala</h1>
    
      <p class="description">Posted on 27 Aug 2023, tagged <code>Scala</code><code>concurrent</code><code>cats</code><code>cats-effect</code><code>fs2</code><code>queue</code><code>stream</code></p>
    
  </header>

  <p><em>All the source code mentioned in this blog can be found in <a href="https://github.com/wb14123/scala-stream-demo">my Github repo</a>.</em></p>

<h2 id="task-processing">Task Processing</h2>

<p>There is a common problem in computer science and I’ve met it again recently: how to generate and process tasks efficiently? Use my recent project <a href="https://www.rssbrain.com">RSS Brain</a> as an example: it needs to find the RSS feeds that haven’t been updated for a while in a database, and fetch the newest data from network.</p>

<p>The easiest way to do it is producing and consuming the tasks in a sequence, for example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">feeds</span> <span class="k">=</span> <span class="nf">getPendingFeeds</span><span class="o">()</span> <span class="c1">// produce the tasks</span>
<span class="nv">feeds</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="n">fetchFromNetwork</span><span class="o">)</span> <span class="c1">// consume the dtasks</span>
</code></pre></div></div>

<p>However, it is unnecessarily slow. Network request doesn’t take lots of CPU and we can send multiple requests at the same time. Even if <code class="language-plaintext highlighter-rouge">fetchFromNetwork</code> is a CPU bound task, it can be parallelized if there are multiple CPU cores on a machine.</p>

<p>In this article, we will explore ways to do it more efficiently with <a href="https://typelevel.org/cats-effect/">Cats Effect</a> and <a href="https://fs2.io">FS2</a> in a functional programming fashion.</p>

<p><em>You may wonder why not using AKKA stream? Other than it’s using a different programming paradigm (not functional programming), it’s also because <a href="https://www.lightbend.com/blog/why-we-are-changing-the-license-for-akka">AKKA has changed its license</a> with a ridiculous price.</em></p>

<h2 id="introducing-cats-effect-and-fs2">Introducing Cats Effect and FS2</h2>

<p>To make <code class="language-plaintext highlighter-rouge">processTask</code> async, there is <code class="language-plaintext highlighter-rouge">Future</code> in Scala’s standard library. However, the side effect will happen when you create a <code class="language-plaintext highlighter-rouge">Future</code> instance. For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">processTask</span><span class="o">(</span><span class="n">task</span><span class="k">:</span> <span class="kt">Task</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">task</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">runTask1</span> <span class="k">=</span> <span class="nf">processTask</span><span class="o">(</span><span class="n">task1</span><span class="o">)</span> <span class="c1">// this will start the async task</span>
</code></pre></div></div>

<p>I assume the readers have a basic understanding of functional programming, so I’ll not explain why we want to avoid side effects. While Scala is not a pure functional language, a popular Scala library <a href="https://typelevel.org/cats-effect/">Cats Effect</a> provides convenient ways to wrap side effects. With the help of its <code class="language-plaintext highlighter-rouge">IO</code> type, we can define an async task like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">processTask</span><span class="o">(</span><span class="n">task</span><span class="k">:</span> <span class="kt">Task</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">task</span><span class="o">))</span>

<span class="c1">// this will not start the task, so no side effect</span>
<span class="k">val</span> <span class="nv">runTask1</span> <span class="k">=</span> <span class="nf">processTask</span><span class="o">(</span><span class="n">task1</span><span class="o">)</span>

<span class="c1">// out of pure functional world and starts the side effect</span>
<span class="nv">runTask1</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
</code></pre></div></div>

<p>Then there is <a href="https://fs2.io">fs2</a> that is a stream library that can be used with cats effect. It will be very handy when resolving our problem as we can see later.</p>

<p><em>Cat Effect has some big changes in version 3.x. In this article, we are using version 2.x. But I may upgrade the version in the future.</em></p>

<h2 id="testing-setup">Testing Setup</h2>

<p>In order to test which approach is the best under different scenarios, we need some basic setup. In <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/TestRunner.scala">TestRunner.scala</a>, I defined some functions to generate tasks. Here are their signatures:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Produce a sequence of tasks represented by `Int`</span>
<span class="k">def</span> <span class="nf">produce</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span>

<span class="c1">// Process a task</span>
<span class="k">def</span> <span class="nf">consume</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>

<span class="c1">// Produce tasks as a stream</span>
<span class="k">def</span> <span class="nf">def</span> <span class="nf">produceStream</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span><span class="o">]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">produce</code> simply produces tasks as <code class="language-plaintext highlighter-rouge">int</code>, and <code class="language-plaintext highlighter-rouge">consume</code> just print characters. In each of the functions, I use <code class="language-plaintext highlighter-rouge">IO.sleep</code> to create some delay to simulate the real world non-blocking IO. They also print characters <code class="language-plaintext highlighter-rouge">P</code> (produce) or <code class="language-plaintext highlighter-rouge">C</code> (consume) (based on the width of terminal, some of the <code class="language-plaintext highlighter-rouge">C</code> outputs may be skipped to fit the width) when being invoked, so that we can have an intuitive view of how quick tasks are produced and consumed.</p>

<p>Then there is <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/TestConfig.scala">TestConfig.scala</a> for configuring the test:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">TestConfig</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">testName</span><span class="k">:</span> <span class="kt">String</span>
  <span class="k">val</span> <span class="nv">produceDelay</span><span class="k">:</span> <span class="kt">FiniteDuration</span>
  <span class="k">val</span> <span class="nv">minConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span>
  <span class="k">val</span> <span class="nv">maxConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span>
  <span class="k">val</span> <span class="nv">batchSize</span> <span class="k">=</span> <span class="mi">100</span>  <span class="c1">// consume batch size</span>
  <span class="k">val</span> <span class="nv">totalSize</span> <span class="k">=</span> <span class="mi">1000</span> <span class="c1">// how many tasks to generate</span>
<span class="o">}</span>
</code></pre></div></div>

<p>By setting up produce and consume delays, we can test scenarios when producer is slower, consumer is slower, or producer and consumer speed is almost the same. Here are the configurations we are going to use in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/Main.scala">Main.scala</a></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">configs</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="k">new</span> <span class="nc">TestConfig</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">testName</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"slow-producer"</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">produceDelay</span><span class="k">:</span> <span class="kt">FiniteDuration</span> <span class="o">=</span> <span class="mf">1000.</span><span class="n">millis</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">minConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">maxConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="o">},</span>
  <span class="k">new</span> <span class="nc">TestConfig</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">testName</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"balanced"</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">produceDelay</span><span class="k">:</span> <span class="kt">FiniteDuration</span> <span class="o">=</span> <span class="mf">1005.</span><span class="n">millis</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">minConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">maxConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">2000</span>
  <span class="o">},</span>
  <span class="k">new</span> <span class="nc">TestConfig</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">testName</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"slow-consumer"</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">produceDelay</span><span class="k">:</span> <span class="kt">FiniteDuration</span> <span class="o">=</span> <span class="mf">10.</span><span class="n">millis</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">minConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">maxConsumeDelayMillis</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">1000</span>
  <span class="o">}</span>
<span class="o">)</span>
</code></pre></div></div>

<h2 id="approach-1-batch-consuming">Approach 1: Batch Consuming</h2>

<p>The first approach is to make the consuming side parallel. We can consume a batch of tasks concurrently, like in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/BatchIOApp.scala">BatchIOApp.scala</a>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">loop</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nf">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="nv">config</span><span class="o">.</span><span class="py">totalSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="nv">IO</span><span class="o">.</span><span class="py">unit</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nf">produce</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">start</span> <span class="o">+</span> <span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)</span>
      <span class="o">.</span><span class="py">flatMap</span><span class="o">{</span><span class="nv">_</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">consume</span><span class="o">).</span><span class="py">parSequence</span><span class="o">}</span>
      <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nf">loop</span><span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>However, this only makes a batch of tasks run in parallel. It needs to wait the whole batch to be finished in order to start next batch. This is very obvious when we run this approach and see the output of characters (download <a href="https://github.com/wb14123/scala-stream-demo">Github repo</a> and run <code class="language-plaintext highlighter-rouge">sbt "run -n BatchIOApp"</code>). See how it paused after each batch even when consumer is slower than producer:</p>

<div id="cast-tmpg4x5_bn7-ascii"></div>
<script src="/static/js/asciinema-player.min.js"></script>
<script>AsciinemaPlayer.create('/static/asciicasts/tmpg4x5_bn7-ascii.cast', document.getElementById('cast-tmpg4x5_bn7-ascii'), {rows: 10, autoPlay: true});</script>

<h2 id="approach-2-use-blocking-queue-to-buffer-tasks">Approach 2: Use Blocking Queue to Buffer Tasks</h2>

<p>We need a way to let producers not waiting for consumers, and also let consumers not wait for a batch to finish in order to start next batch. A very common solution is to use a queue between producers and consumers. Producers put tasks into the queue, and consumers get tasks for the queue. If the queue is thread safe, then both producers and consumers can work on their own without care about each other. In order to not let producer put unlimited tasks into the queue to blowup the memory, we need the queue to have a capacity. When the queue is full, the producer should be blocked. And when the queue is empty, the consumers should be blocked as well.</p>

<p>In Java, <code class="language-plaintext highlighter-rouge">BlockingQueue</code> meets our requirements. We can use an implementation <code class="language-plaintext highlighter-rouge">LinkedBlockingQueue</code>. However, <code class="language-plaintext highlighter-rouge">BlockingQueue</code> will block the whole thread instead of a single <code class="language-plaintext highlighter-rouge">IO</code>. Let’s not worry about it for now and see how to use a queue to implement producing and consuming in parallel. The implementation is in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/BlockingQueueApp.scala">BlockingQueueApp.scala</a>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">val</span> <span class="nv">queue</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>

<span class="k">override</span> <span class="k">def</span> <span class="nf">work</span><span class="o">()</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="o">(</span><span class="nf">produceStream</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="o">++</span> <span class="nv">fs2</span><span class="o">.</span><span class="py">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="nc">None</span><span class="o">))</span>
			<span class="o">.</span><span class="py">evalMap</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="nv">queue</span><span class="o">.</span><span class="py">put</span><span class="o">(</span><span class="n">x</span><span class="o">))).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
    <span class="nf">dequeueStream</span><span class="o">().</span><span class="py">unNoneTerminate</span><span class="o">.</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)(</span><span class="n">consume</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
  <span class="o">).</span><span class="py">parSequence</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="o">())</span>
<span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="nf">dequeueStream</span><span class="o">()</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nv">fs2</span><span class="o">.</span><span class="py">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nc">IO</span><span class="o">(</span><span class="nv">queue</span><span class="o">.</span><span class="py">take</span><span class="o">()))</span> <span class="o">++</span> <span class="nf">dequeueStream</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here we have two IOs run in parallel with <code class="language-plaintext highlighter-rouge">parSequence</code>: the first one creates a task stream by <code class="language-plaintext highlighter-rouge">produceStream</code>, and append <code class="language-plaintext highlighter-rouge">None</code> at the end so that the consumer knows it should end processing. Another stream <code class="language-plaintext highlighter-rouge">dequeueStream</code> gets the tasks from the queue then consumes it in parallel with <code class="language-plaintext highlighter-rouge">parEvalmap(config.batchSize)(consume)</code>.</p>

<p>When run it with <code class="language-plaintext highlighter-rouge">sbt "run -n BlockingQueueApp"</code>, we can see it’s much faster when the consumer is faster or has the same speed as the producer. Especially when the consumer is slow, it prints multiple <code class="language-plaintext highlighter-rouge">P</code> at first, which means the producers doesn’t wait all the consumers to finish in order to produce tasks.</p>

<div id="cast-tmp6dx2heu_-ascii"></div>
<script src="/static/js/asciinema-player.min.js"></script>
<script>AsciinemaPlayer.create('/static/asciicasts/tmp6dx2heu_-ascii.cast', document.getElementById('cast-tmp6dx2heu_-ascii'), {rows: 10, autoPlay: true});</script>

<p>Back to the blocking the whole thread problem: it doesn’t seem to be a problem in this case, right? It’s only because we are lucky! In this setup, we are using two fixed threads as the thread pool of running IO in <code class="language-plaintext highlighter-rouge">Main.scala</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">val</span> <span class="nv">executor</span> <span class="k">=</span> <span class="nv">Executors</span><span class="o">.</span><span class="py">newFixedThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Runnable</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">back</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
  <span class="nv">back</span><span class="o">.</span><span class="py">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
  <span class="n">back</span>
<span class="o">})</span>

<span class="k">implicit</span> <span class="k">override</span> <span class="k">def</span> <span class="nf">executionContext</span><span class="k">:</span> <span class="kt">ExecutionContext</span> <span class="o">=</span> <span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">fromExecutor</span><span class="o">(</span><span class="n">executor</span><span class="o">)</span>

<span class="k">implicit</span> <span class="k">override</span> <span class="k">def</span> <span class="nf">timer</span><span class="k">:</span> <span class="kt">Timer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="n">executionContext</span><span class="o">)</span>

<span class="k">implicit</span> <span class="k">override</span> <span class="k">def</span> <span class="nf">contextShift</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="n">executionContext</span><span class="o">)</span>
</code></pre></div></div>

<p>If 2 consumers with empty queue happens to be scheduled on these 2 threads separately, it will block. If we change our <code class="language-plaintext highlighter-rouge">BlockingQueueApp</code> to the code in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/RealBlockingQueueApp.scala">RealBlockingQueueApp</a>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">def</span> <span class="nf">work</span><span class="o">()</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="nf">dequeueStream</span><span class="o">().</span><span class="py">unNoneTerminate</span><span class="o">.</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)(</span><span class="n">consume</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
    <span class="nf">dequeueStream</span><span class="o">().</span><span class="py">unNoneTerminate</span><span class="o">.</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)(</span><span class="n">consume</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
    <span class="o">(</span><span class="nf">produceStream</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="o">++</span> <span class="nv">fs2</span><span class="o">.</span><span class="py">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="nc">None</span><span class="o">)).</span><span class="py">evalMap</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="nv">queue</span><span class="o">.</span><span class="py">put</span><span class="o">(</span><span class="n">x</span><span class="o">))).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
  <span class="o">).</span><span class="py">parSequence</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="o">())</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here we started two dequeue stream at first. Now the whole program will block when run it with <code class="language-plaintext highlighter-rouge">sbt "run -b"</code> .</p>

<p>The lesson learned here is that there is a big risk if any operation blocks the whole thread in cats effect. Even it doesn’t block the whole program, it may make a whole thread unavailable.</p>

<p>Actually in <a href="https://typelevel.org/cats-effect/docs/thread-model">Cats Effect’s thread model</a>, there is another thread pool for blocking tasks if we mark it explicitly. In <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/AsyncConsole.scala">AsyncConsole.scala</a>, I use this exact block mode to run console output so that it won’t effect other non blocking IO operations:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">asyncPrintln</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span>
    <span class="k">implicit</span> <span class="n">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">],</span> <span class="n">blocker</span><span class="k">:</span> <span class="kt">Blocker</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nv">blocker</span><span class="o">.</span><span class="py">blockOn</span><span class="o">(</span><span class="nc">IO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="o">)))</span>
</code></pre></div></div>

<p>However, if a thread is blocked in this pool, it will start another thread for the next operation. Based on the document, there is no limit on how many threads will be created. So if the producer is much slower than consumer, there will be more and more consume operations blocked on dequeue, so it will generate a large amount of threads, which is not ideal and eventually even will blow up the memory.</p>

<h2 id="approach-3-use-cats-effect-friendly-queue">Approach 3: Use Cats Effect Friendly Queue</h2>

<p>What if we have a queue that only block the dequeue <code class="language-plaintext highlighter-rouge">IO</code> when empty instead of blocking the whole thread? Luckily, FS2 provides such a queue. (Cats Effect 3.x also provides such a queue). The implementation is basically the same as above (code in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/StreamQueueApp.scala">StreamQueueApp.scala</a>):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.concurrent.Queue</span>

<span class="k">def</span> <span class="nf">work</span><span class="o">()</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">queue</span> <span class="k">&lt;-</span> <span class="nv">Queue</span><span class="o">.</span><span class="py">bounded</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Seq</span><span class="o">(</span>
      <span class="o">(</span><span class="nf">produceStream</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="o">++</span> <span class="nv">fs2</span><span class="o">.</span><span class="py">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="nc">None</span><span class="o">)).</span><span class="py">through</span><span class="o">(</span><span class="nv">queue</span><span class="o">.</span><span class="py">enqueue</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
      <span class="nv">queue</span><span class="o">.</span><span class="py">dequeue</span><span class="o">.</span><span class="py">unNoneTerminate</span><span class="o">.</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)(</span><span class="n">consume</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
    <span class="o">).</span><span class="py">parSequence</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Run <code class="language-plaintext highlighter-rouge">sbt "run -n StreamAppQueue"</code> to see how it performs.</p>

<h2 id="approach-4-use-fs2-stream-directly">Approach 4: Use FS2 Stream Directly</h2>

<p>FS2 actually provides some advanced stream operations that makes it possible to combine the producing stream and consume stream, like the code in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/StreamApp.scala">StreamApp.scala</a>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">produceStream</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)(</span><span class="n">consume</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span>
</code></pre></div></div>

<p>Here we map <code class="language-plaintext highlighter-rouge">consume</code> in parallel on <code class="language-plaintext highlighter-rouge">produce</code> stream. However, if you try to run <code class="language-plaintext highlighter-rouge">sbt "run -n StreamApp"</code> vs <code class="language-plaintext highlighter-rouge">sbt "run -n StreamQueueApp"</code>, you will find this is slower than before. This is because <code class="language-plaintext highlighter-rouge">produceStream</code> will give the next batch when the downstream asks. If we can prepare at least one batch before the downstream is free, we can save more time. Luckily, it’s very easy to do in fs2. As we can see in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/PrefetchStreamApp.scala">PrefetchStreamApp.scala</a>, we can add <code class="language-plaintext highlighter-rouge">prefetch</code> after the <code class="language-plaintext highlighter-rouge">produceStream</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">produceStream</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="py">prefetch</span><span class="o">.</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)(</span><span class="n">consume</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span>
</code></pre></div></div>

<p>It will prefetch a <a href="https://fs2.io/#/guide?id=chunks">chunk</a> of elements. Use <code class="language-plaintext highlighter-rouge">prefetchN</code> if you want to prefetch N chunks.</p>

<p>Then run this with <code class="language-plaintext highlighter-rouge">sbt "run -n PrefetchStreamApp"</code>, you will find the performance is similar as the queued approach.</p>

<p>Actually if you check the source code of <code class="language-plaintext highlighter-rouge">prefetch</code>, you will find the implementation is almost the same as ours:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">prefetch</span><span class="o">[</span><span class="kt">F2</span><span class="o">[</span><span class="kt">x</span><span class="o">]</span> <span class="k">&gt;:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">x</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent</span><span class="o">]</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F2</span>, <span class="kt">O</span><span class="o">]</span> <span class="k">=</span> <span class="n">prefetchN</span><span class="o">[</span><span class="kt">F2</span><span class="o">](</span><span class="mi">1</span><span class="o">)</span>

<span class="k">def</span> <span class="nf">prefetchN</span><span class="o">[</span><span class="kt">F2</span><span class="o">[</span><span class="kt">x</span><span class="o">]</span> <span class="k">&gt;:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">x</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent</span><span class="o">](</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F2</span>, <span class="kt">O</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">Queue</span><span class="o">.</span><span class="py">bounded</span><span class="o">[</span><span class="kt">F2</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">Chunk</span><span class="o">[</span><span class="kt">O</span><span class="o">]]](</span><span class="n">n</span><span class="o">)).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">queue</span> <span class="k">=&gt;</span>
    <span class="nv">queue</span><span class="o">.</span><span class="py">dequeue</span><span class="o">.</span><span class="py">unNoneTerminate</span>
      <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">Stream</span><span class="o">.</span><span class="py">chunk</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
      <span class="o">.</span><span class="py">concurrently</span><span class="o">(</span><span class="nv">chunks</span><span class="o">.</span><span class="py">noneTerminate</span><span class="o">.</span><span class="py">covary</span><span class="o">[</span><span class="kt">F2</span><span class="o">].</span><span class="py">through</span><span class="o">(</span><span class="nv">queue</span><span class="o">.</span><span class="py">enqueue</span><span class="o">))</span>
  <span class="o">}</span>
</code></pre></div></div>

<h2 id="approach-5-make-producers-run-in-parallel">Approach 5: Make Producers Run in Parallel</h2>

<p>We’ve made it runs in parallel between consumers, also between consumers and producers. But we haven’t made producers run in parallel yet. With the queue, its very easy to do, just start multiple <code class="language-plaintext highlighter-rouge">IO</code>s for <code class="language-plaintext highlighter-rouge">produceStream.through(queue.enqueue)</code>. <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/ConcurrentProducerQueueApp.scala">ConcurrentProduceQueueApp.scala</a> is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">val</span> <span class="nv">counter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>

<span class="k">override</span> <span class="k">def</span> <span class="nf">work</span><span class="o">()</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">queue</span> <span class="k">&lt;-</span> <span class="nv">Queue</span><span class="o">.</span><span class="py">bounded</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span><span class="o">](</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Seq</span><span class="o">(</span>
      <span class="nf">produceStream</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nv">config</span><span class="o">.</span><span class="py">totalSize</span> <span class="o">/</span> <span class="mi">2</span><span class="o">).</span><span class="py">through</span><span class="o">(</span><span class="nv">queue</span><span class="o">.</span><span class="py">enqueue</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
      <span class="nf">produceStream</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">totalSize</span> <span class="o">/</span> <span class="mi">2</span><span class="o">,</span> <span class="nv">config</span><span class="o">.</span><span class="py">totalSize</span><span class="o">).</span><span class="py">through</span><span class="o">(</span><span class="nv">queue</span><span class="o">.</span><span class="py">enqueue</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
      <span class="nv">queue</span><span class="o">.</span><span class="py">dequeue</span><span class="o">.</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span>
        <span class="nf">consume</span><span class="o">(</span><span class="n">x</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
          <span class="nf">if</span> <span class="o">(</span><span class="nv">counter</span><span class="o">.</span><span class="py">incrementAndGet</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="nv">config</span><span class="o">.</span><span class="py">totalSize</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">None</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Some</span><span class="o">()</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}.</span><span class="py">unNoneTerminate</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">,</span>
    <span class="o">).</span><span class="py">parSequence</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It has 2 concurrent producers but in theory you can create as many as you want, just be careful with the parameters of <code class="language-plaintext highlighter-rouge">produceStream</code>.</p>

<p>If you run this with <code class="language-plaintext highlighter-rouge">sbt "run -n ConcurrentProduceQueueApp"</code>, you can find the performance is much better with slower producer. However, with the help of fs2 library, we can make the code cleaner without depends on any queue explicitly. Here is what I did in <a href="https://github.com/wb14123/scala-stream-demo/blob/master/src/main/scala/ConcurrentProducerApp.scala">ConcurrentProducerApp.scala</a>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">work</span><span class="o">()</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nv">fs2</span><span class="o">.</span><span class="py">Stream</span><span class="o">.</span><span class="py">emits</span><span class="o">(</span><span class="nc">Range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">produceParallelism</span><span class="o">))</span>
    <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">batch</span> <span class="k">=&gt;</span> <span class="nf">produceStream</span><span class="o">(</span>
      <span class="n">batch</span> <span class="o">*</span> <span class="nv">config</span><span class="o">.</span><span class="py">totalSize</span> <span class="o">/</span> <span class="n">produceParallelism</span><span class="o">,</span>
      <span class="o">(</span><span class="n">batch</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">*</span> <span class="nv">config</span><span class="o">.</span><span class="py">totalSize</span> <span class="o">/</span> <span class="nv">produceParallelism</span><span class="o">.</span><span class="py">toDouble</span><span class="o">))</span>
    <span class="o">.</span><span class="py">parJoin</span><span class="o">(</span><span class="n">produceParallelism</span><span class="o">)</span>
    <span class="o">.</span><span class="py">prefetch</span>
    <span class="o">.</span><span class="py">parEvalMap</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">batchSize</span><span class="o">)(</span><span class="n">consume</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here we use <code class="language-plaintext highlighter-rouge">parJoin</code> to join multiple producer stream at the same time.</p>

<h2 id="more">More</h2>

<p>All the approaches above other than the first one uses a queue either implicitly or explicitly. However, under high parallelism and load, every job operating on a single queue may makes this queue a bottleneck. In this case, there is a <a href="https://en.wikipedia.org/wiki/Work_stealing">work stealing</a> algorithm that each consumers can has its own queue, and whenever a consumer’s queue is empty, it steal some tasks from another one. But it’s a little bit complex and unnecessary if the load is not so high, so I will not cover it in this article.</p>

<h2 id="test-results">Test Results</h2>

<p>Now let’s run all the approaches and compare the performance with <code class="language-plaintext highlighter-rouge">sbt "run -n"</code>. Here are the results:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>slow producer</th>
      <th>balanced</th>
      <th>slow consumer</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BatchIO</td>
      <td>11086.078637 ms</td>
      <td>29912.377578 ms</td>
      <td>10015.51878 ms</td>
    </tr>
    <tr>
      <td>BlockingQueue</td>
      <td>10190.038753 ms</td>
      <td>14195.228189 ms</td>
      <td>6495.333179 ms</td>
    </tr>
    <tr>
      <td>StreamQueue</td>
      <td>10138.016643 ms</td>
      <td>14458.443122 ms</td>
      <td>6418.078377 ms</td>
    </tr>
    <tr>
      <td>Stream</td>
      <td>10356.178562 ms</td>
      <td>15655.697826 ms</td>
      <td>6560.111697 ms</td>
    </tr>
    <tr>
      <td>PrefetchStream</td>
      <td>10141.110634 ms</td>
      <td>14578.362136 ms</td>
      <td>6376.628036 ms</td>
    </tr>
    <tr>
      <td>ConcurrentProduceresQueue</td>
      <td>5187.442452 ms</td>
      <td>14395.321922 ms</td>
      <td>6576.538821 ms</td>
    </tr>
    <tr>
      <td>ConcurrentProducer</td>
      <td>5198.723825 ms</td>
      <td>14544.247312 ms</td>
      <td>6418.078377 ms</td>
    </tr>
  </tbody>
</table>

<p>We can see approaches that parallelize all the parts win the performance game.</p>

</article>

<footer id="post_footer">
  <table><tr>
    
      <td id="prev"><a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html">Prev: Upgrade Kubernetes from 1.23 to 1.24</a></td>
    
    
      <td id="next"><a href="/2023-09-01-Build-a-Linux-Virtual-Machine-for-Windows-Apps.html" id="next">Next: Build a Linux Virtual Machine for Windows Apps</a></td>
    
  </tr></table>
</footer>

<!--
<section id="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'crazy-hot-ice'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
-->



<!-- MathJax -->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

</div>

    </section>

    <footer id="page_footer">
      Copyright @ 2008 - 2024 Bin Wang
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
    </footer>
    </div>
  </body>
</html>
