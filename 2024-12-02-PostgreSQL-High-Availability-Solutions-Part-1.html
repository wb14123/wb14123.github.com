<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Jepsen Test on Patroni: A PostgreSQL High Availability Solution |  Bin Wang - My Personal Blog</title>
    <link rel="stylesheet" href="/static/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/asciinema-player.css" type="text/css" />

		<!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-52904500-1', 'auto');
      ga('send', 'pageview');
    </script>
		-->

		<!-- Matomo -->
		<script>
		  var _paq = window._paq = window._paq || [];
		  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//matomo.rssbrain.com/";
		    _paq.push(['setTrackerUrl', u+'matomo.php']);
		    _paq.push(['setSiteId', '2']);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<!-- End Matomo Code -->


  </head>

  <body>
    
    <div id="index_menu">
      
<!--
<div class="index-entry index-index"><a href="/">Home</a></div>
<div class="index-entry index-index"><a href="/snippets">Snippets</a></div>
<div class="index-entry index-index"><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></div>
<div class="index-entry index-index"><a href="/travel.html">Travel</a></div>
<div class="index-entry index-index"><a href="/search.html">Search</a></div>
<div class="index-entry index-index"><a href="/about.html">About</a></div>
<div class="index-entry index-index"><a href="/feed.xml" target="_blank">RSS</a></div>
-->




  

    <div class="index-entry index-index">
      
      Computer Science
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Algorithm
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-05-28-compute.html">任意进制数的补码 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-07-11-quick-sort.html">快排杀手 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-10-18-How-to-Estimate-Max-TPS-from-TPM.html">How to Estimate Max TPS from TPM <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Data Processing
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-04-29-Use-Docker-to-Submit-Spark-Jobs.html">Use Docker to Submit Spark Jobs <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-03-The-Proper-Way-to-Use-Spark-Checkpoint.html">The Proper Way to Use Spark Checkpoint <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-22-Use-Redis-Instead-of-Spark-Streaming-to-Count-Statistics.html">Use Redis Instead of Spark Streaming to Count Statistics <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Digital Life
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-26-Move-from-Twitter-to-Mastodon.html">Move from Twitter to Mastodon <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-02-What-Is-Wrong-abount-Recommendation-System.html">What Is Wrong about Recommendation System <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-15-Use-RSS-and-Kindle-to-Read-News.html">Use RSS and Kindle to Read News <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-23-Build-An-Instant_Messaging-System-without-Censorship-Choose-the-right-technology.html">Matrix: A Self Hosted Instant Messaging Solution with End to End Encryption <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-29-Build-An-Instant_Messaging-System-without-Censorship-Choose-An-Overview-of-Chinese-Internet-Censorship-Strategy.html">An Overview of China's Internet Censorship Strategy <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-09-08-Build-An-Instant-Messaging-System-without-Censorship-Deployment-Options.html">Deploy Matrix for Users in China <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-06-03-Random-Video-Playlists-for-Self-Hosted-Videos.html">Random Playlists for Self Hosted Videos <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Distributed System
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-07-29-A-Review-on-Spanner-and-Open-Source-Implementations.html">Spanner and Open Source Implementations <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2019-11-04-Great-Resources-for-Learning-Database-and-Distributed-System.html">Great Resources for Learning Database and Distributed System <span class="publish-year">(2019)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-09-16-Aurora-Database.html">Aurora Database <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-10-06-Understand-Liveness-and-Fairness-in-TLA.html">Understand Liveness and Fairness in TLA+ <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">Use TLA+ to Verify Cache Consistency <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-29-Keep-Data-Consistency-During-Database-Migration.html">Keep Data Consistency During Database Migration <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-12-14-Redis-Implementation-for-Cache-and-Database-Consistency.html">Redis Implementation for Cache and Database Consistency <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <div class="index-selected">Jepsen Test on Patroni: A PostgreSQL High Availability Solution <span class="publish-year">(2024)</span></div>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Distributed System Infrastructure
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-03-13-Infrastructure-Setup-for-High-Availability.html">Infrastructure Setup for High Availability <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html">Upgrade Kubernetes from 1.23 to 1.24 <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-04-How-to-Cleanup-Ceph-Filesystem-for-Deleted-Kubernetes-Persistent-Volume.html">How to Cleanup Ceph Filesystem for Deleted Kubernetes Persistent Volume <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-28-Introduce-K3s-CephFS-and-MetalLB-to-My-High-Avaliable-Cluster.html">Introduce K3s, CephFS and MetalLB to My High Avaliable Cluster <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Machine Learning
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-01-17-Backpropagation-Algorithm.html">Backpropagation Algorithm <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-07-02-My-Recent-Work-About-Neural-Networks.html">My Recent Work About Neural Networks <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-08-Install-BLAS-Library-for-MXNet.html">Install BLAS Library for MXNet <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-05-14-How-to-Put-RNN-Layer-Into-Nueral-Network-Model.html">How to Put RNN Layers Into Neural Network Model <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-06-19-Build-A-Computer-for-Deep-Learning.html">Build A Computer for Deep Learning <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Operating System
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Android
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-02-11-The-Permission-of-Android-Becomes-A-Bigger-Problem-When-It-Comes-to-Wearable-Devices-and-TV.html">The Permission Management of Android Becomes A Bigger Problem When It Comes to Wearable Devices and TV <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-11-18-Root-And-Optimize-MiBox-3S.html">Root And Optimize MiBox 3S <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Linux
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-07-12-port666.html">端口666：毁灭！ <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-12-chroot.html">Chroot 简介 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-27-Compile-And-Install-Kernel.html">Compile And Install Kernel <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-05-Backup-My-Dotfiles.html">Backup My Dotfiles <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-28-Comparison-Between-Linux-Desktop-Environments.html">Comparison Between Linux Desktop Environments <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-21-How-Kernel's-Makefile-Specify-Output-Directory.html">How Kernel's Makefile Specify Output Directory <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-10-06-Xbmc-on-Raspberry-Pi-with-Archlinux.html">Xbmc on Raspberry Pi with Archlinux <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-02-12-Setup-SSH-Authentication-with-YubiKey.html">Setup SSH Authentication with YubiKey <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-03-08-In-Defence-of-Disabling-Swap.html">In Defence of Disabling Swap <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-01-Build-a-Linux-Virtual-Machine-for-Windows-Apps.html">Build a Linux Virtual Machine for Windows Apps <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-10-22-Full-Disk-Encryption-with-Yubikey.html">Linux Full Disk Encryption with Yubikey <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-07-12-A-Review-of-Linux-on-Surface-Pro-4.html">A Review of Linux on Surface Pro 4 <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      MacOS
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-08-07-My-MacOS-Essentials.html">My MacOS Essentials <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Tizen
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-02-29-tizen.html">Tizen，加油 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Windows
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-11-28-Config-Development-Environment-on-Windows.html">Build a Unix Like Environment on Windows <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      iOS
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-08-DNS-Resolving-Bug-in-iOS-14.html">DNS Resolving Bug in iOS 14 <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-08-20-Apple-In-App-Purchase-Server-to-Server-Notification-Handling-with-Scala-Java.html">Handle Apple In-App-Purchase Server Notification with Scala/Java <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Programming Language
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      C++
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-02-11-cplusplus.html">也谈C++ <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Erlang
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-07-14-Build-Erlang-the-Rebar-Way.html">Build Erlang the Rebar Way <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-04-27-Why-I-Come-Back-to-Erlang.html">Why I Come Back to Erlang <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-05-16-Experiment-On-Combining-OOP-With-Erlang's-Actor-Model.html">Experiment On Combining OOP With Erlang's Actor Model <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Go
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-09-01-Notes-On-Go-Scheduler.html">Notes On Go Scheduler <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scala
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-07-11-Config-sbt-to-Use-Both-Proxy-and-Self-Hosted-Repositories.html">Config sbt to Use Both Proxy and Self Hosted Repositories <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-08-27-Compare-Task-Processing-Approaches-in-Scala.html">Compare Task Processing Approaches in Scala <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-30-A-Boring-JVM-Memory-Profiling-Story.html">A Boring JVM Memory Profiling Story <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-12-29-Scala-Macro-Tutorial.html">Scala 2 Macro Tutorial <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-09-13-SBT-Task-to-Build-Frontend-Components.html">SBT Task to Build Frontend Components <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scheme
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-01-27-sicp30.html">SICP第三章总结（上）——可变量与环境 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-14-sicp35.html">SICP第三章总结（下）——流编程 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Type System
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-08-02-RESTful-API-with-Type-System.html">RESTful API with Type System <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-11-Powerful-Type-System.html">Powerful Type System <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Software Engineering
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-18-Call-Program-Like-A-Function.html">Call Program Like A Function <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-04-02-More-About-Program-In-Shell-And-Function.html">More About Program In Shell And Function <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-05-Server-Logic-of-Level-Based-Games.html">Server Logic of Level Based Games <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-12-08-Languages-Should-Have-Database-Built-In.html">Languages Should Have Database Built In <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-04-26-How-About-Translate-IMAP-And-SMTP-Into-HTTP-API.html">How About Translate IMAP And SMTP Into HTTP API? <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-09-02-The-Things-You-Need-to-Know-When-Using-Apache-Sentry.html">The Things You Need to Know When Using Apache Sentry <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-02-21-Define-Infrastructure-as-Code.html">Define Infrastructure as Code <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-06-30-Why-Big-Companies-Need-to-Adopt-Open-Source.html">Why Big Companies Need to Adopt Open Source <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Storage
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-10-Change-Root-File-System-from-Ext4-to-Xfs-on-Archlinux.html">Change Root File System from Ext4 to Xfs on Archlinux <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-01-28-Migrate-Arch-Linux-to-Zfs.html">Migrate Arch Linux to ZFS <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-09-19-Personal-ZFS-Offsite-Online-Backup-Solution.html">Personal ZFS Offsite Backup Solution <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-12-14-ZFS-Profiling-on-Arch-Linux.html">ZFS Profiling on Arch Linux <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      UI
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Flutter
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-04-18-Make-Flutter-Web-App-More-Native-Like.html">Make Flutter Web Apps More Native Like <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Javascript
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-17-Beautiful-Math-with-MathJex.html">Beautiful Math with MathJex <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-01-28-HTML-+-CSS-+-JS-is-Good.html">HTML + CSS + JS is Good <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-02-14-What-is-Wrong-about-HTML.html">What is Wrong about HTML and CSS <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-03-26-Prevent-HTMX-Lazy-Loaded-Content-From-Reload.html">Prevent htmx Lazy Loaded Content From Reloading <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-06-08-Create-a-Checkbox-That-Returns-Boolean-Value-for-htmx.html">Create a Checkbox That Returns Boolean Value for htmx <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Virtualization
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-16-Create-A-Virtual-Machine-Network.html">Create A Virtual Machine Network <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-15-Fedora-Virt-manager-Guest-Connect-to-Host.html">Fedora Virt-manager Guest Connect to Host <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-11-03-Docker-Is-the-One-Scaffolding-to-Rule-Them-All.html">Docker Is the One Scaffolding to Rule Them All <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  

    <div class="index-entry index-index">
      
      Life
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-03-04-Life-in-Guangzhou.html">Life in Guangzhou <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-05-15-Recent-Works.html">Recent Works <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-07-20-The-Travel-to-Tokyo.html">东京之旅 <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-01-02-The-Year-of-2017.html">My 2017 Year in Review <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-01-26-My-2020-in-Review.html">My 2020 in Review <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-04-04-%E5%8D%81%E4%B8%89%E5%B9%B4%E5%89%8D%E8%A2%AB%E9%9A%94%E7%A6%BB%E7%9A%84%E7%BB%8F%E5%8E%86.html">十三年前被隔离的经历 <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-04-24-A-Travel-to-Montreal.html">A Travel to Montreal <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-01-26-My-2022-in-Review.html">My 2022 in Review <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-03-19-Travel-Back-to-China.html">Travel Back to China <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2025-01-13-A-2-Year-Reflection.html">A 2-Year Reflection for 2023 and 2024 <span class="publish-year">(2025)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Projects
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Bard
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-12-16-The-Thoughts-Behind-Bard-Framework.html">The Thoughts Behind Bard Framework <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-12-28-Why-Use-Reflections-to-Write-A-Web-Framework.html">Why Use Reflections to Write A Web Framework <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Blog
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-19-my-new-blog.html">My New Blog Website <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-20-Comment-And-Search-Are-Available.html">Comment And Search Are Available <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-10-Remove-Categories.html">Remove Categories <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-10-31-Add-Index-to-My-Blog.html">Add Index to My Blog <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-24-Jekyll-Plugin-to-Load-Asciicast-Locally.html">Jekyll Plugin to Load Asciinema Recordings Locally <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-10-Index-Sidebar-on-My-Blog.html">Add Index Sidebar to My Blog <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      RSS Brain
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-10-29-RSS-Brain-Yet-Another-RSS-Reader-With-More-Features.html">RSS Brain: Yet Another RSS Reader, With More Features <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-12-03-How-RSS-Brain-Shows-Related-Articles.html">How RSS Brain Shows Related Articles <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-14-Update-On-RSS-Brain-to-Find-Related-Articles-with-Machine-Learning.html">Update on RSS Brain to Find Related Articles with Machine Learning <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2024-07-27-Source-Code-of-RSS-Brain-Is-Available.html">Source Code of RSS Brain is Available <span class="publish-year">(2024)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scala2grpc
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3 <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-03-29-Comment-Everywhere.html">Comment Everywhere <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Psychology
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-10-xinlixue.html">耶鲁大学心理学导论 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Thoughts
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Chinese
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2008-12-21-people-mind.html">关于人的思想 <span class="publish-year">(2008)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2008-12-22-people-mind2.html">关于人的思想（续） <span class="publish-year">(2008)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-05-31-china.html">览《中国文化要义》有感 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-06-28-bad-guys.html">未来人们怎样对待坏人：读《理想国》杂想 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-12-20-life-game.html">好玩的生命游戏 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-05-19-tiandiyouyou.html">念天地之悠悠 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-04-The-Life-of-Hermit-without-Materially.html">摒弃现代科技的隐士生活 <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-07-24-%E8%AF%BB-%E9%82%93%E5%B0%8F%E5%B9%B3%E6%97%B6%E4%BB%A3-%E6%9C%89%E6%84%9F.html">读《邓小平时代》有感 <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2019-08-15-%E7%94%B1-%E5%BA%9F%E9%9D%92-%E8%BF%99%E4%B8%AA%E7%A7%B0%E5%91%BC%E6%89%80%E6%83%B3%E5%88%B0%E7%9A%84.html">由“废青”这个称呼所想到的 <span class="publish-year">(2019)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-09-%E7%9B%9B%E5%94%90%E8%AF%97%E4%BA%BA%E5%92%8C%E8%BF%9C%E6%B8%B8.html">盛唐诗人和远游 <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      English
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-08-30-Tired-of-Programming.html">Tired of Programming <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-21-The-Tragic-Talented-Programmer.html">The Tragic Talented Programmer <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  





<script>

  const isIndexPage = false;

  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)
  const indexMenu = document.getElementById('index_menu') || document.getElementById('index_menu_page');


  document.addEventListener("DOMContentLoaded", function(event) {

    if (isIndexPage) {
      var targetHref = new URL(document.referrer).pathname;
      console.log(targetHref);

      document.querySelectorAll('a').forEach(function(anchorTag) {
        // Check if the href attribute matches the targetHref
        if (anchorTag.getAttribute('href') === targetHref) {
           var newDiv = document.createElement('div');
           newDiv.classList.add('index-selected');
           // Copy the content of the <a> tag to the new <div>
           newDiv.innerHTML = anchorTag.innerHTML;
           // Replace the <a> tag with the new <div> element
           anchorTag.parentNode.replaceChild(newDiv, anchorTag);
        }
      });

    }

    var selected = document.getElementsByClassName("index-selected")[0];

    if (!isIndexPage) {
      var scrollpos = localStorage.getItem('menu-scroll-pos');
      console.log(scrollpos);
      if (scrollpos) indexMenu.scrollTo(0, scrollpos);
    }

    if (selected !== undefined) {
      const topOffset = selected.getBoundingClientRect().top;
      if (topOffset < 0 || topOffset > vh) {
        if (isIndexPage) {
          window.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
        } else {
          indexMenu.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
        }
      }
    }

  });

  window.onbeforeunload = function(e) {
    if (!isIndexPage) {
      localStorage.setItem('menu-scroll-pos', indexMenu.scrollTop );
    }
  };

</script>

    </div>
    

    <div id="main_content">
    <header id="page_header">
      <div id="menu-button">
          <a href="/index_page.html">&#9776;</a>
      </div>
      <nav id="page_nav">
        <ul>
             <li><a href="/">Home</a></li>
             <li><a href="/snippets">Snippets</a></li>
             <li><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></li>
             <li><a href="/travel.html">Travel</a></li>
             <li><a href="/search.html">Search</a></li>
             <li><a href="/about.html">About</a></li>
             <li><a href="/feed.xml">RSS</a></li>
       </ul>
      </nav>

    </header>



    <section id="page_content">
        <div id="content_table">
  <h3>Table of Contents</h3><ol class="toc"><li><a href="#jepsen-test-setup">Jepsen Test Setup</a></li><li><a href="#a-known-issue-of-postgresql-replication">A Known Issue of PostgreSQL Replication</a></li><li><a href="#patroni-setup-for-testing">Patroni Setup for Testing</a></li><li><a href="#reproduce-read-committed-violation">Reproduce Read Committed Violation</a></li><li><a href="#failed-to-recover-the-cluster-when-only-1-out-of-3-nodes-is-lost">Failed to Recover the Cluster When Only 1 Out of 3 Nodes is Lost</a></li><li><a href="#ways-to-improve">Ways to Improve?</a></li><li><a href="#minor-issue-wrong-role-label-for-kubernetes-pod">Minor Issue: Wrong Role Label for Kubernetes Pod</a></li><li><a href="#whats-next">What’s Next?</a></li></ol>
</div>

<div id="article_content" class="">
<article id="post">
  <header>
    <h1>Jepsen Test on Patroni: A PostgreSQL High Availability Solution</h1>
    
      <p class="description">Posted on 02 Dec 2024, tagged <code>database</code><code>jepsen</code><code>test</code><code>distributed system</code><code>consistency</code><code>HA</code></p>
    
  </header>

  <p><em>Note: code used in this article can be found on the Github repo <a href="https://github.com/wb14123/jepsen-postgres-ha">jepsen-postgres-ha</a>.</em></p>

<p>I’ve used Cockroach DB for a few of my side projects. I enjoyed it overall. But since it <a href="https://www.cockroachlabs.com/enterprise-license-update/">announced license change</a> and require mandatory telemetry collection for free version, I started to look for alternatives. The most nature choice is to just use the plain old PostgreSQL since my data size is not that big and even a less powerful machine can handle it without any problem. One of my important requirements for the database is to have good high availability setup so that I can just shutdown a machine for maintenance from time to time. This series of blog posts will focus on PostgreSQL’s HA solutions instead of why do we need that. Not saying why is not important enough but I’ll save that discussion for another blog post out of this series.</p>

<p>PostgreSQL doesn’t come with native high availability solution. Instead, it has features like replication to support you build your own HA solution. But we all know distributed system is hard to build and error-prone. So I’m planning to test different solutions before I trust my data with them: mainly using <a href="https://jepsen.io">Jepsen</a> to test the correctness at first and if it passes the test, benchmark it to make sure it’s usable in real world.</p>

<p>In the first part of this series, I’ll introduce the basic Jepsen test setup. Then use my early test result from <a href="https://github.com/patroni/patroni">Patroni</a>, a very popular PostgreSQL HA solution, as an example. In the test with Patroni, I’m able to:</p>

<ul>
  <li>Reproduce a known issue that causes violation of read committed isolation. This is related to a fundamental flaw in PostgreSQL’s replication implementation.</li>
  <li>Observe the cluster failed to recover with 1 node lose out of 3 nodes in total.</li>
</ul>

<p>Ideally I would like to do more tests and deeper digging into it, but I may not have enough free time in the coming 1 or 2 months so I’d like to record some result here and maybe have some updates later.</p>

<h2 id="jepsen-test-setup">Jepsen Test Setup</h2>

<p>The tool used in the tests is Jepsen. For the ones who are not familiar with it, it’s a tool to test the correctness of distributed systems. I highly recommend anyone interested in distributed systems to read its <a href="https://jepsen.io/analyses">analyses</a>, which have found bugs in almost every system it has tested, including <a href="https://jepsen.io/analyses/postgresql-12.3">PostgreSQL 12.3 with single machine setup</a>. On a high level, it runs queries and check if the data is consistent at the end, at the same time it has many built-in failures (nemesis in Jepsen’s term) can be introduced during the query, like node crash, network partition, network slowdown and so on. The analyses of PostgreSQL 12.3 already does an excellent job to explain how Jepsen tests PostgreSQL, so I’ll not repeat it here. I borrowed the append and read workload from that test but with 2 differences on other parts :</p>

<ol>
  <li>The database is setup in a different way. In the original test, it only tests a single machine PostgreSQL but the bugs are already fixed. So we are going to test a HA setup.</li>
  <li>In the original test, it was able to find bugs without import any failures. But since that bug has been fix, we are going to enable different built-in failures like node crash and network slowness to test if the PostgreSQL cluster can still behave correctly or not.</li>
</ol>

<p>To be more specific, I use <a href="https://www.vagrantup.com/">Vagrant</a> to create a 3 nodes virtual machine cluster and install Kubernetes (with <a href="https://k3s.io/">k3s</a>)on it. The Vagrantfile is <a href="https://github.com/wb14123/jepsen-postgres-ha/blob/master/cluster/Vagrantfile">here</a>. It’s mostly from a previous project I created to test k3s, as described in the blog post <a href="/2023-11-28-Introduce-K3s-CephFS-and-MetalLB-to-My-High-Avaliable-Cluster.html">Introduce K3s, CephFS and MetalLB to My High Avaliable Cluster</a>. This setup makes future tests for different HA solutions convenient since most of them supports Kubernetes, so that I can just create yaml files for different systems, while only need to implement Jepsen’s interface once to define database setup, tear down, kill and recover:</p>

<ul>
  <li>For setup, just use <code class="language-plaintext highlighter-rouge">kubectl create -f &lt;manifest.yaml&gt;</code>.</li>
  <li>For tear down, just use <code class="language-plaintext highlighter-rouge">kubectl delete -f</code> to delete the whole thing.</li>
  <li>To kill the db, find the root k3s process and <code class="language-plaintext highlighter-rouge">kill -9</code> it along with all its children process. Make sure to also stop the systemd service so it will not be automatically started again.</li>
  <li>To recover the db, simply start the k3s service again so that the pods will be scheduled on the node again. It just makes sure the k3s service is started. More health checks are needed if really want to wait for the db to be really recovered but it’s good for now.</li>
</ul>

<p>Related code is at <a href="https://github.com/wb14123/jepsen-postgres-ha/blob/3f5690f15cb34fdc196067786a48004dceae7ca8/src/jepsen/postgres_db.clj#L122">here</a>.</p>

<p>The code is meant to support any HA setup as long as it can be defined with a Kubernetes manifest. It supports <code class="language-plaintext highlighter-rouge">--cluster</code> flag so that can specify which manifest to test. I created a single node PostgreSQL setup and a Patroni setup for now. But in reality, Patroni has some special things that need to be taken care of, like delete PV and endpoints. I’ll clean those things up when my focus is moved to other HA solutions.</p>

<p>For the introduced failures, ideally we should test all the supported failures combined randomly. But the state space is large and need a long time to run. So I just created a specific combination to reproduce a known issue.</p>

<h2 id="a-known-issue-of-postgresql-replication">A Known Issue of PostgreSQL Replication</h2>

<p>When I searched for PostgreSQL HA solutions and whether any of them is tested by Jepsen, I found some <a href="https://news.ycombinator.com/item?id=23499611">comments on Hackernews</a> that says Patroni doesn’t guarantee consistency under some scenarios, which lead me to <a href="https://twitter.com/cyberdemn/status/1265710557006630913">the Twitter discussion</a>, which stated there is a fundamental flaw in PostgreSQL’s replication that makes it really hard to implement HA without data lose.</p>

<p>Here is the problem: usually with synced replication, a transaction should only be committed and visible after the replica db has persisted the transaction. So that if the primary db failed over to replica, there will be no data lose. But in a special scenario, where the query is cancelled after client sent commit command, PostgreSQL will consider it as committed even the transaction is not replicated yet. So when a failover happens at this time, this “committed data” will be lost from clients’ point of view. Here is an example:</p>

<table>
  <thead>
    <tr>
      <th>Time</th>
      <th>Node 1</th>
      <th>Node 2</th>
      <th>C1</th>
      <th>C2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Role: Primary<br />Visible data: k -&gt; [1]</td>
      <td>Role: Replica<br />Visible data: k -&gt; [ 1 ]</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>2</td>
      <td>Role: Primary<br />Visible data: k -&gt; [1]</td>
      <td> </td>
      <td>T1 start</td>
      <td> </td>
    </tr>
    <tr>
      <td>3</td>
      <td>Role: Primary<br />Visible data: k -&gt; [1]</td>
      <td> </td>
      <td>T1 append 2 to k</td>
      <td> </td>
    </tr>
    <tr>
      <td>4</td>
      <td>Role: Primary<br />Visible data: k -&gt; [1]</td>
      <td> </td>
      <td>T1 commit</td>
      <td> </td>
    </tr>
    <tr>
      <td>5</td>
      <td>T1 replication started</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>6</td>
      <td> </td>
      <td> </td>
      <td>T1 aborted(conn close? client kill?)</td>
      <td> </td>
    </tr>
    <tr>
      <td>7</td>
      <td>T1 replication not finished, but T1 is visible to other clients<br /><br />Role: Primary<br />Visible data: k -&gt; [1,2]</td>
      <td>Role: Replica<br />Visible data: k -&gt; [ 1]</td>
      <td> </td>
      <td>T2 read k, result = [1,2]</td>
    </tr>
    <tr>
      <td>8</td>
      <td>Node crash</td>
      <td>Role: Primary<br />Visible data: k -&gt; [1]</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>9</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>T3 read k,<br />result = [1]</td>
    </tr>
    <tr>
      <td>10</td>
      <td> </td>
      <td> </td>
      <td>T4 append 3 to k</td>
      <td> </td>
    </tr>
    <tr>
      <td>11</td>
      <td> </td>
      <td>Role: Primary<br />Visible data: k -&gt; [1,3]</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>12</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>T5 read k,<br />result = [1, 3]</td>
    </tr>
  </tbody>
</table>

<p>In the example above, the value of <code class="language-plaintext highlighter-rouge">k</code> is <code class="language-plaintext highlighter-rouge">[1]</code> at the beginning. C1 will append monotonically increasing values to <code class="language-plaintext highlighter-rouge">k</code>. (It tracks the value locally instead of query <code class="language-plaintext highlighter-rouge">k</code> every time). T1 is aborted before it’s replicated. But even so, the primary node still treat this transaction as committed. So when C2 queries with T2, it get results with <code class="language-plaintext highlighter-rouge">[1, 2]</code>. Then at time 8, the primary is failed over from node 1 to node 2, so when T3 queries <code class="language-plaintext highlighter-rouge">k</code>, it returns <code class="language-plaintext highlighter-rouge">[1]</code> instead of <code class="language-plaintext highlighter-rouge">[1,2]</code>. This is an obvious data lose in our point of view because we know exactly the order of events. But one can argue it miss linearizable guarantee since technically, T3 can be ordered before T2 or even T1, and it will produce a consistent history, thus violates linearizable but not serializable. However, with T5 that has the result of <code class="language-plaintext highlighter-rouge">[1,3]</code>, it creates a situation that conflict with T2:</p>

<ul>
  <li>If T2 is before T5, T5 should has 2 in the result.</li>
  <li>If T5 is before T2, T2 should has 3 in the result.</li>
</ul>

<p>This is not only a violation of serializable, but also read committed because T2 has read the uncommitted data from the client’s point of view.</p>

<h2 id="patroni-setup-for-testing">Patroni Setup for Testing</h2>

<p>Even this is a known issue and is documented, I still try to reproduce it in my test for a few reason: first I want to make sure my test is good enough to actually be able to reproduce it. Second, I want to see it happens in real world: the Patroni auto failover makes manually triggering this problem hard because there is only a short time for the commit to be replicated.</p>

<p>In my test, I try to setup Patroni to make it prioritize consistency the most. The config is at <a href="https://github.com/wb14123/patroni/blob/9ecfbe6209af3b3fd686d77bb9beb04deabaf5a9/kubernetes/entrypoint.sh#L14">here</a> for the Docker’s entrypoint script and <a href="https://github.com/wb14123/jepsen-postgres-ha/blob/04ddd2bcc107f81eb8abdbcf14f0ad5e396dc6d0/cluster/patroni/k8s.yaml#L113">here</a> for the config in Kubernetes. The PostgreSQL version is 16 and Patroni version is v4.0.3.</p>

<p>The key configurations are about replication mode. The description of each parameter below is copied from <a href="https://patroni.readthedocs.io/en/latest/replication_modes.html">Patroni document about replication modes</a>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">synchronous_mode</code> is set to <code class="language-plaintext highlighter-rouge">on</code>: When <code class="language-plaintext highlighter-rouge">synchronous_mode</code> is turned on Patroni will not promote a standby unless it is certain that the standby contains all transactions that may have returned a successful commit status to client. Turning on synchronous_mode does not guarantee multi node durability of commits under all circumstances. When no suitable standby is available, primary server will still accept writes, but does not guarantee their replication.</li>
  <li><code class="language-plaintext highlighter-rouge">synchronous_mode_strict</code> is set to <code class="language-plaintext highlighter-rouge">on</code>: When it is absolutely necessary to guarantee that each write is stored durably on at least two nodes, enable <code class="language-plaintext highlighter-rouge">synchronous_mode_strict</code> in addition to the <code class="language-plaintext highlighter-rouge">synchronous_mode</code>. This parameter prevents Patroni from switching off the synchronous replication on the primary when no synchronous standby candidates are available.</li>
  <li><code class="language-plaintext highlighter-rouge">synchronous_node_count</code> is left to default as <code class="language-plaintext highlighter-rouge">1</code>: The parameter <code class="language-plaintext highlighter-rouge">synchronous_node_count</code> is used by Patroni to manage the number of synchronous standby databases. It is set to 1 by default. It has no effect when <code class="language-plaintext highlighter-rouge">synchronous_mode</code> is set to off. When enabled, Patroni manages the precise number of synchronous standby databases based on parameter <code class="language-plaintext highlighter-rouge">synchronous_node_count</code> and adjusts the state in DCS &amp; <code class="language-plaintext highlighter-rouge">synchronous_standby_names</code> in PostgreSQL as members join and leave. If the parameter is set to a value higher than the number of eligible nodes it will be automatically reduced by Patroni.</li>
</ul>

<p>In PostgreSQL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>synchronous_commit: "on"
synchronous_standby_names: "*"
max_connections: 500
</code></pre></div></div>

<p>As stated in the Patroni doc, even with this setup it still has the known issue described above:</p>

<blockquote>
  <p>Note: Because of the way synchronous replication is implemented in PostgreSQL it is still possible to lose transactions even when using synchronous_mode_strict. If the PostgreSQL backend is cancelled while waiting to acknowledge replication (as a result of packet cancellation due to client timeout or backend failure) transaction changes become visible for other backends. Such changes are not yet replicated and may be lost in case of standby promotion.</p>
</blockquote>

<p>This is the thing I want to reproduce.</p>

<h2 id="reproduce-read-committed-violation">Reproduce Read Committed Violation</h2>

<p>The reproduce of this failure is harder than I thought, even I knew exactly the requirement to trigger it at the beginning. There are a few factors contributed to this:</p>

<p>First, if client doesn’t abort the connection itself, it’s hard to reproduce this scenario: Client not aborting the connection means it’s aborted by the primary node, which need to introduce some failures to primary node and that most likely makes it to failover immediately before the failure scenario is triggered. Jepsen’s built-in failures/nemesis are mostly on the server side. While not familiar with Clojure, it took me some time to figure out how to abort the connection just after sending the commit command. The code is at <a href="https://github.com/wb14123/jepsen-postgres-ha/blob/04ddd2bcc107f81eb8abdbcf14f0ad5e396dc6d0/src/jepsen/postgres/append.clj#L185">here</a>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="n">break-conn</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">read-only?</span><span class="p">))</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result-chan</span><span class="w"> </span><span class="p">(</span><span class="nf">chan</span><span class="p">)</span><span class="w">
        </span><span class="n">close-chan</span><span class="w"> </span><span class="p">(</span><span class="nf">chan</span><span class="p">)</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">result-chan</span><span class="w"> </span><span class="p">(</span><span class="nf">try</span><span class="w"> </span><span class="p">(</span><span class="nf">run</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">e</span><span class="p">))))</span><span class="w">
    </span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&lt;!</span><span class="w"> </span><span class="p">(</span><span class="nf">timeout</span><span class="w"> </span><span class="mi">120</span><span class="p">))</span><span class="w">
        </span><span class="p">(</span><span class="nf">try</span><span class="w"> </span><span class="p">(</span><span class="nf">c/close!</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">e</span><span class="p">))</span><span class="w">
        </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">close-chan</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">&lt;!!</span><span class="w"> </span><span class="n">close-chan</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">&lt;!!</span><span class="w"> </span><span class="n">result-chan</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">instance?</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">throw</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w">
        </span><span class="n">result</span><span class="w">
        </span><span class="p">)))</span><span class="w">
  </span><span class="p">(</span><span class="nf">run</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">break-conn</code> is a boolean that produced from a random number. If it’s not a read only transaction, the client will close the connection after a timeout of 120ms. As I will talk about later, I introduced the network slowdown to make the round trip about 100ms in average, so a complete replicated transaction should take 100ms (client to primary) + 100ms (primary to replica) = 200ms. So 120ms will hopefully makes the connection abort after the commit command is sent to the primary but before the transaction is replicated. This is definitely not the perfect way but it’s the best I can do for now.</p>

<p>Second, the nemesis package I copied from the original test is not very suitable to reproduce this issue: it randomly introduce different failures (passed in by cli flags) by a predefined average interval. So it needs some luck to get the scenario that triggers this failure: a combination of slow network + primary failure. So after I studied the failure scenario again, I changed the nemesis suite to create slow network all the time, and create a 90 seconds cycle for primary failure (30 seconds healthy state + 60 seconds node killed).</p>

<p>Third, the default work load will create multiple keys and run multiple ops in a single transaction. Which makes it harder to trigger the exact scenario (the transaction network round trip time will be different depends on the number of ops so 120ms is less likely to close connection after commit). After think more about the requirement to trigger the failure, I tuned the parameters to operate on a single key most of the time and only have a single operation per transaction.</p>

<p>The other factors are mostly about my setup with VM + Kubernetes. For example, I need to figure out ways to do things like crash the node (k3s root process + children process). I also need to adjust the network interface name in network related failures since the VM created <code class="language-plaintext highlighter-rouge">eth1</code> instead of <code class="language-plaintext highlighter-rouge">eth0</code> hard coded in Jepsen.</p>

<p>At last, you need a little bit luck: the failures is hard to trigger so my test doesn’t reproduce it every time. Just before I decided to give up, it showed the error. The command to reproduce it is in the <a href="https://github.com/wb14123/jepsen-postgres-ha">readme</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in</span> <span class="sb">`</span><span class="nb">seq </span>1 10<span class="sb">`</span> <span class="p">;</span> <span class="k">do
  </span>lein run <span class="nb">test</span> <span class="nt">--nodes-file</span> ./nodes <span class="nt">--username</span> vagrant <span class="nt">-w</span> append <span class="nt">--concurrency</span> 10 <span class="nt">--isolation</span> serializable <span class="nt">--nemesis</span> packet,kill <span class="nt">--time-limit</span> 1800 <span class="nt">-r</span> 100 <span class="nt">--nemesis-interval</span> 60 <span class="nt">--break-conn-percent</span> 0.8 <span class="nt">--cluster</span> patroni <span class="nt">--key-count</span> 1 <span class="nt">--max-txn-length</span> 1 <span class="nt">--max-writes-per-key</span> 24000 <span class="nt">--nemesis-suite</span> slow-net-kill
  <span class="nb">sleep </span>30
<span class="k">done</span>
</code></pre></div></div>

<p>Some key params:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">--time-limit 1800</code>: run the test for 1800 seconds.</li>
  <li><code class="language-plaintext highlighter-rouge">-r 100</code>: send 100 queries per second.</li>
  <li><code class="language-plaintext highlighter-rouge">--break-conn-percent 0.8</code>: 80% of the append transactions will be closed after 120ms.</li>
  <li><code class="language-plaintext highlighter-rouge">--key-count 1 --max-txn-length 1 --max-writes-per-key 24000</code>: operate on a single key until the operations exceed 24000 times.</li>
</ul>

<p>As stated above, the test slows down the network the whole time to an average of 100ms round trip. At the same time, it does this loop: wait 30 seconds. Kill the primary node by killing the k3s process and all its children processes. Wait 60 seconds. Start k3s service again.</p>

<p>At last, the outer for loop runs the command 10 times so it has a higher possibility to trigger the failure.</p>

<p>About why run the test 10 times instead of a single round of 300 mins, it’s related to another problem I found during the test which will be discussed in the later sections.</p>

<p>An example of the failure from a recent run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>:workload {:valid? false,
            :anomaly-types (:incompatible-order),
            :anomalies {:incompatible-order ({:key 0,
                                              :values [[4
                                                        6
                                                        8
                                                        9
// ... omitted lines of numbers
                                                        7164
                                                        7171
                                                        7176
                                                        7181]
                                                       [4
                                                        6
                                                        8
                                                        9
// ... committed lines of numbers, the same as before
                                                        7164
                                                        7171
                                                        7176
                                                        8433]]})},
            :not #{:read-committed},
            :also-not #{:causal-cerone
                        :consistent-view
                        :cursor-stability
                        :forward-consistent-view
                        :monotonic-atomic-view
                        :monotonic-snapshot-read
                        :monotonic-view
                        :parallel-snapshot-isolation
                        :prefix
                        :read-atomic
                        :repeatable-read
                        :serializable
                        :snapshot-isolation
                        :strong-read-committed
                        :strong-serializable
                        :strong-session-read-committed
                        :strong-session-serializable
                        :strong-session-snapshot-isolation
                        :strong-snapshot-isolation
                        :update-atomic
                        :update-serializable}},
 :valid? false}
</code></pre></div></div>

<p>If you check the last 2 numbers for the 2 transactions listed above: one transaction reads <code class="language-plaintext highlighter-rouge">[..., 7176, 7181]</code> and another one reads <code class="language-plaintext highlighter-rouge">[...., 7176, 8433]</code>. It reproduced the exact problem we discussed in the last section.</p>

<p>One thing to notice is, even though the behaviour of this failure is the same as we discussed in the last section, it doesn’t necessarily mean it’s the same root cause. I say that because this failure is so hard to trigger and I’m not sure yet what exactly triggered it. This is another thing I want to digger deeper into but may not have the time in the near future.</p>

<h2 id="failed-to-recover-the-cluster-when-only-1-out-of-3-nodes-is-lost">Failed to Recover the Cluster When Only 1 Out of 3 Nodes is Lost</h2>

<p>Jepsen generates some graphs after the test. So you can see how the database behaves during the test. The following graph is one of them. It’s the latency of each transaction and the time range of imported nemesis:</p>

<p><img src="/static/images/2024-12-02-PostgreSQL-High-Availability-Solutions---Part-1/failure-latency-raw.png" alt="failure-latency" /></p>

<p>The green area at the top means the time that network is slowed down, which is basically during the whole test time in our case. The red part is when the primary node is killed by our test: the lighter red part means the killed node starts to recover by the test until it reaches the white part which means it has been recovered (we mark it as recovered as soon as k3s server is recovered, so it’s not that accurate).</p>

<p>Each square/point represents a transaction. You can see even without primary node being killed, there are still some failed transactions and that’s totally normal in our test: it has errors like conflicted transactions and max connections reached etc. The thing more related is whether there are successful transactions, which is the blue square/point means.</p>

<p>We can see during the first few rounds when the primary get killed, the cluster can recover with 2 of 3 nodes available (the red range). However, when the time passed by, it can only recover when all the nodes are available (the white range). At the end of the test, there are 2 of 3 nodes available (sometimes there are all 3 nodes available because the recovery time are not always the same so the end state of the test can also be different). Just out of curious, I wanted to see how much time Patroni needs to recover in such state, so I left it without make the failed node available and waited. However, after 20 minutes, the cluster is still not recovered.</p>

<p>This means the cluster is failed to recover even if you only lose a minor number of the nodes. After I <a href="https://github.com/patroni/patroni/issues/3194#issuecomment-2496586804">asked in the Github issue</a>, I got <a href="https://github.com/patroni/patroni/issues/3194#issuecomment-2497196127">confirmed</a> that Patroni cannot be auto healed from such state. Apparently this is kind of a known behaviour but came as a surprise to me. To be fair, the behaviour of the parameters are documented but it’s hard to realize the implication. Again quoted from the description before:</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">synchronous_node_count</code>: If the parameter is set to a value higher than the number of eligible nodes it will be automatically reduced by Patroni.</p>
</blockquote>

<p>It’s not clear what “eligible nodes” means but seems it means available nodes instead of all nodes in the cluster.</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">synchronous_mode_strict</code>: When it is absolutely necessary to guarantee that each write is stored durably on at least <strong>two nodes</strong> …</p>
</blockquote>

<p>So it’s two nodes instead of a majority of the nodes: if you have a 5 nodes cluster and you happen to lose the 2 nodes with the most up to date data, it’s not possible to recover the data anymore.</p>

<p>Checking the doc again, seems <a href="https://patroni.readthedocs.io/en/latest/replication_modes.html#quorum-commit-mode">quorum commit mode</a> is something can help here. But test with <code class="language-plaintext highlighter-rouge">synchronous_mode=quorum</code> still got the same result. And from the doc:</p>

<blockquote>
  <p>On each iteration of HA loop, Patroni re-evaluates synchronous standby choices and quorum, based on node availability and requested cluster configuration. In PostgreSQL versions above 9.6 all eligible nodes are added as synchronous standbys as soon as their replication catches up to leader.</p>
</blockquote>

<p>From the test, seems the availability of nodes also affect the quorum.</p>

<p>Back to the question about why need to run the tests multiple times instead of running a single longer test: because the cluster doesn’t recovery by itself during a node lost after a few kill loop, which means more time is needed for the healing between node kills and makes the test less efficient. Also, when wait enough time between node kills, I was not able to reproduce the read committed violation anymore. That’s another reason that I’m suspicious if it is really caused by early connection close or not.</p>

<h2 id="ways-to-improve">Ways to Improve?</h2>

<p>With a quorum based system, there is \(V_w\) means the min nodes to write for a write transaction. There is \(V_r\) means the min nodes to read for a read transaction. In order to maintain searilizable, \(V_w + V_r &gt; V\) needs to be true where \(V\) is the number of <strong>all nodes</strong>, so that \(V_w\) and \(V_r\) has at least 1 node overlapped. That means when a client reads data from \(V_r\) nodes, at least 1 node has the latest data. In our case, for the normal read transactions, \(V_r\) doesn’t matter since it only reads from the primary so it’s guaranteed to have the latest data. But when doing a failover, we need to make sure having \(V_r\) nodes available because primary is lost and we need to determine which node has the latest data.</p>

<p>In the case of Patroni, with <code class="language-plaintext highlighter-rouge">synchronous_node_count</code> can be auto reduced and <code class="language-plaintext highlighter-rouge">synchronous_mode_strict</code> only guarantees data writes to at least 2 nodes, \(V_w\) is essentially set to 2 which means in order to maintain consistency, \(V_r &gt; V - V_w = V - 2\) needs to be true, which means it only tolerates 1 node lose no matter the cluster size. But even with only 1 node lose in our test above, Patroni didn’t implemented auto failover.</p>

<p>So to make it better tolerate node lose, there should be an option similar to <code class="language-plaintext highlighter-rouge">synchronous_node_count</code> but actually enforce the minimal synced replication count instead of reduce it based on node availability. And if the available nodes meets the requirement of \(V_r\), do the auto failover by comparing the largest LSN on each node.</p>

<h2 id="minor-issue-wrong-role-label-for-kubernetes-pod">Minor Issue: Wrong Role Label for Kubernetes Pod</h2>

<p>At last there is a minor issue but also the first issue I found during the test: in the Patroni doc, it uses the command <code class="language-plaintext highlighter-rouge">kubectl get pods -L role -o wide</code> to show the role of each Patroni pod. However, it is inaccurate as <a href="https://github.com/patroni/patroni/issues/3194#issuecomment-2439591095">confirmed in the Github issue</a>. It’s not a big deal but something need to be aware when operate Patroni. I think theoretically it may be able to be fixed by let the primary pod set the k8s labels for all the other pods.</p>

<h2 id="whats-next">What’s Next?</h2>

<p>Ideally, I still want to dig deeper into Patroni’s test since it’s a very popular PostgreSQL HA solution. The test above is only a carefully create scenario based on a known issue. Running larger scale tests with more combined failure scenarios may be able to find more failure modes. However, because the fundamental PostgreSQL replicat flaw described above and the effort needed to run the large scale tests, I may want to setup and test another solution first.</p>

<p>The solution is what I had in mind even before I started Patroni’s Jepsen test, which is setup replication with <a href="https://linbit.com/drbd/">DRBD</a>: instead of using PostgreSQL’s replication, DRBD replicas the whole disk instead. With modern hardware, the performance with replication overhead should be acceptable but it remains to be tested, along with the correctness of it.</p>

</article>

<footer id="post_footer">
  <table><tr>
    
      <td id="prev"><a href="/2024-09-13-SBT-Task-to-Build-Frontend-Components.html">Prev: SBT Task to Build Frontend Components</a></td>
    
    
      <td id="next"><a href="/2025-01-13-A-2-Year-Reflection.html" id="next">Next: A 2-Year Reflection for 2023 and 2024</a></td>
    
  </tr></table>
</footer>

<!--
<section id="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'crazy-hot-ice'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
-->



<!-- MathJax -->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

</div>

    </section>

    <footer id="page_footer">
      Copyright @ 2008 - 2024 Bin Wang
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
    </footer>
    </div>
  </body>
</html>
