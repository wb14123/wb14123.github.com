<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Infrastructure Setup for High Availability |  Bin Wang - My Personal Blog</title>
    <link rel="stylesheet" href="/static/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/asciinema-player.css" type="text/css" />

		<!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-52904500-1', 'auto');
      ga('send', 'pageview');
    </script>
		-->

		<!-- Matomo -->
		<script>
		  var _paq = window._paq = window._paq || [];
		  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//matomo.rssbrain.com/";
		    _paq.push(['setTrackerUrl', u+'matomo.php']);
		    _paq.push(['setSiteId', '2']);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<!-- End Matomo Code -->


  </head>

  <body>
    <div id="index_menu">
      
<!--
<div class="index-entry index-index"><a href="/">Home</a></div>
<div class="index-entry index-index"><a href="/snippets">Snippets</a></div>
<div class="index-entry index-index"><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></div>
<div class="index-entry index-index"><a href="/travel.html">Travel</a></div>
<div class="index-entry index-index"><a href="/search.html">Search</a></div>
<div class="index-entry index-index"><a href="/about.html">About</a></div>
<div class="index-entry index-index"><a href="/feed.xml" target="_blank">RSS</a></div>
-->




<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Computer Science)">Computer Science</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Algorithm)">Algorithm</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-05-28-compute.html">任意进制数的补码</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-07-11-quick-sort.html">快排杀手</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Data Processing)">Data Processing</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-04-29-Use-Docker-to-Submit-Spark-Jobs.html">Use Docker to Submit Spark Jobs</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-03-The-Proper-Way-to-Use-Spark-Checkpoint.html">The Proper Way to Use Spark Checkpoint</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-22-Use-Redis-Instead-of-Spark-Streaming-to-Count-Statistics.html">Use Redis Instead of Spark Streaming to Count Statistics</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Digital Life)">Digital Life</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-17-Beautiful-Math-with-MathJex.html">Beautiful Math with MathJex</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-26-Move-from-Twitter-to-Mastodon.html">Move from Twitter to Mastodon</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-02-What-Is-Wrong-abount-Recommendation-System.html">What Is Wrong about Recommendation System</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-15-Use-RSS-and-Kindle-to-Read-News.html">Use RSS and Kindle to Read News</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-23-Build-An-Instant_Messaging-System-without-Censorship-Choose-the-right-technology.html">Matrix: A Self Hosted Instant Messaging Solution with End to End Encryption</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-29-Build-An-Instant_Messaging-System-without-Censorship-Choose-An-Overview-of-Chinese-Internet-Censorship-Strategy.html">An Overview of China's Internet Censorship Strategy</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-09-08-Build-An-Instant-Messaging-System-without-Censorship-Deployment-Options.html">Deploy Matrix for Users in China</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Distributed System)">Distributed System</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-07-29-A-Review-on-Spanner-and-Open-Source-Implementations.html">Spanner and Open Source Implementations</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2019-11-04-Great-Resources-for-Learning-Database-and-Distributed-System.html">Great Resources for Learning Database and Distributed System</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-09-16-Aurora-Database.html">Aurora Database</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-10-06-Understand-Liveness-and-Fairness-in-TLA.html">Understand Liveness and Fairness in TLA+</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">Use TLA+ to Verify Cache Consistency</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-29-Keep-Data-Consistency-During-Database-Migration.html">Keep Data Consistency During Database Migration</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-12-14-Redis-Implementation-for-Cache-and-Database-Consistency.html">Redis Implementation for Cache and Database Consistency</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Distributed System Infrastructure)">Distributed System Infrastructure</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <div class="index-selected">Infrastructure Setup for High Availability</div>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html">Upgrade Kubernetes from 1.23 to 1.24</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-11-04-How-to-Cleanup-Ceph-Filesystem-for-Deleted-Kubernetes-Persistent-Volume.html">How to Cleanup Ceph Filesystem for Deleted Kubernetes Persistent Volume</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Machine Learning)">Machine Learning</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-01-17-Backpropagation-Algorithm.html">Backpropagation Algorithm</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-07-02-My-Recent-Work-About-Neural-Networks.html">My Recent Work About Neural Networks</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-08-Install-BLAS-Library-for-MXNet.html">Install BLAS Library for MXNet</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-05-14-How-to-Put-RNN-Layer-Into-Nueral-Network-Model.html">How to Put RNN Layers Into Neural Network Model</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-06-19-Build-A-Computer-for-Deep-Learning.html">Build A Computer for Deep Learning</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Operating System)">Operating System</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Android)">Android</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-02-11-The-Permission-of-Android-Becomes-A-Bigger-Problem-When-It-Comes-to-Wearable-Devices-and-TV.html">The Permission Management of Android Becomes A Bigger Problem When It Comes to Wearable Devices and TV</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-11-18-Root-And-Optimize-MiBox-3S.html">Root And Optimize MiBox 3S</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Linux)">Linux</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-07-12-port666.html">端口666：毁灭！</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-12-chroot.html">Chroot 简介</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-27-Compile-And-Install-Kernel.html">Compile And Install Kernel</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-05-Backup-My-Dotfiles.html">Backup My Dotfiles</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-28-Comparison-Between-Linux-Desktop-Environments.html">Comparison Between Linux Desktop Environments</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-21-How-Kernel's-Makefile-Specify-Output-Directory.html">How Kernel's Makefile Specify Output Directory</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-10-06-Xbmc-on-Raspberry-Pi-with-Archlinux.html">Xbmc on Raspberry Pi with Archlinux</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-03-08-In-Defence-of-Disabling-Swap.html">In Defence of Disabling Swap</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-01-Build-a-Linux-Virtual-Machine-for-Windows-Apps.html">Build a Linux Virtual Machine for Windows Apps</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-10-22-Full-Disk-Encryption-with-Yubikey.html">Linux Full Disk Encryption with Yubikey</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Tizen)">Tizen</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-02-29-tizen.html">Tizen，加油</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Windows)">Windows</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-11-28-Config-Development-Environment-on-Windows.html">Build a Unix Like Environment on Windows</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(iOS)">iOS</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-08-DNS-Resolving-Bug-in-iOS-14.html">DNS Resolving Bug in iOS 14</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-08-20-Apple-In-App-Purchase-Server-to-Server-Notification-Handling-with-Scala-Java.html">Handle Apple In-App-Purchase Server Notification with Scala/Java</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Programming Language)">Programming Language</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(C++)">C++</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-02-11-cplusplus.html">也谈C++</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Erlang)">Erlang</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-07-14-Build-Erlang-the-Rebar-Way.html">Build Erlang the Rebar Way</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-04-27-Why-I-Come-Back-to-Erlang.html">Why I Come Back to Erlang</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-05-16-Experiment-On-Combining-OOP-With-Erlang's-Actor-Model.html">Experiment On Combining OOP With Erlang's Actor Model</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Go)">Go</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-09-01-Notes-On-Go-Scheduler.html">Notes On Go Scheduler</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Javascript)">Javascript</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-01-28-HTML-+-CSS-+-JS-is-Good.html">HTML + CSS + JS is Good</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-02-14-What-is-Wrong-about-HTML.html">What is Wrong about HTML and CSS</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scala)">Scala</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-07-11-Config-sbt-to-Use-Both-Proxy-and-Self-Hosted-Repositories.html">Config sbt to Use Both Proxy and Self Hosted Repositories</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-08-27-Compare-Task-Processing-Approaches-in-Scala.html">Compare Task Processing Approaches in Scala</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-30-A-Boring-JVM-Memory-Profiling-Story.html">A Boring JVM Memory Profiling Story</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scheme)">Scheme</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-01-27-sicp30.html">SICP第三章总结（上）——可变量与环境</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-14-sicp35.html">SICP第三章总结（下）——流编程</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Type System)">Type System</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-08-02-RESTful-API-with-Type-System.html">RESTful API with Type System</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-11-Powerful-Type-System.html">Powerful Type System</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Security)">Security</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-09-02-The-Things-You-Need-to-Know-When-Using-Apache-Sentry.html">The Things You Need to Know When Using Apache Sentry</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-02-12-Setup-SSH-Authentication-with-YubiKey.html">Setup SSH Authentication with YubiKey</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Software Engineering)">Software Engineering</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-18-Call-Program-Like-A-Function.html">Call Program Like A Function</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-04-02-More-About-Program-In-Shell-And-Function.html">More About Program In Shell And Function</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-05-Server-Logic-of-Level-Based-Games.html">Server Logic of Level Based Games</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-12-08-Languages-Should-Have-Database-Built-In.html">Languages Should Have Database Built In</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-04-26-How-About-Translate-IMAP-And-SMTP-Into-HTTP-API.html">How About Translate IMAP And SMTP Into HTTP API?</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-10-18-How-to-Estimate-Max-TPS-from-TPM.html">How to Estimate Max TPS from TPM</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-02-21-Define-Infrastructure-as-Code.html">Define Infrastructure as Code</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-06-30-Why-Big-Companies-Need-to-Adopt-Open-Source.html">Why Big Companies Need to Adopt Open Source</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Storage)">Storage</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-10-Change-Root-File-System-from-Ext4-to-Xfs-on-Archlinux.html">Change Root File System from Ext4 to Xfs on Archlinux</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-01-28-Migrate-Arch-Linux-to-Zfs.html">Migrate Arch Linux to ZFS</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-09-19-Personal-ZFS-Offsite-Online-Backup-Solution.html">Personal ZFS Offsite Backup Solution</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Virtualization)">Virtualization</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-16-Create-A-Virtual-Machine-Network.html">Create A Virtual Machine Network</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-15-Fedora-Virt-manager-Guest-Connect-to-Host.html">Fedora Virt-manager Guest Connect to Host</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-11-03-Docker-Is-the-One-Scaffolding-to-Rule-Them-All.html">Docker Is the One Scaffolding to Rule Them All</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Essay)">Essay</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Chinese)">Chinese</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2008-12-21-people-mind.html">关于人的思想</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2008-12-22-people-mind2.html">关于人的思想（续）</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-05-31-china.html">览《中国文化要义》有感</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-06-28-bad-guys.html">未来人们怎样对待坏人：读《理想国》杂想</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-12-20-life-game.html">好玩的生命游戏</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-05-19-tiandiyouyou.html">念天地之悠悠</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-04-The-Life-of-Hermit-without-Materially.html">摒弃现代科技的隐士生活</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-07-24-%E8%AF%BB-%E9%82%93%E5%B0%8F%E5%B9%B3%E6%97%B6%E4%BB%A3-%E6%9C%89%E6%84%9F.html">读《邓小平时代》有感</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2019-08-15-%E7%94%B1-%E5%BA%9F%E9%9D%92-%E8%BF%99%E4%B8%AA%E7%A7%B0%E5%91%BC%E6%89%80%E6%83%B3%E5%88%B0%E7%9A%84.html">由“废青”这个称呼所想到的</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-09-%E7%9B%9B%E5%94%90%E8%AF%97%E4%BA%BA%E5%92%8C%E8%BF%9C%E6%B8%B8.html">盛唐诗人和远游</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(English)">English</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-08-30-Tired-of-Programming.html">Tired of Programming</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-21-The-Tragic-Talented-Programmer.html">The Tragic Talented Programmer</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Life)">Life</a>
      

      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-03-04-Life-in-Guangzhou.html">Life in Guangzhou</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-05-15-Recent-Works.html">Recent Works</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-07-20-The-Travel-to-Tokyo.html">东京之旅</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-01-02-The-Year-of-2017.html">My 2017 Year in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-01-26-My-2020-in-Review.html">My 2020 in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-04-04-%E5%8D%81%E4%B8%89%E5%B9%B4%E5%89%8D%E8%A2%AB%E9%9A%94%E7%A6%BB%E7%9A%84%E7%BB%8F%E5%8E%86.html">十三年前被隔离的经历</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-04-24-A-Travel-to-Montreal.html">A Travel to Montreal</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-01-26-My-2022-in-Review.html">My 2022 in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Projects)">Projects</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Bard)">Bard</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-12-16-The-Thoughts-Behind-Bard-Framework.html">The Thoughts Behind Bard Framework</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-12-28-Why-Use-Reflections-to-Write-A-Web-Framework.html">Why Use Reflections to Write A Web Framework</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Blog)">Blog</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-19-my-new-blog.html">My New Blog Website</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-20-Comment-And-Search-Are-Available.html">Comment And Search Are Available</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-10-Remove-Categories.html">Remove Categories</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-10-31-Add-Index-to-My-Blog.html">Add Index to My Blog</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-24-Jekyll-Plugin-to-Load-Asciicast-Locally.html">Jekyll Plugin to Load Asciinema Recordings Locally</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(RSS Brain)">RSS Brain</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-10-29-RSS-Brain-Yet-Another-RSS-Reader-With-More-Features.html">RSS Brain: Yet Another RSS Reader, With More Features</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-12-03-How-RSS-Brain-Shows-Related-Articles.html">How RSS Brain Shows Related Articles</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scala2grpc)">Scala2grpc</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-03-29-Comment-Everywhere.html">Comment Everywhere</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Psychology)">Psychology</a>
      

      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-10-xinlixue.html">耶鲁大学心理学导论</a>
        
      

      
        </div>
      
    </div>




<script>

  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)

  const indexMenu = document.getElementById('index_menu');
  const selected = document.getElementsByClassName("index-selected")[0];




  document.addEventListener("DOMContentLoaded", function(event) {
    var scrollpos = localStorage.getItem('menu-scroll-pos');
    console.log(scrollpos);
    if (scrollpos) indexMenu.scrollTo(0, scrollpos);

    if (selected !== undefined) {
      const topOffset = selected.getBoundingClientRect().top;
      if (topOffset < 0 || topOffset > vh) {
        indexMenu.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
      }
    }

  });

  window.onbeforeunload = function(e) {
    localStorage.setItem('menu-scroll-pos', indexMenu.scrollTop );
  };

</script>

    </div>

    <div id="main_content">
    <header id="page_header">
      <div id="menu-button">
          <a href="/index_page.html">&#9776;</a>
      </div>
      <nav id="page_nav">
        <ul>
             <li><a href="/">Home</a></li>
             <li><a href="/snippets">Snippets</a></li>
             <li><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></li>
             <li><a href="/travel.html">Travel</a></li>
             <li><a href="/search.html">Search</a></li>
             <li><a href="/about.html">About</a></li>
             <li><a href="/feed.xml">RSS</a></li>
       </ul>
      </nav>

    </header>



    <section id="page_content">
        <div id="content_table">
  <h3>Table of Contents</h3><ol class="toc"><li><a href="#what-is-high-availability">What is High Availability?</a></li><li><a href="#ha-setup">HA Setup</a></li><li><a href="#compute-kubernetes">Compute: Kubernetes</a></li><li><a href="#storage-glusterfs">Storage: GlusterFS</a></li><li><a href="#database-cockroachdb">Database: CockroachDB</a></li><li><a href="#network-ingress">Network Ingress</a></li></ol>
</div>

<div id="article_content" class="">
<article id="post">
  <header>
    <h1>Infrastructure Setup for High Availability</h1>
    
      <p class="description">Posted on 13 Mar 2023, tagged <code>Kubernetes</code><code>GlusterFS</code><code>CockroachDB</code><code>tech</code><code>high availability</code></p>
    
  </header>

  <p>Cloud is popular these days. But sometimes we just want to host something small, maybe just an open source service for family and friends, or some self-built service that we are still experimenting on. In this case, the cloud can be expensive. We can just throw a few nodes at home and run it at a very low cost. But you don’t want the service down when some nodes failed, at least the service should be available when you upgrade and reboot the nodes because it can happen very frequently. In this article, I will talk about how to build high available infrastructure so that the service can be alive even when some nodes are down.</p>

<h2 id="what-is-high-availability">What is High Availability?</h2>

<p>Availability means a service is alive and can serve traffic. High availability (HA) means when some components of the system are down, the service is still alive. The failed components can be in different layers: it can be a region, a DC, a network, or some nodes. In this article, I’ll only talk about things including and above node level, since region and network are usually out of control for a small infrastructure setup. That means you can host the service on multiple machines, and it should still be alive even when some of the machines are down. This is the most useful case of HA in the case anyway since nodes can be down frequently because of OS or software updates.</p>

<p>Before I start with the real setup, I want to clear some myths about HA first. Maybe you’ve heard of the famous CAP theorem, which says only two of the three properties can be met at the same time: consistency, availability, and partition tolerance. Lots of people misinterpret it as a HA system that will sacrifice consistency during a failure. It is not true: the type of partition that makes you must choose between consistency and availability is very rare. In most well-designed HA systems, you can have both as long as more than half of the nodes are alive (alive also means reachable from clients). And HA doesn’t necessarily mean it prioritizes availability over consistency either: it just means it can handle more failure cases when keeping both consistency and availability. When there is a failure it cannot handle, it can choose to keep consistency and make the service unavailable. This is the type of HA I’m going to introduce in this setup.</p>

<p>So to make it clear, the HA goal in this setup is to make the services still alive without sacrificing consistency when we lose less than half of the nodes (either it’s partitioned from the network or actually dead).</p>

<h2 id="ha-setup">HA Setup</h2>

<p>As said before, the HA needs multiple nodes in case of some nodes are down. The setup in this article can tolerate less than half of the node loss. So if you want to have a HA that can handle 1 node loss, the whole system needs at least 3 nodes. There are lots of cheap used machines on the market that have enough power to host many open source services.</p>

<p>The HA setup has multiple layers and we will use different tools for each of the layers:</p>

<ul>
  <li>Compute: Kubernetes</li>
  <li>Storage: GlusterFk</li>
  <li>Database: Cockroach DB</li>
  <li>Network Ingress: Cloudflare Tunnel</li>
</ul>

<p>Here is an overview of the setup:</p>

<p><img src="/static/images/2023-03-13-Infrastructure-Setup-for-High-Availability/HA-self-hosted.png" alt="overview" /></p>

<p>Let’s talk about each of them in detail.</p>

<h2 id="compute-kubernetes">Compute: Kubernetes</h2>

<p><a href="https://kubernetes.io/">Kubernetes</a> is a container orchestration system. Think of it as Docker but across machines. You define what you want to run in the format of YAML or Json, including how much CPU, memory, and storage to use, then Kubernetes will find a node that fits your needs to run your container. It also tries to keep the current system state that meets your definition. For example, if there is a node failed and your service’s container is on it, Kubernetes will try to find another node to start the container so that the state meets the definition. So if the service itself doesn’t have any state between restarts, you get HA for free using Kubernetes.</p>

<p>I must have some warnings about using Kubernetes. It’s a complex project that is used by many big players. It’s not very easy to set up, maintain or upgrade. You need lots of knowledge to make it work. It has so many open issues that your particular needs are most likely not prioritized. While it’s open source so that you can modify the code to meet your use case, and I’ve had good experience contributing code in the early days, the recent experience is not so good anymore: you may need to attend some discussions to push your change instead of async online discussion. That is a lot for a causal contributor. So I end up maintaining a custom branch of Kubernetes with the changes I need locally, which is also a lot for average users.</p>

<p>Even though Kubernetes is heavy, I still think it’s a good tool even for small deployments since it’s already the industry standard. If you want to dedicate the maintenance of the Kubernetes cluster to a third party in the future, you can find lots of providers very easily. And you can just migrate your services to a different cluster without much effort since you’ve already defined the deployment in a language that any Kubernetes cluster can understand.</p>

<p>If you decide Kubernetes is the way to go, Kubernetes can be deployed with Kubeadm. Here is the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/">official document</a> about how to deploy a Kubernetes cluster. Make sure to finish the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">HA setup</a> so that Kubernetes can survive even if some nodes are down.</p>

<p>Because of the nature of multiple nodes, every time the service restarts, the container can end on a different machine. So if your service needs to store anything on a disk, the data can get lost if you use the local disk of the machine. There are a few solutions for this:</p>

<ul>
  <li>Just don’t store data on a disk:
    <ul>
      <li>Store it in a database instead. But this is not an option for a service we don’t write and control.</li>
      <li>Send the files to another system. For example, you can send all the logs to something like Elastic Search so that it’s acceptable to lose logs after the container is restarted.</li>
      <li>Use <a href="https://kubernetes.io/docs/concepts/configuration/configmap/">ConfigMaps</a> for configuration files so that you can access them on any machine.</li>
    </ul>
  </li>
  <li>Bind the service to a specific node so that the container will run on that machine all the time. This needs the service itself to have HA built in so that when that node fails, the containers on the other nodes can still serve traffic. We will see an example of this in Cockroach DB setup.</li>
  <li>The last option is to use a distributed storage system that can be accessed from every machine. We will use GlusterFS for it in this setup.</li>
</ul>

<h2 id="storage-glusterfs">Storage: GlusterFS</h2>

<p><strong>WARNING: Gluster integration for Kubernetes has been removed since Kubernetes 1.26. You can use CephFS instead. Or check <a href="https://github.com/kadalu/kadalu/">Kadulu</a> if you still want to use GlusterFS.</strong></p>

<p><a href="https://www.gluster.org/">Gluster</a> is a distributed storage system. Once you created a GlusterFS volume, you can mount it to a machine just like NFS. The difference is the volume is backed by multiple machines so if even one of the machines fails, the volume is still usable. Kubernetes could mount a GlusterFS volume for containers as well. Sadly, Kubernetes has removed this support since version 1.26. But I’ve had this setup for a while and is still using an older version of Kubernetes, so I’ll still list GlusterFS as a solution here. The documents are still available for older versions. <a href="https://v1-24.docs.kubernetes.io/docs/concepts/storage/volumes/#glusterfs">Here is an example for Kubernetes 1.24</a>. You can select “versions” on the upper right to match your Kubernetes installation. CephFS is another distributed storage system, but it’s less user-friendly than GlusterFS in my opinion since the setup is more complex and it’s harder to mount it locally and explore it like a normal Linux file system. <a href="https://github.com/kadalu/kadalu/">Kadulu</a> seems to be another option if you still want to use GlusterFS, but I’ve never used it and I’m not sure if it’s production ready or not.</p>

<p>See <a href="https://docs.gluster.org/en/latest/Install-Guide/Overview/#what-is-gluster-without-making-me-learn-an-extra-glossary-of-terminology">the official install guide</a> for how to install Gluster and set it up. Most of the Linux distros already have the Gluster in the repo so you can install it by the package manager, and configure it based on the official document. Be aware you need to reserve a separate partition just for Gluster.</p>

<p>When creating a Gluster volume for use with Kubernetes, make sure to create it with at least 3 replicas so that you have HA for this volume. One of the replicas can be “<a href="https://docs.gluster.org/en/v3/Administrator%20Guide/arbiter-volumes-and-quorum/">arbiter</a>”, which means it’s only used for checking consistency and doesn’t store any actual data. So the data is only duplicated across 2 machines instead of 3 to save some space. Here is an example command to create such a volume:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>sudo gluster volume create &lt;volume-name&gt; replica 3 arbiter 1 &lt;host1&gt;:&lt;glusterfs-path&gt; &lt;host2&gt;:&lt;glusterfs-path&gt; &lt;host3&gt;:&lt;glusterfs-path&gt;
</pre></div>
</div>
</div>

<h2 id="database-cockroachdb">Database: CockroachDB</h2>

<p>Even though we can make persistent work with distributed storage, it’s better to avoid it if possible because of the setup complexity and performance impact. (This is more of the case of a self-hosted solution, distributed storage from cloud providers is very easy to use, and is also used by the VM so there is no difference in performance). We’ve listed some options above. In this section, we will look at how to create a database for the services to use so that they don’t need to store data on disks.</p>

<p>Here I will use CockroachDB as an example. But this introduction should help you to set up other similar systems like Elastic Search. Cockroach DB is a distributed database that is compatible with PostgreSQL. It’s built with HA in mind, so it has good guarantees and is easy to set up. I’ve checked lots of HA solutions for PostgreSQL and all of them have less guarantee (lots of them have no information about the consistency and availability level they provide, and I found them half-baked with a closer look) while are much harder to set up. I’ve written <a href="/2018-07-29-A-Review-on-Spanner-and-Open-Source-Implementations.html">a blog about Spanner that also talks about Cockroach DB</a> if you are interested in more details. Overall I have a good impression of it: the tech writings are solid, and the support is nice: when I have an issue and report it in the forum, the response is usually very quick and useful even though I’m just a free user.</p>

<p>CockroachDB has <a href="https://www.cockroachlabs.com/docs/stable/kubernetes-overview.html">an official document</a> about how to install it on Kubernetes. It’s using <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a>. Here is <a href="https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/cockroachdb-statefulset.yaml">one of the configurations it uses</a>. However, I still find there are too many limitations in StatefulSets so I deployed it in my own way:</p>

<ul>
  <li>Each CockroachDB instance is in its own StatefulSets with only 1 replica.</li>
  <li>Each of the instances is bound to the physical node with <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/">PodAffinity</a>. So that each instance will only ever run on a specific host. In this way, we can just use the local disk as the storage because it will never run on a different host.</li>
  <li>Each CockroachDB instance has its own <a href="https://kubernetes.io/docs/concepts/services-networking/service/">service</a> defined so that they can communicate with each other.</li>
  <li>Copy the parameters from the official configuration and adjust them based on your use case.</li>
</ul>

<p>With a setup like this, it’s like installing CockroachDB on physical nodes but managed by Kubernetes. You don’t need to worry about distributed storage. When a node fails, a CockroachDB instance will also fail. But since CockroachDB itself has HA enabled, the whole CockroachDB cluster is still alive. Here is an example of the Kubernetes resources in my setup:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span># Pods
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>NAME                READY   STATUS    RESTARTS   AGE
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>pod/cockroach01-0   1/1     Running   1          4d11h
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>pod/cockroach02-0   1/1     Running   5          4d11h
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>pod/cockroach03-0   1/1     Running   0          4d11h
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span># StatefulSet
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>NAME          READY   AGE
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>cockroach01   1/1     298d
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>cockroach02   1/1     298d
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>cockroach03   1/1     298d
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span># Service
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>NAME                              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>service/cockroach01-cockroachdb   ClusterIP   None           &lt;none&gt;        26257/TCP,8080/TCP               298d
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>service/cockroach02-cockroachdb   ClusterIP   None           &lt;none&gt;        26257/TCP,8080/TCP               298d
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>service/cockroach03-cockroachdb   ClusterIP   None           &lt;none&gt;        26257/TCP,8080/TCP               298d
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>service/cockroachdb               ClusterIP   10.96.70.142   &lt;none&gt;        26257/TCP,8080/TCP               269d
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>service/cockroachdb-public        NodePort    10.108.23.98   &lt;none&gt;        26257:30005/TCP,8080:30006/TCP   269d
</pre></div>
</div>
</div>

<p>You can see there is a separate StatefulSet for each of the CockroachDB instances, and a service for each of them for internal communications (with the name pattern <code>cockroach**-cockroachdb</code>). Service <code>cockroachdb</code> is for the use in Kubernetes cluster, and service <code>cockroachdb-public</code> is used by the service outside of the Kubernetes cluster (can be disabled if not needed) so that you can see the dashboard from your browser.</p>

<p>It may seem to have more Kubernetes definitions to write with such a method. But remember, while Kubernetes accepts YAML or Json format, how to prepare the definition can be flexible: you can use your favorite programming language to construct the definition and pass it to Kubernetes with a <a href="https://kubernetes.io/docs/reference/using-api/client-libraries/">client library</a>.</p>

<p>The upgrade of CockroachDB is very easy as well. Make sure to check the official release notes and upgrade guides first, but normally the upgrade is just to patch each of the StatefulSet with a newer version of Docker image, for example:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span># run this command for every stateful set
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>kubectl patch statefulset cockroach01 \
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>--type='json' \
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>-p='[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;cockroachdb/cockroach:v22.2.5&quot;}]'
</pre></div>
</div>
</div>

<h2 id="network-ingress">Network Ingress</h2>

<p>Once we have everything deployed in the cluster, the last step is to expose our service to the public Internet so that everyone can use it. Here we list two options based on the use case.</p>

<h3 id="cloudflare-tunnel">Cloudflare Tunnel</h3>

<p><a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/">Cloudflare Tunnel</a> is basically a reverse proxy that forwards the traffic from the public Internet to your service. There is a daemon called cloudflared running in Kubernetes. Cloudflare will forward the traffic from clients to cloudflared and cloudflared will forward the traffic to the actual service. Check <a href="https://developers.cloudflare.com/cloudflare-one/tutorials/many-cfd-one-tunnel/">this doc</a> to see how it works with Kubernetes.</p>

<p>The upside of Cloudflare tunnel is that you don’t need to open any port to the public Internet at all. So it’s safer because there is no way to access your service without going to Cloudflare first. Cloudflare also provide some tools to mediate attacks like DDoS.</p>

<p>The downside is it depends on a third-party provider. And it can see all the traffic. It only supports limited protocols. So if you want to avoid Cloudflare seeing your traffic or have a protocol that is not supported, you need a more generic way to do it.</p>

<h3 id="nodeport-with-virtual-ip-and-dynamic-dns">NodePort with Virtual IP and Dynamic DNS</h3>

<p>We need to really open a port to the Internet without something like Cloudflare Tunnel. First, we need to open a port on our nodes, this can be done by defining <a href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport">NodePort</a> in Kubernetes’ service.</p>

<p>Once we have the port opened on the nodes, we need to open it to the Internet. How to do it depends on the Internet provider. Usually, you should be able to set up a port mapping from the router to an internal IP for a node. However, to make the setup HA, we shouldn’t map the port just to a single node since that single node can be down, we can set up Keepalived so that there is a virtual IP that always maps to a live node. If you’ve <a href="https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md#options-for-software-load-balancing">set up HA for Kubernetes with Keepalived and HAProxy</a>, you should be already familiar with how to set it up.</p>

<p>When you open a NodePort, make sure you’ve configured all the protections like authentication and encryption since beyond that it’s public Internet and anyone can access it.
You may want to run Nginx or HAProxy in the Kubernetes cluster, use it as a reverse proxy and only expose it to the Internet so that it’s safer and you have more control over the public traffic.</p>

<p>The client also needs a way to find the IP address of your network. Depending on the Internet provider, the IP address can change from time to time. So we need dynamic DNS to bind the changing IP to a fixed DNS. <a href="https://github.com/ddclient/ddclient">ddclient</a> can do it automatically and supports lots of domain name providers.</p>

<p>After all of this, your service is open to the public Internet and can be accessed by anyone. But if desired, you can still use Cloudflare DNS with proxy enabled, so that the client will send requests to Cloudflare first and you can get protections from Cloudflare. In this case, since the SSL is terminated inside the Kubernetes cluster, Cloudflare will not be able to see the actual payload of the traffic.</p>


</article>

<footer id="post_footer">
  <table><tr>
    
      <td id="prev"><a href="/2023-01-26-My-2022-in-Review.html">Prev: My 2022 in Review</a></td>
    
    
      <td id="next"><a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html" id="next">Next: Upgrade Kubernetes from 1.23 to 1.24</a></td>
    
  </tr></table>
</footer>

<section id="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'crazy-hot-ice'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



<!-- MathJax -->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

</div>

    </section>

    <footer id="page_footer">
      Copyright @ 2008 - 2023 Bin Wang
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
    </footer>
    </div>
  </body>
</html>
