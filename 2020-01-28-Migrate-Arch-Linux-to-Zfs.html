<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Migrate Arch Linux to ZFS |  Bin Wang - My Personal Blog</title>
    <link rel="stylesheet" href="/static/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/asciinema-player.css" type="text/css" />

		<!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-52904500-1', 'auto');
      ga('send', 'pageview');
    </script>
		-->

		<!-- Matomo -->
		<script>
		  var _paq = window._paq = window._paq || [];
		  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//matomo.rssbrain.com/";
		    _paq.push(['setTrackerUrl', u+'matomo.php']);
		    _paq.push(['setSiteId', '2']);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<!-- End Matomo Code -->


  </head>

  <body>
    <div id="index_menu">
      
<!--
<div class="index-entry index-index"><a href="/">Home</a></div>
<div class="index-entry index-index"><a href="/snippets">Snippets</a></div>
<div class="index-entry index-index"><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></div>
<div class="index-entry index-index"><a href="/travel.html">Travel</a></div>
<div class="index-entry index-index"><a href="/search.html">Search</a></div>
<div class="index-entry index-index"><a href="/about.html">About</a></div>
<div class="index-entry index-index"><a href="/feed.xml" target="_blank">RSS</a></div>
-->




<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Computer Science)">Computer Science</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Algorithm)">Algorithm</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-05-28-compute.html">任意进制数的补码</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-07-11-quick-sort.html">快排杀手</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Data Processing)">Data Processing</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-04-29-Use-Docker-to-Submit-Spark-Jobs.html">Use Docker to Submit Spark Jobs</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-03-The-Proper-Way-to-Use-Spark-Checkpoint.html">The Proper Way to Use Spark Checkpoint</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-22-Use-Redis-Instead-of-Spark-Streaming-to-Count-Statistics.html">Use Redis Instead of Spark Streaming to Count Statistics</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Digital Life)">Digital Life</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-17-Beautiful-Math-with-MathJex.html">Beautiful Math with MathJex</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-26-Move-from-Twitter-to-Mastodon.html">Move from Twitter to Mastodon</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-02-What-Is-Wrong-abount-Recommendation-System.html">What Is Wrong about Recommendation System</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-15-Use-RSS-and-Kindle-to-Read-News.html">Use RSS and Kindle to Read News</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-23-Build-An-Instant_Messaging-System-without-Censorship-Choose-the-right-technology.html">Matrix: A Self Hosted Instant Messaging Solution with End to End Encryption</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-29-Build-An-Instant_Messaging-System-without-Censorship-Choose-An-Overview-of-Chinese-Internet-Censorship-Strategy.html">An Overview of China's Internet Censorship Strategy</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-09-08-Build-An-Instant-Messaging-System-without-Censorship-Deployment-Options.html">Deploy Matrix for Users in China</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Distributed System)">Distributed System</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-07-29-A-Review-on-Spanner-and-Open-Source-Implementations.html">Spanner and Open Source Implementations</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2019-11-04-Great-Resources-for-Learning-Database-and-Distributed-System.html">Great Resources for Learning Database and Distributed System</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-09-16-Aurora-Database.html">Aurora Database</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-10-06-Understand-Liveness-and-Fairness-in-TLA.html">Understand Liveness and Fairness in TLA+</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">Use TLA+ to Verify Cache Consistency</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-29-Keep-Data-Consistency-During-Database-Migration.html">Keep Data Consistency During Database Migration</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-12-14-Redis-Implementation-for-Cache-and-Database-Consistency.html">Redis Implementation for Cache and Database Consistency</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Distributed System Infrastructure)">Distributed System Infrastructure</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-03-13-Infrastructure-Setup-for-High-Availability.html">Infrastructure Setup for High Availability</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html">Upgrade Kubernetes from 1.23 to 1.24</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-11-04-How-to-Cleanup-Ceph-Filesystem-for-Deleted-Kubernetes-Persistent-Volume.html">How to Cleanup Ceph Filesystem for Deleted Kubernetes Persistent Volume</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Machine Learning)">Machine Learning</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-01-17-Backpropagation-Algorithm.html">Backpropagation Algorithm</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-07-02-My-Recent-Work-About-Neural-Networks.html">My Recent Work About Neural Networks</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-08-Install-BLAS-Library-for-MXNet.html">Install BLAS Library for MXNet</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-05-14-How-to-Put-RNN-Layer-Into-Nueral-Network-Model.html">How to Put RNN Layers Into Neural Network Model</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-06-19-Build-A-Computer-for-Deep-Learning.html">Build A Computer for Deep Learning</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Operating System)">Operating System</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Android)">Android</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-02-11-The-Permission-of-Android-Becomes-A-Bigger-Problem-When-It-Comes-to-Wearable-Devices-and-TV.html">The Permission Management of Android Becomes A Bigger Problem When It Comes to Wearable Devices and TV</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-11-18-Root-And-Optimize-MiBox-3S.html">Root And Optimize MiBox 3S</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Linux)">Linux</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-07-12-port666.html">端口666：毁灭！</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-12-chroot.html">Chroot 简介</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-27-Compile-And-Install-Kernel.html">Compile And Install Kernel</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-05-Backup-My-Dotfiles.html">Backup My Dotfiles</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-28-Comparison-Between-Linux-Desktop-Environments.html">Comparison Between Linux Desktop Environments</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-21-How-Kernel's-Makefile-Specify-Output-Directory.html">How Kernel's Makefile Specify Output Directory</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-10-06-Xbmc-on-Raspberry-Pi-with-Archlinux.html">Xbmc on Raspberry Pi with Archlinux</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-03-08-In-Defence-of-Disabling-Swap.html">In Defence of Disabling Swap</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-01-Build-a-Linux-Virtual-Machine-for-Windows-Apps.html">Build a Linux Virtual Machine for Windows Apps</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-10-22-Full-Disk-Encryption-with-Yubikey.html">Linux Full Disk Encryption with Yubikey</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Tizen)">Tizen</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-02-29-tizen.html">Tizen，加油</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Windows)">Windows</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-11-28-Config-Development-Environment-on-Windows.html">Build a Unix Like Environment on Windows</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(iOS)">iOS</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-11-08-DNS-Resolving-Bug-in-iOS-14.html">DNS Resolving Bug in iOS 14</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-08-20-Apple-In-App-Purchase-Server-to-Server-Notification-Handling-with-Scala-Java.html">Handle Apple In-App-Purchase Server Notification with Scala/Java</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Programming Language)">Programming Language</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(C++)">C++</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-02-11-cplusplus.html">也谈C++</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Erlang)">Erlang</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-07-14-Build-Erlang-the-Rebar-Way.html">Build Erlang the Rebar Way</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-04-27-Why-I-Come-Back-to-Erlang.html">Why I Come Back to Erlang</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-05-16-Experiment-On-Combining-OOP-With-Erlang's-Actor-Model.html">Experiment On Combining OOP With Erlang's Actor Model</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Go)">Go</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-09-01-Notes-On-Go-Scheduler.html">Notes On Go Scheduler</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Javascript)">Javascript</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-01-28-HTML-+-CSS-+-JS-is-Good.html">HTML + CSS + JS is Good</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-02-14-What-is-Wrong-about-HTML.html">What is Wrong about HTML and CSS</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scala)">Scala</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-07-11-Config-sbt-to-Use-Both-Proxy-and-Self-Hosted-Repositories.html">Config sbt to Use Both Proxy and Self Hosted Repositories</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-08-27-Compare-Task-Processing-Approaches-in-Scala.html">Compare Task Processing Approaches in Scala</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-30-A-Boring-JVM-Memory-Profiling-Story.html">A Boring JVM Memory Profiling Story</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scheme)">Scheme</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-01-27-sicp30.html">SICP第三章总结（上）——可变量与环境</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-14-sicp35.html">SICP第三章总结（下）——流编程</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Type System)">Type System</a>
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-08-02-RESTful-API-with-Type-System.html">RESTful API with Type System</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-11-Powerful-Type-System.html">Powerful Type System</a>
        
      

      
        </div>
      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Security)">Security</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-09-02-The-Things-You-Need-to-Know-When-Using-Apache-Sentry.html">The Things You Need to Know When Using Apache Sentry</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-02-12-Setup-SSH-Authentication-with-YubiKey.html">Setup SSH Authentication with YubiKey</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Software Engineering)">Software Engineering</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-18-Call-Program-Like-A-Function.html">Call Program Like A Function</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-04-02-More-About-Program-In-Shell-And-Function.html">More About Program In Shell And Function</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-05-Server-Logic-of-Level-Based-Games.html">Server Logic of Level Based Games</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-12-08-Languages-Should-Have-Database-Built-In.html">Languages Should Have Database Built In</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-04-26-How-About-Translate-IMAP-And-SMTP-Into-HTTP-API.html">How About Translate IMAP And SMTP Into HTTP API?</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-10-18-How-to-Estimate-Max-TPS-from-TPM.html">How to Estimate Max TPS from TPM</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-02-21-Define-Infrastructure-as-Code.html">Define Infrastructure as Code</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-06-30-Why-Big-Companies-Need-to-Adopt-Open-Source.html">Why Big Companies Need to Adopt Open Source</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Storage)">Storage</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-10-Change-Root-File-System-from-Ext4-to-Xfs-on-Archlinux.html">Change Root File System from Ext4 to Xfs on Archlinux</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <div class="index-selected">Migrate Arch Linux to ZFS</div>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-09-19-Personal-ZFS-Offsite-Online-Backup-Solution.html">Personal ZFS Offsite Backup Solution</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Virtualization)">Virtualization</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-16-Create-A-Virtual-Machine-Network.html">Create A Virtual Machine Network</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-01-15-Fedora-Virt-manager-Guest-Connect-to-Host.html">Fedora Virt-manager Guest Connect to Host</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-11-03-Docker-Is-the-One-Scaffolding-to-Rule-Them-All.html">Docker Is the One Scaffolding to Rule Them All</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Essay)">Essay</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Chinese)">Chinese</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2008-12-21-people-mind.html">关于人的思想</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2008-12-22-people-mind2.html">关于人的思想（续）</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-05-31-china.html">览《中国文化要义》有感</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-06-28-bad-guys.html">未来人们怎样对待坏人：读《理想国》杂想</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2011-12-20-life-game.html">好玩的生命游戏</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-05-19-tiandiyouyou.html">念天地之悠悠</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2015-11-04-The-Life-of-Hermit-without-Materially.html">摒弃现代科技的隐士生活</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2016-07-24-%E8%AF%BB-%E9%82%93%E5%B0%8F%E5%B9%B3%E6%97%B6%E4%BB%A3-%E6%9C%89%E6%84%9F.html">读《邓小平时代》有感</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2019-08-15-%E7%94%B1-%E5%BA%9F%E9%9D%92-%E8%BF%99%E4%B8%AA%E7%A7%B0%E5%91%BC%E6%89%80%E6%83%B3%E5%88%B0%E7%9A%84.html">由“废青”这个称呼所想到的</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-08-09-%E7%9B%9B%E5%94%90%E8%AF%97%E4%BA%BA%E5%92%8C%E8%BF%9C%E6%B8%B8.html">盛唐诗人和远游</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(English)">English</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-08-30-Tired-of-Programming.html">Tired of Programming</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2020-07-21-The-Tragic-Talented-Programmer.html">The Tragic Talented Programmer</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Life)">Life</a>
      

      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-03-04-Life-in-Guangzhou.html">Life in Guangzhou</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-05-15-Recent-Works.html">Recent Works</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-07-20-The-Travel-to-Tokyo.html">东京之旅</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2018-01-02-The-Year-of-2017.html">My 2017 Year in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-01-26-My-2020-in-Review.html">My 2020 in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-04-04-%E5%8D%81%E4%B8%89%E5%B9%B4%E5%89%8D%E8%A2%AB%E9%9A%94%E7%A6%BB%E7%9A%84%E7%BB%8F%E5%8E%86.html">十三年前被隔离的经历</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-04-24-A-Travel-to-Montreal.html">A Travel to Montreal</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-01-26-My-2022-in-Review.html">My 2022 in Review</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Projects)">Projects</a>
      

      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Bard)">Bard</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-12-16-The-Thoughts-Behind-Bard-Framework.html">The Thoughts Behind Bard Framework</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2014-12-28-Why-Use-Reflections-to-Write-A-Web-Framework.html">Why Use Reflections to Write A Web Framework</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Blog)">Blog</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-19-my-new-blog.html">My New Blog Website</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-11-20-Comment-And-Search-Are-Available.html">Comment And Search Are Available</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-12-10-Remove-Categories.html">Remove Categories</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2021-10-31-Add-Index-to-My-Blog.html">Add Index to My Blog</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-24-Jekyll-Plugin-to-Load-Asciicast-Locally.html">Jekyll Plugin to Load Asciinema Recordings Locally</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(RSS Brain)">RSS Brain</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-10-29-RSS-Brain-Yet-Another-RSS-Reader-With-More-Features.html">RSS Brain: Yet Another RSS Reader, With More Features</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-12-03-How-RSS-Brain-Shows-Related-Articles.html">How RSS Brain Shows Related Articles</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-index">
      
        <div class="index-intend">
      

      
      <a href="#" onclick="taggleMenu(Scala2grpc)">Scala2grpc</a>
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      
        <div class="index-intend">
      

      
        
          <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3</a>
        
      

      
        </div>
      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-03-29-Comment-Everywhere.html">Comment Everywhere</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script</a>
        
      

      
        </div>
      
    </div>



<div class="index-entry index-index">
      

      
      <a href="#" onclick="taggleMenu(Psychology)">Psychology</a>
      

      
    </div>



<div class="index-entry index-post">
      
        <div class="index-intend">
      

      
        
          <a href="/2012-03-10-xinlixue.html">耶鲁大学心理学导论</a>
        
      

      
        </div>
      
    </div>




<script>

  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)

  const indexMenu = document.getElementById('index_menu');
  const selected = document.getElementsByClassName("index-selected")[0];




  document.addEventListener("DOMContentLoaded", function(event) {
    var scrollpos = localStorage.getItem('menu-scroll-pos');
    console.log(scrollpos);
    if (scrollpos) indexMenu.scrollTo(0, scrollpos);

    if (selected !== undefined) {
      const topOffset = selected.getBoundingClientRect().top;
      if (topOffset < 0 || topOffset > vh) {
        indexMenu.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
      }
    }

  });

  window.onbeforeunload = function(e) {
    localStorage.setItem('menu-scroll-pos', indexMenu.scrollTop );
  };

</script>

    </div>

    <div id="main_content">
    <header id="page_header">
      <div id="menu-button">
          <a href="/index_page.html">&#9776;</a>
      </div>
      <nav id="page_nav">
        <ul>
             <li><a href="/">Home</a></li>
             <li><a href="/snippets">Snippets</a></li>
             <li><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></li>
             <li><a href="/travel.html">Travel</a></li>
             <li><a href="/search.html">Search</a></li>
             <li><a href="/about.html">About</a></li>
             <li><a href="/feed.xml">RSS</a></li>
       </ul>
      </nav>

    </header>



    <section id="page_content">
        <div id="content_table">
  <h3>Table of Contents</h3><ol class="toc"><li><a href="#why-zfs">Why ZFS?</a></li><li><a href="#why-not-freebsd">Why not FreeBSD?</a></li><li><a href="#how-to-migrate-to-zfs">How to Migrate to ZFS?</a></li></ol>
</div>

<div id="article_content" class="">
<article id="post">
  <header>
    <h1>Migrate Arch Linux to ZFS</h1>
    
      <p class="description">Posted on 28 Jan 2020, tagged <code>linux</code><code>zfs</code><code>technology</code><code>freebsd</code></p>
    
  </header>

  <p>I migrated my Arch Linux installation to ZFS recently. This article describes why and how I did that.</p>

<h2 id="why-zfs">Why ZFS?</h2>

<p>ZFS is a very advanced file system that has many handful features. I first knew it many years ago, when I installed FreeNAS for fun. FreeNAS is an OS made for NAS based on FreeBSD. When I played with it, the features of ZFS really shocked me and let me realised what a file system can really do. I will list the features of ZFS that I’m using and not usually avaliable in traditional file systems:</p>

<ul>
  <li>Snapshot: It is really easy to take a snapshot. Because ZFS has copy-on-write feature, so a snapshot doesn’t take any space until you change some content on the file system. It makes backup way much cheaper and easier. This is the biggest feature that let me want to migrate to ZFS.</li>
  <li>RAIDZ: The traditional raid hides the disks from the file system. But for ZFS, you can use raidz which the file system can see the topological of disks so that it can optimize the I/O based on the information.</li>
  <li>Dataset: You can create many datasets in a zfs pool. Which can have different configurations based on the use case.</li>
  <li>L2 Cache: You can use hard disk drives as the file system and add SDD as read or write cache. Which is a very good balance between the storage space, speed and the price.</li>
  <li>Send/Recv: ZFS has commands to send the datasets and snapshots to another dataset or a remote machine. Which makes the offline backup much easier and cheaper.</li>
  <li>Compression: By compression you can save both storage space and make the read/write faster. And you can set different compression algorithm for different use cases.</li>
</ul>

<p>But back then ZFS is not well supported on Linux so I used ext4. Then I had an internship at Redhat and realised ext4 was really an old file system so I migrated to XFS. Until now, my storage configuration is one 128G SSD for the system (root partition). Two 2TB HDDs as a RAID1 array to store all the other data. I backup the system from SDD to HDD regularly in case of the SDD fails. And I don’t have any way to protect me from deleting files by mistake.</p>

<h2 id="why-not-freebsd">Why not FreeBSD?</h2>

<p>It is very nature to use BSD with ZFS since it is supported by deafult. With linux, you must install another kernel module which is not native supported by kernel. And Linus just said “don’t use ZFS” somedays ago. So I was seriously thinking about change my OS to FreeBSD. Compared to Arch Linux, the system is more security because all the packages are native supported by the FreeBSD developer and the port system also has a lot of softwares. But finally something stops me from migrating to FreeBSD:</p>

<ul>
  <li>The game support. Last year, game on Linux finally breaks out because of the Poton on Steam. Though I don’t play games a lot, it’s still a pity to have no game to play.</li>
  <li>FreeBSD starts using ZFS on Linux as the upstream of ZFS. So with the bigger community, ZFS on Linux may has better support and more features in the future.</li>
  <li>It’s a risk to migrate to a new system. Arch Linux works great for me for a long time. If the new installation doesn’t work, it’s time consuming to recover the system. And it says FreeBSD doesn’t have a good support on Nvidia graphic card, which I’m currently using.</li>
  <li>FreeBSD’s Jails are much mature than Containers on Linux. And I really hate Docker for its deamon running as root. Docker also has bad community reputation (e.g. changing its community version’s name). Rkt from Core OS is much better but both Core OS and Rkt are dead after the acquire of Redhat. But finally I found Podman. So I can compromise at this point. Containers also has bigger community. For example, the Nextcloud I’m using has official image so I don’t need to build my own one.</li>
</ul>

<h2 id="how-to-migrate-to-zfs">How to Migrate to ZFS?</h2>

<h3 id="1-backup-the-data">1. Backup the Data</h3>

<p>My disks and partitions are like this before the migration:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>- SDD
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  + / (root)
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  + /boot
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>- RAID1 (hdd1, hdd2)
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  + /data
</pre></div>
</div>
</div>

<p>I only backup my data disks because I will not use my system disk for the ZFS pool at the creation time. I will use it as cache which can be added later. An important note is to <strong>use <code>tar</code> or <code>rsync</code> to backup data</strong>. Don’t use <code>cp</code>, it will break the file permissions and links.</p>

<h3 id="2-install-zfs-kernel-modules-and-utils">2. Install ZFS Kernel Modules and Utils</h3>

<p>Follow the <a href="https://wiki.archlinux.org/index.php/ZFS#Installation">Arch Linux’s ZFS wiki</a> to do that. I also enabled the <a href="https://wiki.archlinux.org/index.php/Unofficial_user_repositories#archzfs">ArchZFS repo</a> so I don’t need to build it from AUR. This repo is signed so it is more secure.</p>

<h3 id="3-create-zfs-pool-and-dataset">3. Create ZFS Pool and Dataset</h3>

<p>I added another HDD for the ZFS pool in order to make a raidz1 pool (like raid5), which doubles the current storage space with raid1. Then create a dataset for the new root partition. The dataset has native encryption and compression enabled.</p>

<h3 id="4-mount-the-root-dataset-and-copy-the-root-partition">4. Mount the Root Dataset and Copy the Root Partition</h3>

<p>Temparory mount the root dataset to <code>/mnt</code>. Then follow the Arch Linux wiki about <a href="https://wiki.archlinux.org/index.php/Install_Arch_Linux_from_existing_Linux#From_a_host_running_Arch_Linux">installing from a host running Arch Linux</a>.</p>

<h3 id="5-make-new-boot-image-and-config-bootloader">5. Make New Boot Image and Config Bootloader</h3>

<p>I was trying to install boot partition into the ZFS but failed after many attemps. At last I decide just use the old boot partition and sync them to ZFS as backup.</p>

<p>So follow <a href="https://wiki.archlinux.org/index.php/Install_Arch_Linux_on_ZFS">install Arch Linux on ZFS wiki</a>. After the regular installation, add <code>zfs</code> in <code>/etc/mkinitcpio.conf</code> <code>HOOKS</code>:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>HOOKS=(base udev autodetect modconf block keyboard zfs filesystems)
</pre></div>
</div>
</div>

<p>Then using <code>mkinitcpio -p</code> to make new boot image. (You may want to backup old images <code>/boot/initramfs-linux.img</code> and <code>/boot/vmlinuz-linux</code> before this step).</p>

<p>Then in <code>/boot/grub/grub.cfg</code>, change the root filesystem to zfs, like this (in the menuentry):</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>linux   /vmlinuz-linux root=ZFS=zroot/root rw  loglevel=3 quiet
</pre></div>
</div>
</div>

<p>Which <code>zroot/root</code> is the root dataset.</p>

<h3 id="6-config-mount-points">6. Config Mount Points</h3>

<p>Reconfig the root dataset’s mount point to <code>/</code> and add the configuration in <code>/etc/fstab</code>:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>zroot/root / zfs defaults,noatime 0 0
</pre></div>
</div>
</div>

<p>Don’t forget to set the auto import:</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>systemctl enable zfs-import-cache
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>zpool set cachefile=/etc/zfs/zpool.cache &lt;pool&gt;
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>systemctl enable zfs-mount
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>systemctl enable zfs.target
</pre></div>
</div>
</div>

<p>Also need to input the passphrase if using encryption. Follow the <a href="https://wiki.archlinux.org/index.php/ZFS">Arch Linux’s ZFS wiki</a> to do that.</p>

<h3 id="7-restart-and-config-new-system">7. Restart and Config New System</h3>

<p>After the reboot, the system should boot into the new root. Then cleanup the old root partition and add it as the cache of the pool: <code>zpool add -f zroot cache &lt;partition-uuid&gt;</code>. Then create other datasets and move back all the old data.</p>

<p>Now I can make different datasets for different purpose. For example, make a dataset for nextcloud container’s storage. Make a highly compressed dataset for backup files from other machine, and so on.</p>

<p>After the migration, the first boot is slower than before because the root system is migrated to HDD. But the most useful files will be cached into SSD and it feels the same as before after a while. Now I’m very happy with the current setup and super excited about all the advanced features of ZFS! Happy hacking!</p>

</article>

<footer id="post_footer">
  <table><tr>
    
      <td id="prev"><a href="/2019-11-04-Great-Resources-for-Learning-Database-and-Distributed-System.html">Prev: Great Resources for Learning Database and Distributed System</a></td>
    
    
      <td id="next"><a href="/2020-07-11-Powerful-Type-System.html" id="next">Next: Powerful Type System</a></td>
    
  </tr></table>
</footer>

<section id="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'crazy-hot-ice'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



<!-- MathJax -->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

</div>

    </section>

    <footer id="page_footer">
      Copyright @ 2008 - 2023 Bin Wang
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
    </footer>
    </div>
  </body>
</html>
