<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Scala 2 Macro Tutorial |  Bin Wang - My Personal Blog</title>
    <link rel="stylesheet" href="/static/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/asciinema-player.css" type="text/css" />

		<!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-52904500-1', 'auto');
      ga('send', 'pageview');
    </script>
		-->

		<!-- Matomo -->
		<script>
		  var _paq = window._paq = window._paq || [];
		  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//matomo.rssbrain.com/";
		    _paq.push(['setTrackerUrl', u+'matomo.php']);
		    _paq.push(['setSiteId', '2']);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<!-- End Matomo Code -->


  </head>

  <body>
    
    <div id="index_menu">
      
<!--
<div class="index-entry index-index"><a href="/">Home</a></div>
<div class="index-entry index-index"><a href="/snippets">Snippets</a></div>
<div class="index-entry index-index"><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></div>
<div class="index-entry index-index"><a href="/travel.html">Travel</a></div>
<div class="index-entry index-index"><a href="/search.html">Search</a></div>
<div class="index-entry index-index"><a href="/about.html">About</a></div>
<div class="index-entry index-index"><a href="/feed.xml" target="_blank">RSS</a></div>
-->




  

    <div class="index-entry index-index">
      
      Computer Science
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Algorithm
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-05-28-compute.html">任意进制数的补码 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-07-11-quick-sort.html">快排杀手 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-10-18-How-to-Estimate-Max-TPS-from-TPM.html">How to Estimate Max TPS from TPM <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Data Processing
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-04-29-Use-Docker-to-Submit-Spark-Jobs.html">Use Docker to Submit Spark Jobs <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-03-The-Proper-Way-to-Use-Spark-Checkpoint.html">The Proper Way to Use Spark Checkpoint <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-22-Use-Redis-Instead-of-Spark-Streaming-to-Count-Statistics.html">Use Redis Instead of Spark Streaming to Count Statistics <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Digital Life
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-26-Move-from-Twitter-to-Mastodon.html">Move from Twitter to Mastodon <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-02-What-Is-Wrong-abount-Recommendation-System.html">What Is Wrong about Recommendation System <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-15-Use-RSS-and-Kindle-to-Read-News.html">Use RSS and Kindle to Read News <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-23-Build-An-Instant_Messaging-System-without-Censorship-Choose-the-right-technology.html">Matrix: A Self Hosted Instant Messaging Solution with End to End Encryption <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-29-Build-An-Instant_Messaging-System-without-Censorship-Choose-An-Overview-of-Chinese-Internet-Censorship-Strategy.html">An Overview of China's Internet Censorship Strategy <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-09-08-Build-An-Instant-Messaging-System-without-Censorship-Deployment-Options.html">Deploy Matrix for Users in China <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Distributed System
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-07-29-A-Review-on-Spanner-and-Open-Source-Implementations.html">Spanner and Open Source Implementations <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2019-11-04-Great-Resources-for-Learning-Database-and-Distributed-System.html">Great Resources for Learning Database and Distributed System <span class="publish-year">(2019)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-09-16-Aurora-Database.html">Aurora Database <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-10-06-Understand-Liveness-and-Fairness-in-TLA.html">Understand Liveness and Fairness in TLA+ <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-02-Use-TLA+-to-Verify-Cache-Consistency.html">Use TLA+ to Verify Cache Consistency <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-29-Keep-Data-Consistency-During-Database-Migration.html">Keep Data Consistency During Database Migration <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-12-14-Redis-Implementation-for-Cache-and-Database-Consistency.html">Redis Implementation for Cache and Database Consistency <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Distributed System Infrastructure
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-03-13-Infrastructure-Setup-for-High-Availability.html">Infrastructure Setup for High Availability <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-05-22-Upgrade-Kubernetes-from-1.23-to-1.24.html">Upgrade Kubernetes from 1.23 to 1.24 <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-04-How-to-Cleanup-Ceph-Filesystem-for-Deleted-Kubernetes-Persistent-Volume.html">How to Cleanup Ceph Filesystem for Deleted Kubernetes Persistent Volume <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-28-Introduce-K3s-CephFS-and-MetalLB-to-My-High-Avaliable-Cluster.html">Introduce K3s, CephFS and MetalLB to My High Avaliable Cluster <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Machine Learning
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-01-17-Backpropagation-Algorithm.html">Backpropagation Algorithm <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-07-02-My-Recent-Work-About-Neural-Networks.html">My Recent Work About Neural Networks <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-08-Install-BLAS-Library-for-MXNet.html">Install BLAS Library for MXNet <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-05-14-How-to-Put-RNN-Layer-Into-Nueral-Network-Model.html">How to Put RNN Layers Into Neural Network Model <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-06-19-Build-A-Computer-for-Deep-Learning.html">Build A Computer for Deep Learning <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Operating System
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Android
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-02-11-The-Permission-of-Android-Becomes-A-Bigger-Problem-When-It-Comes-to-Wearable-Devices-and-TV.html">The Permission Management of Android Becomes A Bigger Problem When It Comes to Wearable Devices and TV <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-11-18-Root-And-Optimize-MiBox-3S.html">Root And Optimize MiBox 3S <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Linux
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-07-12-port666.html">端口666：毁灭！ <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-12-chroot.html">Chroot 简介 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-27-Compile-And-Install-Kernel.html">Compile And Install Kernel <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-05-Backup-My-Dotfiles.html">Backup My Dotfiles <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-28-Comparison-Between-Linux-Desktop-Environments.html">Comparison Between Linux Desktop Environments <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-21-How-Kernel's-Makefile-Specify-Output-Directory.html">How Kernel's Makefile Specify Output Directory <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-10-06-Xbmc-on-Raspberry-Pi-with-Archlinux.html">Xbmc on Raspberry Pi with Archlinux <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-02-12-Setup-SSH-Authentication-with-YubiKey.html">Setup SSH Authentication with YubiKey <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-03-08-In-Defence-of-Disabling-Swap.html">In Defence of Disabling Swap <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-01-Build-a-Linux-Virtual-Machine-for-Windows-Apps.html">Build a Linux Virtual Machine for Windows Apps <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-10-22-Full-Disk-Encryption-with-Yubikey.html">Linux Full Disk Encryption with Yubikey <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Tizen
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-02-29-tizen.html">Tizen，加油 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Windows
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-11-28-Config-Development-Environment-on-Windows.html">Build a Unix Like Environment on Windows <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      iOS
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-11-08-DNS-Resolving-Bug-in-iOS-14.html">DNS Resolving Bug in iOS 14 <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-08-20-Apple-In-App-Purchase-Server-to-Server-Notification-Handling-with-Scala-Java.html">Handle Apple In-App-Purchase Server Notification with Scala/Java <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Programming Language
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      C++
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-02-11-cplusplus.html">也谈C++ <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Erlang
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-07-14-Build-Erlang-the-Rebar-Way.html">Build Erlang the Rebar Way <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-04-27-Why-I-Come-Back-to-Erlang.html">Why I Come Back to Erlang <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-05-16-Experiment-On-Combining-OOP-With-Erlang's-Actor-Model.html">Experiment On Combining OOP With Erlang's Actor Model <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Go
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-09-01-Notes-On-Go-Scheduler.html">Notes On Go Scheduler <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Javascript
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-17-Beautiful-Math-with-MathJex.html">Beautiful Math with MathJex <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-01-28-HTML-+-CSS-+-JS-is-Good.html">HTML + CSS + JS is Good <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-02-14-What-is-Wrong-about-HTML.html">What is Wrong about HTML and CSS <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scala
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-07-11-Config-sbt-to-Use-Both-Proxy-and-Self-Hosted-Repositories.html">Config sbt to Use Both Proxy and Self Hosted Repositories <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-08-27-Compare-Task-Processing-Approaches-in-Scala.html">Compare Task Processing Approaches in Scala <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-30-A-Boring-JVM-Memory-Profiling-Story.html">A Boring JVM Memory Profiling Story <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <div class="index-selected">Scala 2 Macro Tutorial <span class="publish-year">(2023)</span></div>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scheme
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-01-27-sicp30.html">SICP第三章总结（上）——可变量与环境 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-14-sicp35.html">SICP第三章总结（下）——流编程 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Type System
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-08-02-RESTful-API-with-Type-System.html">RESTful API with Type System <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-11-Powerful-Type-System.html">Powerful Type System <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Software Engineering
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-18-Call-Program-Like-A-Function.html">Call Program Like A Function <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-04-02-More-About-Program-In-Shell-And-Function.html">More About Program In Shell And Function <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-05-Server-Logic-of-Level-Based-Games.html">Server Logic of Level Based Games <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-12-08-Languages-Should-Have-Database-Built-In.html">Languages Should Have Database Built In <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-04-26-How-About-Translate-IMAP-And-SMTP-Into-HTTP-API.html">How About Translate IMAP And SMTP Into HTTP API? <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-09-02-The-Things-You-Need-to-Know-When-Using-Apache-Sentry.html">The Things You Need to Know When Using Apache Sentry <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-02-21-Define-Infrastructure-as-Code.html">Define Infrastructure as Code <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-06-30-Why-Big-Companies-Need-to-Adopt-Open-Source.html">Why Big Companies Need to Adopt Open Source <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Storage
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-10-Change-Root-File-System-from-Ext4-to-Xfs-on-Archlinux.html">Change Root File System from Ext4 to Xfs on Archlinux <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-01-28-Migrate-Arch-Linux-to-Zfs.html">Migrate Arch Linux to ZFS <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-09-19-Personal-ZFS-Offsite-Online-Backup-Solution.html">Personal ZFS Offsite Backup Solution <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-12-14-ZFS-Profiling-on-Arch-Linux.html">ZFS Profiling on Arch Linux <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Virtualization
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-16-Create-A-Virtual-Machine-Network.html">Create A Virtual Machine Network <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-01-15-Fedora-Virt-manager-Guest-Connect-to-Host.html">Fedora Virt-manager Guest Connect to Host <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-11-03-Docker-Is-the-One-Scaffolding-to-Rule-Them-All.html">Docker Is the One Scaffolding to Rule Them All <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  

    <div class="index-entry index-index">
      
      Life
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-03-04-Life-in-Guangzhou.html">Life in Guangzhou <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-05-15-Recent-Works.html">Recent Works <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-07-20-The-Travel-to-Tokyo.html">东京之旅 <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2018-01-02-The-Year-of-2017.html">My 2017 Year in Review <span class="publish-year">(2018)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-01-26-My-2020-in-Review.html">My 2020 in Review <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-04-04-%E5%8D%81%E4%B8%89%E5%B9%B4%E5%89%8D%E8%A2%AB%E9%9A%94%E7%A6%BB%E7%9A%84%E7%BB%8F%E5%8E%86.html">十三年前被隔离的经历 <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-04-24-A-Travel-to-Montreal.html">A Travel to Montreal <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-01-26-My-2022-in-Review.html">My 2022 in Review <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Projects
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Bard
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-12-16-The-Thoughts-Behind-Bard-Framework.html">The Thoughts Behind Bard Framework <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2014-12-28-Why-Use-Reflections-to-Write-A-Web-Framework.html">Why Use Reflections to Write A Web Framework <span class="publish-year">(2014)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Blog
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-19-my-new-blog.html">My New Blog Website <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-11-20-Comment-And-Search-Are-Available.html">Comment And Search Are Available <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-12-10-Remove-Categories.html">Remove Categories <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2021-10-31-Add-Index-to-My-Blog.html">Add Index to My Blog <span class="publish-year">(2021)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-24-Jekyll-Plugin-to-Load-Asciicast-Locally.html">Jekyll Plugin to Load Asciinema Recordings Locally <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-10-Index-Sidebar-on-My-Blog.html">Add Index Sidebar to My Blog <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      RSS Brain
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-10-29-RSS-Brain-Yet-Another-RSS-Reader-With-More-Features.html">RSS Brain: Yet Another RSS Reader, With More Features <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-12-03-How-RSS-Brain-Shows-Related-Articles.html">How RSS Brain Shows Related Articles <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-11-14-Update-On-RSS-Brain-to-Find-Related-Articles-with-Machine-Learning.html">Update on RSS Brain to Find Related Articles with Machine Learning <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Scala2grpc
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2022-05-02-A-Library-to-Make-It-Easier-to-Use-Scala-with-GRPC.html">A Library to Make It Easier to Use Scala with gRPC <span class="publish-year">(2022)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2023-09-23-Migrate-Scala2Grpc-to-Cats-Effect-3.html">Migrate Scala2grpc to Cats Effect 3 <span class="publish-year">(2023)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-03-29-Comment-Everywhere.html">Comment Everywhere <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-11-16-Fetch-Popular-Erlang-Modules-by-Coffee-Script.html">Fetch Popular Erlang Modules by Coffee Script <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Psychology
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-03-10-xinlixue.html">耶鲁大学心理学导论 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  




  

    <div class="index-entry index-index">
      
      Thoughts
      

    </div>

  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      Chinese
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2008-12-21-people-mind.html">关于人的思想 <span class="publish-year">(2008)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2008-12-22-people-mind2.html">关于人的思想（续） <span class="publish-year">(2008)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-05-31-china.html">览《中国文化要义》有感 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-06-28-bad-guys.html">未来人们怎样对待坏人：读《理想国》杂想 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2011-12-20-life-game.html">好玩的生命游戏 <span class="publish-year">(2011)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2012-05-19-tiandiyouyou.html">念天地之悠悠 <span class="publish-year">(2012)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2015-11-04-The-Life-of-Hermit-without-Materially.html">摒弃现代科技的隐士生活 <span class="publish-year">(2015)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2016-07-24-%E8%AF%BB-%E9%82%93%E5%B0%8F%E5%B9%B3%E6%97%B6%E4%BB%A3-%E6%9C%89%E6%84%9F.html">读《邓小平时代》有感 <span class="publish-year">(2016)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2019-08-15-%E7%94%B1-%E5%BA%9F%E9%9D%92-%E8%BF%99%E4%B8%AA%E7%A7%B0%E5%91%BC%E6%89%80%E6%83%B3%E5%88%B0%E7%9A%84.html">由“废青”这个称呼所想到的 <span class="publish-year">(2019)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-08-09-%E7%9B%9B%E5%94%90%E8%AF%97%E4%BA%BA%E5%92%8C%E8%BF%9C%E6%B8%B8.html">盛唐诗人和远游 <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  

    <div class="index-entry index-index">
      
      English
      

    </div>

  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2013-08-30-Tired-of-Programming.html">Tired of Programming <span class="publish-year">(2013)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  




  
    <div class="index-intend">
  
    <div class="index-intend">
  

    <div class="index-entry index-post">
      
        
        <a href="/2020-07-21-The-Tragic-Talented-Programmer.html">The Tragic Talented Programmer <span class="publish-year">(2020)</span></a>
        
      

    </div>

  
    </div>
  
    </div>
  





<script>

  const isIndexPage = false;

  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)
  const indexMenu = document.getElementById('index_menu') || document.getElementById('index_menu_page');


  document.addEventListener("DOMContentLoaded", function(event) {

    if (isIndexPage) {
      var targetHref = new URL(document.referrer).pathname;
      console.log(targetHref);

      document.querySelectorAll('a').forEach(function(anchorTag) {
        // Check if the href attribute matches the targetHref
        if (anchorTag.getAttribute('href') === targetHref) {
           var newDiv = document.createElement('div');
           newDiv.classList.add('index-selected');
           // Copy the content of the <a> tag to the new <div>
           newDiv.innerHTML = anchorTag.innerHTML;
           // Replace the <a> tag with the new <div> element
           anchorTag.parentNode.replaceChild(newDiv, anchorTag);
        }
      });

    }

    var selected = document.getElementsByClassName("index-selected")[0];

    if (!isIndexPage) {
      var scrollpos = localStorage.getItem('menu-scroll-pos');
      console.log(scrollpos);
      if (scrollpos) indexMenu.scrollTo(0, scrollpos);
    }

    if (selected !== undefined) {
      const topOffset = selected.getBoundingClientRect().top;
      if (topOffset < 0 || topOffset > vh) {
        if (isIndexPage) {
          window.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
        } else {
          indexMenu.scrollBy({left: 0, top: topOffset - vh / 3.0, behavior: "smooth"});
        }
      }
    }

  });

  window.onbeforeunload = function(e) {
    if (!isIndexPage) {
      localStorage.setItem('menu-scroll-pos', indexMenu.scrollTop );
    }
  };

</script>

    </div>
    

    <div id="main_content">
    <header id="page_header">
      <div id="menu-button">
          <a href="/index_page.html">&#9776;</a>
      </div>
      <nav id="page_nav">
        <ul>
             <li><a href="/">Home</a></li>
             <li><a href="/snippets">Snippets</a></li>
             <li><a href="https://www.goodreads.com/review/list/103708630-bin?shelf=read" target="_blank">Read</a></li>
             <li><a href="/travel.html">Travel</a></li>
             <li><a href="/search.html">Search</a></li>
             <li><a href="/about.html">About</a></li>
             <li><a href="/feed.xml">RSS</a></li>
       </ul>
      </nav>

    </header>



    <section id="page_content">
        <div id="content_table">
  <h3>Table of Contents</h3><ol class="toc"><li><a href="#1-what-is-macro">1. What is Macro</a></li><li><a href="#2-how-to-write-a-macro">2. How to Write a Macro</a></li><li><a href="#3-project-setup-with-sbt">3. Project Setup with SBT</a></li><li><a href="#4-how-to-read-ast">4. How to Read AST</a></li><li><a href="#5-how-to-generate-tree">5. How to Generate Tree</a></li></ol>
</div>

<div id="article_content" class="">
<article id="post">
  <header>
    <h1>Scala 2 Macro Tutorial</h1>
    
      <p class="description">Posted on 29 Dec 2023, tagged <code>Scala</code><code>macro</code><code>meta programming</code><code>AOP</code></p>
    
  </header>

  <p>Macros are powerful but complex. Especially when the language itself like Scala is already complex. The lack of learning resource and documents makes it more so. In this article, I’ll write down some of my learnings and hopefully it can help someone else who is new to it as well. I’ll keep the examples small and simple so it’s easier to understand. Since I’m still learning it, I may continue to update this article on the way, or write a new article if there is a big topic. Either way, I’ll make notes here so you know there are updates.</p>

<p>Scala’s macro syntax and APIs can be different from version to version. Especially it’s almost completely redesigned in Scala 3. This article only targets Scala 2 and I’ve only tested the examples on Scala 2.13.</p>

<h2 id="1-what-is-macro">1. What is Macro</h2>

<p>The basic idea of macro is to modify the code with code. For example, let’s imagine a macro <code class="language-plaintext highlighter-rouge">plusToMinus</code> that modifies all the plus operations of integers to minus:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plusToMinus</span> <span class="o">{</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">}</span>
</code></pre></div></div>

<p>This will be compiled to <code class="language-plaintext highlighter-rouge">1 - 1</code> and ends up as <code class="language-plaintext highlighter-rouge">0</code>.</p>

<p>Of cause this is not a practical example and not all the languages’ macro system can do it. But this demonstrate what macros can do where normal code cannot. Here is a more practical example: when we log something in different log levels, the API usually looks like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">v</span> <span class="k">=</span> <span class="o">...</span>
<span class="nv">logger</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"This is a info log. Value: $v"</span><span class="o">)</span>
<span class="nv">logger</span><span class="o">.</span><span class="py">warn</span><span class="o">(</span><span class="n">s</span><span class="s">"This is a warning. Value: $v"</span><span class="o">)</span>
</code></pre></div></div>

<p>However, with this kind of interface, the string <code class="language-plaintext highlighter-rouge">s"..."</code> need to be computed before passed in to the method, which is a waste since not all the strings need to be logged based on the log level configuration. Especially when <code class="language-plaintext highlighter-rouge">v.toString</code> needs a lot of resource to compute. So in language like Java, the values are usually passed in as separate parameters:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">v</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"This is a info log. Value: {}"</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"This is a warning. Value: {}"</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
</code></pre></div></div>

<p>Even though it resolves the problem, the interface is kind of awful. And not all the users know this kind of details so they may still just construct the string directly instead of pass in separate parameters. However, with the help of macros, you can still keep the logger interface in the intuitive way. As macros, <code class="language-plaintext highlighter-rouge">logger.info</code> and <code class="language-plaintext highlighter-rouge">logger.warn</code> can modify the code directly during the compile time. For example, it can modify the code like this:</p>

<p>From</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">logger</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"This is a info log. Value: $v"</span><span class="o">)</span>
</code></pre></div></div>

<p>To</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">if</span> <span class="o">(</span><span class="n">loggerLevel</span> <span class="o">&gt;=</span> <span class="nc">INFO</span><span class="o">)</span> <span class="o">{</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"This is a info log. Value: $v"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>So that the actually string computation is not done unless log level is configured to print it.</p>

<h2 id="2-how-to-write-a-macro">2. How to Write a Macro</h2>

<p>Different languages have different syntaxes to write a macro. On the simpler side, macros in C can only do text substitution. On the powerful side, Lisp languages can modify the AST (abstract syntax tree) very easily because the code itself is written as a tree structure. The macro in Scala is on the powerful side since it is able to modify the AST even though it may not be as intuitive as Lisp. There are multiple ways to do it. But essentially, the process it to take the current AST as input and output a new AST. The APIs of reading AST input is very similar to reflection APIs (and in fact, sometimes they share some APIs). Generating a new AST part is more complex. In the following sections, we will walk through how to setup a SBT project to write macros, how to read an AST and how to generate a new AST.</p>

<h2 id="3-project-setup-with-sbt">3. Project Setup with SBT</h2>

<p>In Scala, the implementation of macros and the use of macros need to be compiled separately. So if you are using SBT, they need to be in different sub projects. Here is an example of <code class="language-plaintext highlighter-rouge">build.sbt</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">lazy</span> <span class="k">val</span> <span class="nv">root</span> <span class="k">=</span> <span class="o">(</span><span class="n">project</span> <span class="n">in</span> <span class="nf">file</span><span class="o">(</span><span class="s">"."</span><span class="o">))</span>
  <span class="o">.</span><span class="py">aggregate</span><span class="o">(</span><span class="n">core</span><span class="o">,</span> <span class="n">coretest</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span>
    <span class="n">name</span> <span class="o">:=</span> <span class="s">"archmage"</span>
  <span class="o">)</span>

<span class="k">lazy</span> <span class="k">val</span> <span class="nv">core</span> <span class="k">=</span> <span class="o">(</span><span class="n">project</span> <span class="n">in</span> <span class="nf">file</span><span class="o">(</span><span class="s">"core"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span>
    <span class="n">name</span> <span class="o">:=</span> <span class="s">"core"</span><span class="o">,</span>
    <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
      <span class="s">"org.scala-lang"</span> <span class="o">%</span> <span class="s">"scala-reflect"</span> <span class="o">%</span> <span class="s">"2.13.12"</span><span class="o">,</span>
      <span class="s">"co.fs2"</span> <span class="o">%%</span> <span class="s">"fs2-core"</span> <span class="o">%</span> <span class="s">"3.9.3"</span><span class="o">,</span>
    <span class="o">)</span>
  <span class="o">)</span>

<span class="k">lazy</span> <span class="k">val</span> <span class="nv">coretest</span> <span class="k">=</span> <span class="o">(</span><span class="n">project</span> <span class="n">in</span> <span class="nf">file</span><span class="o">(</span><span class="s">"coretest"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span>
    <span class="n">name</span> <span class="o">:=</span> <span class="s">"core-test"</span>
  <span class="o">)</span> <span class="n">dependsOn</span> <span class="n">core</span>
</code></pre></div></div>

<p>It creates two sub projects. You can implement the macros in <code class="language-plaintext highlighter-rouge">core</code> and use them in <code class="language-plaintext highlighter-rouge">coretest</code>.</p>

<p>If you want to debug the generated code from macros, add debug flags to Scala like this in <code class="language-plaintext highlighter-rouge">build.sbt</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ThisBuild</span> <span class="o">/</span> <span class="n">scalacOptions</span> <span class="o">+=</span> <span class="s">"-Ymacro-debug-lite"</span>
</code></pre></div></div>

<h2 id="4-how-to-read-ast">4. How to Read AST</h2>

<h3 id="41-read-macro-parameters">4.1 Read macro parameters:</h3>

<p>Here is the basic syntax of a macro. First, define a macro implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nf">println</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">tree</span><span class="o">.</span><span class="py">symbol</span><span class="o">.</span><span class="py">fullName</span><span class="o">)</span>
  <span class="n">s</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The first parameter <code class="language-plaintext highlighter-rouge">c: blackbox.Context</code> is a must have for a macro implementation. There is also a <code class="language-plaintext highlighter-rouge">whitebox.Context</code> but we will not cover it in this article. More details about whitebox can be found in <a href="https://docs.scala-lang.org/overviews/macros/blackbox-whitebox.html">the official document</a>.</p>

<p>The remaining parameters of the implementation method are parameters for the macro. For example, if you want to take a parameter of type <code class="language-plaintext highlighter-rouge">String</code> for the macro, then the implementation of macro will take <code class="language-plaintext highlighter-rouge">c.Expr[String]</code> as a parameter, which <code class="language-plaintext highlighter-rouge">c.Expr[String]</code> is the tree representation of the macro’s <code class="language-plaintext highlighter-rouge">String</code> parameter. The same applies to the return type of the macro. You can also  use <code class="language-plaintext highlighter-rouge">c.Tree</code> instead of <code class="language-plaintext highlighter-rouge">c.Expr[T]</code>. They can be converted between each other, which we will see in section 4.4.</p>

<p>This example prints out the variable name of the passed in parameter and return the parameter without modification. Note that the printing happens at compile time since that’s when the implementation of the macro is ran. Only the returned tree or <code class="language-plaintext highlighter-rouge">c.Expr</code> is used at run time. So this macro is not doing anything useful, it’s just a demo of how to read the input tree.</p>

<p>Once we have the macro implementation, we can define the macro like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroTest</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>
</code></pre></div></div>

<p>Then we can use it in another (sub) project so that the compilation is separated:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="s">"abc"</span>
<span class="nf">macroTest</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
</code></pre></div></div>

<p>It will print out the full name of <code class="language-plaintext highlighter-rouge">a</code> like this during compilation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>me.binwang.archmage.coretest.MethodMetaTest.a
</code></pre></div></div>

<p>The API of <code class="language-plaintext highlighter-rouge">c.Expr</code> is very similar as reflection API. You can experiment with it by print out different things from it and see what you can get.</p>

<h3 id="42-read-type-parameters">4.2 Read type parameters:</h3>

<p>Macro can also take generic type as parameters. The example below takes a parameter of any type and print out its type at compile time.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c.WeakTypeTag</span><span class="o">](</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span> <span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nf">println</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span>
  <span class="n">s</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">s</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</code></pre></div></div>

<p>Which can be used like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">macroTest</span><span class="o">(</span><span class="s">"abc"</span><span class="o">)</span>
<span class="nf">macroTest</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
</code></pre></div></div>

<p>The output during compilation will be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>String
Int
</code></pre></div></div>

<h3 id="43-read-implicit-parameters">4.3 Read implicit parameters:</h3>

<p>Macro can have implicit parameters, but the macro implementation shouldn’t define them as implicit. Otherwise Scala compiler will give confusing errors. See <a href="https://github.com/scala/bug/issues/6494">this issue</a> for more details.</p>

<p>In the following example, <code class="language-plaintext highlighter-rouge">macroTest</code> takes an implicit double variable and return it as the new generated tree:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">])(</span><span class="n">num</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span> <span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Name of implicit num: ${num.tree.symbol.fullName}"</span><span class="o">)</span>
  <span class="n">num</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">num</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>
</code></pre></div></div>

<p>Note how <code class="language-plaintext highlighter-rouge">num</code> in <code class="language-plaintext highlighter-rouge">macroImpl</code> doesn’t have any <code class="language-plaintext highlighter-rouge">implicit</code> definition.</p>

<p>Then the test code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">val</span> <span class="nv">num</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="nf">println</span><span class="o">(</span><span class="nf">macroTest</span><span class="o">(</span><span class="s">"abc"</span><span class="o">))</span>
</code></pre></div></div>

<p>It will print this during the compile time:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name of implicit num: me.binwang.archmage.coretest.MethodMetaTest.num
</code></pre></div></div>

<p>And this during the run time:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.1
</code></pre></div></div>

<h3 id="44-read-code-block-with-by-name-parameter">4.4 Read code block with by-name parameter</h3>

<p>Macros can also take <a href="https://docs.scala-lang.org/tour/by-name-parameters.html">by-name parameter</a>. However, it needs to use <code class="language-plaintext highlighter-rouge">c.Tree</code> instead of <code class="language-plaintext highlighter-rouge">c.Expr</code> as parameter in the macro implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Tree</span><span class="o">)</span> <span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
  <span class="nv">c</span><span class="o">.</span><span class="py">Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">s</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>
</code></pre></div></div>

<p>See how <code class="language-plaintext highlighter-rouge">c.Tree</code> is converted to <code class="language-plaintext highlighter-rouge">c.Expr</code>. You can also convert <code class="language-plaintext highlighter-rouge">c.Expr</code> to <code class="language-plaintext highlighter-rouge">c.Tree</code> by using the <code class="language-plaintext highlighter-rouge">.tree</code> method, which we’ve seen in the examples above.</p>

<p>Test it with this code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">macroTest</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="s">"a"</span>
  <span class="k">val</span> <span class="nv">b</span> <span class="k">=</span> <span class="s">"b"</span>
  <span class="nf">println</span><span class="o">(</span><span class="s">"hello!"</span><span class="o">)</span>
  <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It will print out this during compile time:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  val a: String = "a";
  val b: String = "b";
  scala.Predef.println("hello!");
  a.+(b)
}
</code></pre></div></div>

<h3 id="45-use-quasiquotes">4.5 Use Quasiquotes</h3>

<p><a href="https://docs.scala-lang.org/overviews/quasiquotes/intro.html">Quasiquotes</a>, or <code class="language-plaintext highlighter-rouge">q"..."</code>, is a very powerful syntax for Scala macro. It can both match a tree and generate a tree. For example, the following code can match different parts of a if else clause to <code class="language-plaintext highlighter-rouge">c.Tree</code> variables:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Tree</span><span class="o">)</span><span class="k">:</span> <span class="kt">c.Tree</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">c.universe._</span>
  <span class="k">val</span> <span class="nv">q</span><span class="s">"if ($cond) $thenp else $elsep"</span> <span class="k">=</span> <span class="n">s</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">cond</span><span class="o">)</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">thenp</span><span class="o">)</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">elsep</span><span class="o">)</span>
  <span class="n">q</span><span class="s">"$cond"</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">Any</span><span class="o">)</span><span class="k">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cond</code>, <code class="language-plaintext highlighter-rouge">thenp</code> and <code class="language-plaintext highlighter-rouge">elsep</code> are all matched parts from the input tree.</p>

<p><code class="language-plaintext highlighter-rouge">q"$cond"</code> generates a new tree using the matched condition part of the tree. We will see more details in how to use quasiquotes to generate trees in section 5.4.</p>

<p>Test it with this code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">bigNum</span> <span class="k">=</span> <span class="mi">2</span>
<span class="k">val</span> <span class="nv">smallNum</span> <span class="k">=</span> <span class="mi">1</span>
<span class="k">val</span> <span class="nv">result</span> <span class="k">=</span> <span class="n">macroTest</span> <span class="o">{</span>
  <span class="nf">if</span> <span class="o">(</span><span class="n">bigNum</span> <span class="o">&gt;</span> <span class="n">smallNum</span><span class="o">)</span> <span class="o">{</span>
    <span class="s">"no surprise"</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="s">"surprise!"</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="nf">println</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</code></pre></div></div>

<p>During the compile time, it will print out the different parts of the tree that we have asked it to match:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bigNum.&gt;(smallNum)
"no surprise"
"surprise!"
</code></pre></div></div>

<p>And during the run time, it will print out the value of condition instead of either if or else clause:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>true
</code></pre></div></div>

<p>More examples about how to match the tree can be found in <a href="https://docs.scala-lang.org/overviews/quasiquotes/syntax-summary.html">the document</a>. Click on each example to see more details.</p>

<h2 id="5-how-to-generate-tree">5. How to Generate Tree</h2>

<h3 id="51-construct-tree-directly-with-api">5.1 Construct Tree Directly with API</h3>

<p>An AST can be constructed from the classes that represent the tree. For example, a constant of string can be created by <code class="language-plaintext highlighter-rouge">Literal(Constant("I replaced you!"))</code>. The following example replace any string to <code class="language-plaintext highlighter-rouge">I replaced you</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">c.universe._</span>
  <span class="nv">c</span><span class="o">.</span><span class="py">Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">Literal</span><span class="o">(</span><span class="nc">Constant</span><span class="o">(</span><span class="s">"I replaced you!"</span><span class="o">)))</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>
</code></pre></div></div>

<p>With the code below, it will print <code class="language-plaintext highlighter-rouge">I replaced you!</code> instead of <code class="language-plaintext highlighter-rouge">abc</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">println</span><span class="o">(</span><span class="nf">macroTest</span><span class="o">(</span><span class="s">"abc"</span><span class="o">))</span>
</code></pre></div></div>

<p>This is a very simple example. When the tree becomes larger and larger , it’s more and more difficult to construct a tree with this approach. It’s like a much worse version of lisp. So in the following sections, we will see some easier ways to construct a tree.</p>

<h3 id="52-use-cparse">5.2 Use <code class="language-plaintext highlighter-rouge">c.parse</code>:</h3>

<p><code class="language-plaintext highlighter-rouge">c.parse</code> can parse a string as Scala code and generate an AST. For example, the following macro returns the variable name of a <code class="language-plaintext highlighter-rouge">String</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">name</span> <span class="k">=</span> <span class="nv">s</span><span class="o">.</span><span class="py">tree</span><span class="o">.</span><span class="py">symbol</span><span class="o">.</span><span class="py">fullName</span>
  <span class="nv">c</span><span class="o">.</span><span class="py">Expr</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">parse</span><span class="o">(</span><span class="n">s</span><span class="s">""" "Name of var is: $name" """</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>
</code></pre></div></div>

<p>Then use it like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="s">"abc"</span>
<span class="nf">println</span><span class="o">(</span><span class="nf">macroTest</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
</code></pre></div></div>

<p>It will print out:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name of var is: me.binwang.archmage.coretest.MethodMetaTest.a
</code></pre></div></div>

<p>Note the output is at run time instead of compile time like the examples in the last section, because we’ve replaced the tree with new code.</p>

<h3 id="53-use-reify">5.3 Use <code class="language-plaintext highlighter-rouge">reify</code></h3>

<p><code class="language-plaintext highlighter-rouge">c.parse</code> is easy to use and understand. But when generating more and more code with it, it can be pretty messy since it is just a string. There is no syntax checks in IDE. Even worse, you cannot get any run time information to use in the generated tree.</p>

<p><code class="language-plaintext highlighter-rouge">reify</code> is a much better option. You can write code as usual. The code in <code class="language-plaintext highlighter-rouge">reify</code> block is the code that will be generated. You can refer to another <code class="language-plaintext highlighter-rouge">Expr</code> (in the old tree) by using its <code class="language-plaintext highlighter-rouge">.splice</code> method. Here is an example to print out both the variable name and it’s value:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">c.universe._</span>
  <span class="k">val</span> <span class="nv">name</span> <span class="k">=</span> <span class="nv">c</span><span class="o">.</span><span class="py">Expr</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">parse</span><span class="o">(</span><span class="s">"\""</span> <span class="o">+</span> <span class="nv">s</span><span class="o">.</span><span class="py">tree</span><span class="o">.</span><span class="py">symbol</span><span class="o">.</span><span class="py">fullName</span> <span class="o">+</span> <span class="s">"\""</span><span class="o">))</span>
  <span class="n">reify</span> <span class="o">{</span>
    <span class="n">s</span><span class="s">"${name.splice}: ${s.splice}"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">macroTest</code> and the test code is the same above. Running the test code will get output like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>me.binwang.archmage.coretest.MethodMetaTest.a: abc
</code></pre></div></div>

<h3 id="54-use-quasiquotes">5.4 Use Quasiquotes</h3>

<p>As we’ve seen in section 4.5, <code class="language-plaintext highlighter-rouge">q"..."</code> can be used to match a tree. It can be used to generate a tree as well. For example, in the following code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">s</span><span class="k">:</span> <span class="kt">c.Tree</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">c.universe._</span>
  <span class="k">val</span> <span class="nv">q</span><span class="s">"if ($cond) $thenp else $elsep"</span> <span class="k">=</span> <span class="n">s</span>
  <span class="n">q</span><span class="s">"if ($cond) $elsep else $thenp"</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">s</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>
</code></pre></div></div>

<p>It uses the parts that have been matched by <code class="language-plaintext highlighter-rouge">q"..."</code> and generates a new tree using those parts. It swaps the if and else clause. Run it with this test code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">macroTest</span><span class="o">(</span><span class="nf">if</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="nf">println</span><span class="o">(</span><span class="s">"a"</span><span class="o">)</span> <span class="k">else</span> <span class="nf">println</span><span class="o">(</span><span class="s">"b"</span><span class="o">))</span>
</code></pre></div></div>

<p>It will print <code class="language-plaintext highlighter-rouge">b</code> instead of <code class="language-plaintext highlighter-rouge">a</code>.</p>

<h3 id="55-avoid-name-conflict">5.5 Avoid Name Conflict</h3>

<p>When generating a new tree, we may generate some variables that have conflict names with the existing ones. Use <code class="language-plaintext highlighter-rouge">c.freshName</code> to get a unique name to avoid the conflict.</p>

<h3 id="56-type-checked-and-unchecked-tree">5.6 Type Checked and Unchecked Tree</h3>

<p>There are two kinds of AST in Scala’s internal compiler: type checked and unchecked. See more details in <a href="https://stackoverflow.com/questions/20936509/scala-macros-what-is-the-difference-between-typed-aka-typechecked-and-untyped">this Stack Overflow answer</a>. Some APIs can only accept either type checked or unchecked tree. And sometimes the compiler throws out weird errors if using the wrong type of tree. If that’s the case, try to use <code class="language-plaintext highlighter-rouge">c.untypecheck</code> and <code class="language-plaintext highlighter-rouge">c.typecheck</code> to covert trees.</p>

<p>For example, here is some code that cannot be compiled:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">blockTree</span><span class="k">:</span> <span class="kt">c.Tree</span><span class="o">)</span> <span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">c.universe._</span>
  <span class="k">val</span> <span class="nv">block</span> <span class="k">=</span> <span class="nv">c</span><span class="o">.</span><span class="py">Expr</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="n">blockTree</span><span class="o">)</span>
  <span class="n">reify</span> <span class="o">{</span>
    <span class="nc">Seq</span><span class="o">(</span><span class="s">"a"</span><span class="o">).</span><span class="py">flatMap</span><span class="o">{</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">block</span><span class="o">.</span><span class="py">splice</span><span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">macroTest</span><span class="o">(</span><span class="n">blockTree</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">macro</span> <span class="n">macroImpl</span>

<span class="c1">// Testing code in another sub project:</span>
<span class="k">val</span> <span class="nv">s</span> <span class="k">=</span> <span class="s">"abc"</span>
<span class="n">macroTest</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="n">s</span>
  <span class="nc">Seq</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The compiler will throw error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[error] Error while emitting XXX.scala
[error] value a
[error] one error found
</code></pre></div></div>

<p>To fix this, we need to convert <code class="language-plaintext highlighter-rouge">blockTree</code> to unchecked tree:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">macroImpl</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">blackbox.Context</span><span class="o">)(</span><span class="n">blockTree</span><span class="k">:</span> <span class="kt">c.Tree</span><span class="o">)</span> <span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">c.universe._</span>
  <span class="k">val</span> <span class="nv">cleanedBlock</span> <span class="k">=</span> <span class="nv">c</span><span class="o">.</span><span class="py">untypecheck</span><span class="o">(</span><span class="nv">blockTree</span><span class="o">.</span><span class="py">duplicate</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">block</span> <span class="k">=</span> <span class="nv">c</span><span class="o">.</span><span class="py">Expr</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="n">cleanedBlock</span><span class="o">)</span>
  <span class="n">reify</span> <span class="o">{</span>
    <span class="nc">Seq</span><span class="o">(</span><span class="s">"a"</span><span class="o">).</span><span class="py">flatMap</span><span class="o">{</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">block</span><span class="o">.</span><span class="py">splice</span><span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

</article>

<footer id="post_footer">
  <table><tr>
    
      <td id="prev"><a href="/2023-12-14-ZFS-Profiling-on-Arch-Linux.html">Prev: ZFS Profiling on Arch Linux</a></td>
    
    
  </tr></table>
</footer>

<!--
<section id="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'crazy-hot-ice'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
-->



<!-- MathJax -->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

</div>

    </section>

    <footer id="page_footer">
      Copyright @ 2008 - 2024 Bin Wang
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
    </footer>
    </div>
  </body>
</html>
